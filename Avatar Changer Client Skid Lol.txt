if not game:IsLoaded() then
    game.Loaded:Wait()
end

local env = getgenv and getgenv() or _G
local SCRIPT_FLAG = '_AVATAR_CHANGER_LOADED_'

local SGUI = game:GetService("StarterGui")

if env[SCRIPT_FLAG] then
    return
end

cloneref = cloneref or function(...) return ... end

local service = setmetatable({}, {
    __index = function(self, name)
        rawset(self, name, cloneref(game:GetService(name)))
        return rawget(self, name)
    end
})

local Players = service.Players
local TweenService = service.TweenService
local HttpService = service.HttpService
local UserInputService = service.UserInputService
local RunService = service.RunService

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild('PlayerGui')

local IS_MOBILE = UserInputService.TouchEnabled and not UserInputService.MouseEnabled

local Icons = {
    eye = 'rbxassetid://10723346959',
    minus = 'rbxassetid://10734896206',
    plus = 'rbxassetid://10734924532',
    search = 'rbxassetid://10734943674',
    play = 'rbxassetid://10734923549',
    dice = 'rbxassetid://10723343321',
    rotate = 'rbxassetid://10734940376',
    chevron_left = 'rbxassetid://10709791281',
    chevron_right = 'rbxassetid://10709791437',
    check = 'rbxassetid://10709790644',
    x = 'rbxassetid://10747384394',
    warning = 'rbxassetid://10709753149',
    info = 'rbxassetid://10723415903',
    heart = 'rbxassetid://10723406885',
    heart_off = 'rbxassetid://10723406662',
    home = 'rbxassetid://10723407389',
    users = 'rbxassetid://10747373426',
    user = 'rbxassetid://10747373176',
    settings = 'rbxassetid://10734950309',
    bookmark = 'rbxassetid://10709782154',
    refresh = 'rbxassetid://10734933222',
    stats = 'rbxassetid://10747372167',
    palette = 'rbxassetid://10734963400'
}

local Sounds = {
    ui_toggle = 'rbxassetid://124972635680154',
    reset = 'rbxassetid://123698506133442',
    dice = 'rbxassetid://500839268',
    tab_switch = 'rbxassetid://9065073444',
    button_click = 'rbxassetid://12948391899',
    favorite = 'rbxassetid://74914703480819',
    unfavorite = 'rbxassetid://92708987611847'
}

local State = {
    applying = false,
    auto = false,
    undo_history = {},
    redo_history = {},
    max_history = 10,
    applied_id = nil,
    minimized = false,
    visible = true,
    preview_open = false,
    client_preview_open = false,
    cache = {},
    randoms = {},
    conns = {},
    original_desc = nil,
    input_ready = false,
    random_cooldown = false,
    fab_toggle_cooldown = false,
    visibility_animating = false,
    favorites = {},
    favorites_index = {},
    current_tab = 'main',
    fav_name_cache = {},
    width_scale = 1,
    width_enabled = false,
    client_applying = false,
    player_original_descs = {},
    fav_search_text = '',
    fav_ui_initialized = false,
    zoom_level = 5.5,
    client_zoom_level = 5.5,
    avatar_details = {},
    height_scale = 1,
    height_enabled = false,
    depth_scale = 1,
    depth_enabled = false,
    head_scale = 1,
    head_enabled = false,
    music_playing = false,
    music_index = 1,
    music_sound = nil,
    music_loop = false,
    music_volume = 1.0,
    music_dynamic_volume = false,
    bass_boost_enabled = false,
    sound_effects_enabled = true,
    apply_counts = {},
    stats_apply_cooldown = false,
    rgb_mode = false,
    rgb_hue = 0,
    rgb_mode_type = 'cycle',
    rgb_saturation = 1,
    rgb_brightness = 1,
    rgb_speed = 1,
    rgb_time = 0,
    rgb_element_delays = {},
    rgb_intro_playing = false,
    minimize_cooldown = false,
    current_theme = 'purple',
    esp_enabled = false,
    esp_teamcheck = false,
    esp_highlights = true,
    esp_show_only_highlights = false,
    esp_show_teamname = true,
    esp_update_rate = 0.01,
    esp_last_update = 0,
    esp_priority_update_rate = 0.005,
    esp_low_priority_update_rate = 0.016,
    toggle_keybind = Enum.KeyCode.LeftControl,
    last_apply_time = 0,
    apply_cooldown = 0.25,
    notifications_enabled = true,
    music_loaded = false,
    presets_loaded = false
}

local SoundManager = {}
SoundManager.pool = {}
SoundManager.pool_size = 10
SoundManager.active_sounds = {}
SoundManager.last_play_time = {}

function SoundManager.init()
    for i = 1, SoundManager.pool_size do
        local sound = Instance.new('Sound')
        sound.Volume = 0.3
        sound.Parent = PlayerGui
        table.insert(SoundManager.pool, sound)
    end
end

function SoundManager.get_sound()
    for i, sound in ipairs(SoundManager.pool) do
        if not sound.IsPlaying then
            return sound
        end
    end
    
    local sound = Instance.new('Sound')
    sound.Volume = 0.3
    sound.Parent = PlayerGui
    table.insert(SoundManager.pool, sound)
    return sound
end

function SoundManager.play(sound_id, volume)
    if not State.sound_effects_enabled then return end
    
    local current_time = tick()
    local last_time = SoundManager.last_play_time[sound_id] or 0
    
    SoundManager.last_play_time[sound_id] = current_time
    
    local sound = SoundManager.get_sound()
    sound.SoundId = sound_id
    sound.Volume = volume or 0.3
    
    sound:Play()
    
    SoundManager.active_sounds[sound] = true
    
    local connection
    connection = sound.Ended:Connect(function()
    SoundManager.active_sounds[sound] = nil
    connection:Disconnect()
    end)
    
    return sound
end

function SoundManager.play_click()
    return SoundManager.play(Sounds.button_click, 0.35)
end

function SoundManager.play_toggle()
    return SoundManager.play(Sounds.ui_toggle, 0.2)
end

function SoundManager.play_tab_switch()
    return SoundManager.play(Sounds.tab_switch, 0.5)
end

function SoundManager.play_favorite()
    return SoundManager.play(Sounds.favorite, 0.2)
end

function SoundManager.play_unfavorite()
    return SoundManager.play(Sounds.unfavorite, 0.15)
end

function SoundManager.play_dice()
    return SoundManager.play(Sounds.dice, 0.2)
end

function SoundManager.play_reset()
    return SoundManager.play(Sounds.reset, 0.2)
end

function SoundManager.cleanup()
    for _, sound in ipairs(SoundManager.pool) do
        sound:Stop()
        sound:Destroy()
    end
    SoundManager.pool = {}
    SoundManager.active_sounds = {}
end

SoundManager.init()

local Maid = {}
Maid.__index = Maid

function Maid.new()
    return setmetatable({
        _tasks = {}
    }, Maid)
end

function Maid:Add(task, cleanup_method)
    if not task then return end
    
    table.insert(self._tasks, {
        task = task,
        method = cleanup_method
    })
    
    return task
end

function Maid:AddConnection(connection)
    return self:Add(connection, 'Disconnect')
end

function Maid:AddInstance(instance)
    return self:Add(instance, 'Destroy')
end

function Maid:Cleanup()
    for _, task_data in ipairs(self._tasks) do
        local task = task_data.task
        local method = task_data.method
        
        if task then
            if method and type(task[method]) == 'function' then
                pcall(function()
                    task[method](task)
                end)
            elseif type(task) == 'function' then
                pcall(task)
            end
        end
    end
    
    self._tasks = {}
end

function Maid:Destroy()
    self:Cleanup()
end

local Music = {
    {name = 'Merry Christmas', id = 'rbxassetid://1838667168'},
    {name = 'TacoBot-3000', id = 'rbxassetid://9245552700'},
    {name = 'Montagem Blue Shirt', id = 'rbxassetid://122203857226173'},
    {name = 'CHAOS', id = 'rbxassetid://1843497734'},
    {name = 'SAVAGE GHOST SLOWED', id = 'rbxassetid://72811197789142'},
    {name = 'MONTAGEM AURA', id = 'rbxassetid://117759015860393'},
    {name = 'GOOD GIRL FUNK', id = 'rbxassetid://123723674864058'},
    {name = 'FUNK FESTA', id = 'rbxassetid://103409297553965'},
    {name = 'I Still Think of You', id = 'rbxassetid://86766967120839'},
    {name = 'Shattered Reflections', id = 'rbxassetid://127812909272456'},
    {name = 'Kakusei Erwachen', id = 'rbxassetid://124853612881772'},
    {name = 'Turkish Art', id = 'rbxassetid://1842150151'},
    {name = 'Scary Beats For You', id = 'rbxassetid://88456225545062'},
    {name = 'The Lonely Guy', id = 'rbxassetid://114213622974713'},
    {name = 'TOMA FUNK PHONK', id = 'rbxassetid://129098116998483'},
    {name = 'Raining Tacos', id = 'rbxassetid://142376088'},
    {name = 'Happy Song', id = 'rbxassetid://1843404009'},
    {name = 'The Cult', id = 'rbxassetid://98183757946208'},
    {name = 'Windows To The Sun', id = 'rbxassetid://119384335997294'},
   {name = 'Heavenly Song', id = 'rbxassetid://9125603749'},
    {name = 'SIGMA BOY', id = 'rbxassetid://109420952262721'},
    {name = 'Evangelion Sword Outro', id = 'rbxassetid://102468604705752'},
    {name = 'Christmas Anime Opening', id = 'rbxassetid://112881604345924'},
    {name = 'Kieta Hoshi', id = 'rbxassetid://88704298134223'},
    {name = 'Rise to the Horizon', id = 'rbxassetid://72573266268313'},
    {name = 'Fading Memories', id = 'rbxassetid://87065827699369'},
    {name = 'Backrooms', id = 'rbxassetid://120817494107898'},
    {name = 'Kimi no Kodou', id = 'rbxassetid://127296569646417'},
    {name = 'Moeru Kodou', id = 'rbxassetid://138614247392811'},
    {name = 'Kienai Koe', id = 'rbxassetid://90588286632687'},
    {name = 'Saigo no Yakusoku', id = 'rbxassetid://87102415343081'},
    {name = 'Menta Ma', id = 'rbxassetid://98337901681441'},
    {name = 'Megavalanio Remix', id = 'rbxassetid://101598365847186'},
    {name = 'Tsuko G - Deja Vu', id = 'rbxassetid://16831106636'},
    {name = 'Jumpstyle', id = 'rbxassetid://1839246711'},
    {name = 'Total Confusion', id = 'rbxassetid://103419239604004'},
    {name = 'Run Away', id = 'rbxassetid://128118999630439'},
    {name = 'I Have No Enemies', id = 'rbxassetid://109550779401749'},
    {name = 'Hold On (Speed Up)', id = 'rbxassetid://71045969776776'},
    {name = 'United No Borders', id = 'rbxassetid://134841562378374'},
    {name = 'Dear Lana', id = 'rbxassetid://119589412825080'},
    {name = 'Woo Woo Woo Woo', id = 'rbxassetid://77139878722989'},
    {name = 'Fur Elise', id = 'rbxassetid://1836283178'},
    {name = 'Clair De Lune', id = 'rbxassetid://1838457617'},
    {name = 'Beauty PHONK', id = 'rbxassetid://115249562236391'},
    {name = 'Slava Bass Boosted', id = 'rbxassetid://117237954599243'},
    {name = 'BRAZIL FUNK', id = 'rbxassetid://133498554139200'},
    {name = 'CREPPY FUNK', id = 'rbxassetid://110170687361544'},
    {name = 'ORAY BEY FUNK', id = 'rbxassetid://135286582331883'},
    {name = 'Marginal Phonk', id = 'rbxassetid://95177104398382'},
    {name = 'Recognized', id = 'rbxassetid://86255275876700'},
    {name = 'Montagem', id = 'rbxassetid://88913864169288'},
    {name = 'Nocturne', id = 'rbxassetid://129108903964685'},
    {name = 'Hide & Seek', id = 'rbxassetid://131571387429103'},
    {name = 'キラメキ∞ループ', id = 'rbxassetid://108849060438649'},
    {name = 'Banana Bashin', id = 'rbxassetid://118231802185865'}
}

local Themes = {
    purple = {
        accent = Color3.fromRGB(99, 102, 241),
        accent_glow = Color3.fromRGB(129, 132, 255)
    },
    blue = {
        accent = Color3.fromRGB(59, 130, 246),
        accent_glow = Color3.fromRGB(96, 165, 250)
    },
    red = {
        accent = Color3.fromRGB(239, 68, 68),
        accent_glow = Color3.fromRGB(248, 113, 113)
    },
    green = {
        accent = Color3.fromRGB(34, 197, 94),
        accent_glow = Color3.fromRGB(74, 222, 128)
    },
    pink = {
        accent = Color3.fromRGB(236, 72, 153),
        accent_glow = Color3.fromRGB(244, 114, 182)
    },
    cyan = {
        accent = Color3.fromRGB(6, 182, 212),
        accent_glow = Color3.fromRGB(34, 211, 238)
    }
}

local C = {
    base = Color3.fromRGB(12, 12, 16),
    panel = Color3.fromRGB(18, 18, 24),
    card = Color3.fromRGB(26, 26, 34),
    elevated = Color3.fromRGB(36, 36, 46),
    hover = Color3.fromRGB(46, 46, 58),
    border = Color3.fromRGB(55, 55, 70),
    text = Color3.fromRGB(255, 255, 255),
    subtext = Color3.fromRGB(180, 180, 195),
    muted = Color3.fromRGB(100, 100, 120),
    accent = Color3.fromRGB(99, 102, 241),
    accent_glow = Color3.fromRGB(129, 132, 255),
    success = Color3.fromRGB(34, 197, 94),
    error = Color3.fromRGB(239, 68, 68),
    warning = Color3.fromRGB(245, 158, 11),
    star = Color3.fromRGB(255, 200, 50)
}

local function apply_theme(theme_name)
    local theme = Themes[theme_name]
    if theme then
        C.accent = theme.accent
        C.accent_glow = theme.accent_glow
    end
end

local TRANSPARENCY = 0.22

local Presets = {
   289438135, 1707711223, 188732, 2298753899, 9119588309, 5254879171, 8595350470, 6007609888, 124751865, 5019714978, 5007631110, 9088628683, 7223875998, 2474943274, 3104949425, 3335871296, 203030608, 2596305840, 201124389, 1981724228, 3731169417, 205419201, 7422492329, 406436524, 1803380, 9406742928, 1359861204, 3012958642, 2260118449, 188829949, 2261820401, 8094705681, 9894023718, 6077615334, 2281971469, 1946404863, 660132420, 1125262365, 3018607207, 144018186, 3577671250, 2017401176, 3473976672, 9122248242, 1667867130, 9294642379, 5366504429, 8264800124, 283156132, 1630540916, 4416918097, 344091683, 6538096, 7623744992, 1099702304, 1199088309, 1369842558, 3624257547, 145740081, 215710487, 2255861564, 7330109199, 524749295, 272574783, 4100936320, 4863227235, 1132340350, 5210946332, 3331434198, 2618555079, 4201687597, 147198435, 704071723, 465771760, 254829155, 8069027498, 2646550793, 366768658, 2885260147
}

local ContentLoader = {}
ContentLoader.loaded_music = {}
ContentLoader.loaded_presets = {}

function ContentLoader.load_music_progressive(callback, progress_callback)
    if State.music_loaded then 
        if callback then callback() end
        return 
    end
    
    local batch_size = 5
    local delay_between_batches = 0.2
    
    task.spawn(function()
        for i = 1, #Music, batch_size do
            local batch_end = math.min(i + batch_size - 1, #Music)
            
            for j = i, batch_end do
                table.insert(ContentLoader.loaded_music, Music[j])
            end
            
            if progress_callback then
                local progress = math.floor((#ContentLoader.loaded_music / #Music) * 100)
                progress_callback(progress)
            end
            
            if i + batch_size <= #Music then
                task.wait(delay_between_batches)
            end
        end
        
        State.music_loaded = true
        if callback then callback() end
    end)
end

function ContentLoader.load_presets_progressive(callback, progress_callback)
    if State.presets_loaded then 
        if callback then callback() end
        return 
    end
    
    local batch_size = 10
    local delay_between_batches = 0.15
    
    task.spawn(function()
        for i = 1, #Presets, batch_size do
            local batch_end = math.min(i + batch_size - 1, #Presets)
            
            for j = i, batch_end do
                table.insert(ContentLoader.loaded_presets, Presets[j])
            end
            
            if progress_callback then
                local progress = math.floor((#ContentLoader.loaded_presets / #Presets) * 100)
                progress_callback(progress)
            end
            
            if i + batch_size <= #Presets then
                task.wait(delay_between_batches)
            end
        end
        
        State.presets_loaded = true
        if callback then callback() end
    end)
end

function ContentLoader.get_music()
    return State.music_loaded and Music or ContentLoader.loaded_music
end

function ContentLoader.get_presets()
    return State.presets_loaded and Presets or ContentLoader.loaded_presets
end

local StateProtection = {}
StateProtection.__index = StateProtection

function StateProtection.new(state_table)
    local self = setmetatable({}, StateProtection)
    self._state = state_table
    self._locked_keys = {
        favorites = true,
        favorites_index = true,
        cache = true,
        conns = true
    }
    return self
end

function StateProtection:is_locked(key)
    return self._locked_keys[key] == true
end

function StateProtection:get(key)
    return self._state[key]
end

function StateProtection:set(key, value)
    if self:is_locked(key) then
        warn('[StateProtection] Attempted To Modify Protected Key:', key)
        return false
    end
    self._state[key] = value
    return true
end

function StateProtection:add_favorite(user_id)
    if not user_id then return false end
    if not self._state.favorites_index[user_id] then
        local fav_data = {id = user_id, name = tostring(user_id), time = os.time()}
        table.insert(self._state.favorites, fav_data)
        self._state.favorites_index[user_id] = true
        return true
    end
    return false
end

function StateProtection:remove_favorite(user_id)
    if not self._state.favorites_index[user_id] then
        return false
    end
    
    for i, fav in ipairs(self._state.favorites) do
        if fav.id == user_id then
            table.remove(self._state.favorites, i)
            self._state.favorites_index[user_id] = nil
            return true
        end
    end
    return false
end

function StateProtection:is_favorite(user_id)
    return self._state.favorites_index[user_id] == true
end

function StateProtection:get_favorites()
    local copy = {}
    for i, v in ipairs(self._state.favorites) do
        copy[i] = v
    end
    return copy
end

local function get_char_and_hum(player_or_char)
    local char = player_or_char
    if typeof(player_or_char) == "Instance" and player_or_char:IsA("Player") then
        char = player_or_char.Character
    end
    
    if not char or not char:FindFirstChild('HumanoidRootPart') then
        return nil, nil
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    return char, hum
end

local function apply_description(humanoid, description)
    pcall(function()
        if humanoid.ApplyDescriptionClientServer then
            humanoid:ApplyDescriptionClientServer(description)
        else
            humanoid:ApplyDescription(description)
        end
    end)
end

local function is_click_input(input)
    return input.UserInputType == Enum.UserInputType.MouseButton1 or 
           input.UserInputType == Enum.UserInputType.Touch
end

local function find_player_by_name(playerName)
    local lowerName = playerName:lower()
    for _, p in ipairs(Players:GetPlayers()) do
        if p.Name:lower() == lowerName or p.DisplayName:lower() == lowerName then
            return p
        end
    end
    return nil
end

local function collect_tools(char)
    local tools = {}
    
    for _, c in ipairs(char:GetChildren()) do
        if c:IsA('Tool') then
            table.insert(tools, c)
        end
    end
    
    local backpack = char.Parent and char.Parent:FindFirstChild('Backpack')
    if backpack then
        for _, t in ipairs(backpack:GetChildren()) do
            if t:IsA('Tool') then
                table.insert(tools, t)
            end
        end
    end
    
    return tools, backpack
end

local function restore_tools(tools, backpack, char)
    for _, t in ipairs(tools) do
        if t and t.Parent == nil then
            if backpack then
                t.Parent = backpack
            else
                t.Parent = char
            end
        end
    end
end

local function client_apply_guard(operation_func)
    if State.client_applying then
        return
    end
    State.client_applying = true
    
    task.spawn(function()
        operation_func()
        State.client_applying = false
    end)
end

local function apply_history_state(history, target_history, is_undo)
    if #history == 0 then
        Notify.show(is_undo and 'Nothing To Undo' or 'Nothing To Redo', 'warning')
        return
    end
    
    if State.applying then
        return
    end
    
    local target_id = table.remove(history)
    
    if State.applied_id then
        table.insert(target_history, State.applied_id)
        if #target_history > State.max_history then
            table.remove(target_history, 1)
        end
    end
    
    Av.apply(target_id, nil, true, true)
    
    if E.update_undo_redo_ui then
        E.update_undo_redo_ui()
    end
    
    if E.input then
        E.input.Text = tostring(target_id)
    end
    
    save_data()
    play_sound(Sounds.reset, 0.1)
end

local Janitor = {}
Janitor.__index = Janitor

function Janitor.new()
    local self = setmetatable({}, Janitor)
    self._objects = {}
    return self
end

function Janitor:Add(object, cleanup_method)
    if not object then return end
    
    local index = #self._objects + 1
    self._objects[index] = {
        object = object,
        method = cleanup_method or (typeof(object) == 'RBXScriptConnection' and 'Disconnect' or 'Destroy')
    }
    
    return object
end

function Janitor:AddMultiple(objects, cleanup_method)
    for _, obj in ipairs(objects) do
        self:Add(obj, cleanup_method)
    end
end

function Janitor:LinkToJanitor(other_janitor)
    return self:Add(other_janitor, 'Cleanup')
end

function Janitor:Remove(object)
    for i, data in ipairs(self._objects) do
        if data.object == object then
            self:_cleanup_object(data)
            table.remove(self._objects, i)
            return true
        end
    end
    return false
end

function Janitor:_cleanup_object(data)
    if not data or not data.object then return end
    
    local success, err = pcall(function()
        if type(data.object[data.method]) == 'function' then
            data.object[data.method](data.object)
        end
    end)
    
    if not success and err then
        warn('[Janitor] Cleanup Error:', err)
    end
end

function Janitor:Cleanup()
    for i = #self._objects, 1, -1 do
        self:_cleanup_object(self._objects[i])
        self._objects[i] = nil
    end
end

function Janitor:Destroy()
    self:Cleanup()
end

function Janitor:GetCount()
    return #self._objects
end

local ScriptJanitor = Janitor.new()

local ESPSystem = {}
ESPSystem.Enabled = false
ESPSystem.TeamCheck = false
ESPSystem.ESPs = {}
ESPSystem.Config = {
    Chams = {
        Enabled = true,
        FillColor = Color3.fromRGB(255, 0, 0),
        FillTransparency = 0.5,
        OutlineColor = Color3.fromRGB(255, 255, 255),
        OutlineTransparency = 0
    }
}

ESPSystem.WeaponBlacklist = {
    ["Lunch"] = true,
    ["Lunchbox"] = true,
    ["Lunch Box"] = true,
    ["Combat"] = true,
    ["Assist"] = true,
    ["Camera"] = true,
    ["Binoculars"] = true,
    ["Flashlight"] = true,
    ["Phone"] = true,
    ["Radio"] = true,
    ["Tablet"] = true,
    ["Map"] = true,
    ["Compass"] = true,
    ["Watch"] = true,
    ["Medkit"] = true,
    ["Bandage"] = true,
    ["Pills"] = true,
    ["Syringe"] = true,
    ["Food"] = true,
    ["Drink"] = true,
    ["Water"] = true,
    ["Soda"] = true,
    ["Energy Drink"] = true,
    ["Snack"] = true,
    ["Candy"] = true,
    ["Chips"] = true,
    ["Burger"] = true,
    ["Pizza"] = true,
    ["Sandwich"] = true,
    ["Apple"] = true,
    ["Banana"] = true,
    ["Orange"] = true,
    ["Bread"] = true,
    ["Key"] = true,
    ["Keycard"] = true,
    ["ID Card"] = true,
    ["Badge"] = true,
    ["Pass"] = true,
    ["Ticket"] = true,
    ["Document"] = true,
    ["Folder"] = true,
    ["Notepad"] = true,
    ["Notebook"] = true,
    ["Book"] = true,
    ["Screwdriver"] = true,
    ["Toolbox"] = true,
    ["Pickaxe"] = true,
    ["Hammer"] = true,
    ["Dinner"] = true,
    ["Shovel"] = true,
    ["Hatchet"] = true,
    ["Paint"] = true,
    ["Spray"] = true,
    ["Rope"] = true,
    ["Net"] = true,
    ["Trap"] = true,
    ["Lockpick"] = true,
    ["Handcuffs"] = true,
    ["Zipties"] = true,
    ["Stun Gun"] = true,
    ["Pepper Spray"] = true,
    ["Baton"] = true,
    ["Crude Knife"] = true,
    ["Glowstick"] = true,
    ["VIP"] = true,
    ["Popcorn"] = true,
    ["Nightstick"] = true
}

local function is_weapon_blacklisted(weapon_name)
    if not weapon_name then return true end
    
    local lower_name = weapon_name:lower()
    
    for blacklisted, _ in pairs(ESPSystem.WeaponBlacklist) do
        if lower_name:find(blacklisted:lower()) then
            return true
        end
    end
    
    return false
end

local function create_esp_for_player(player)
    if player == LocalPlayer then return end
    
    local esp_data = {
        Player = player,
        Highlight = nil,
        Drawings = {},
        Connections = {}
    }
    
    local function create_drawings()
        esp_data.Drawings = {
            Box = Drawing.new("Square"),
            NameText = Drawing.new("Text"),
            DistanceText = Drawing.new("Text"),
            TeamText = Drawing.new("Text"),
            HealthText = Drawing.new("Text"),
            WeaponText = Drawing.new("Text"),
            HealthBar = Drawing.new("Line"),
            HealthBarOutline = Drawing.new("Line")
        }
        
        esp_data.Drawings.Box.Color = Color3.fromRGB(255, 255, 255)
        esp_data.Drawings.Box.Thickness = 1.5
        esp_data.Drawings.Box.Filled = false
        esp_data.Drawings.Box.Visible = false
        esp_data.Drawings.Box.ZIndex = 2
        
        esp_data.Drawings.NameText.Color = Color3.fromRGB(255, 255, 255)
        esp_data.Drawings.NameText.Size = 11.5
        esp_data.Drawings.NameText.Center = false
        esp_data.Drawings.NameText.Outline = true
        esp_data.Drawings.NameText.Visible = false
        esp_data.Drawings.NameText.Text = player.Name
        esp_data.Drawings.NameText.ZIndex = 3
        
        esp_data.Drawings.DistanceText.Color = Color3.fromRGB(150, 150, 150)
        esp_data.Drawings.DistanceText.Size = 10
        esp_data.Drawings.DistanceText.Center = false
        esp_data.Drawings.DistanceText.Outline = true
        esp_data.Drawings.DistanceText.Visible = false
        esp_data.Drawings.DistanceText.Text = ""
        esp_data.Drawings.DistanceText.ZIndex = 3
        
        esp_data.Drawings.TeamText.Color = Color3.fromRGB(0, 255, 255)
        esp_data.Drawings.TeamText.Size = 12
        esp_data.Drawings.TeamText.Center = true
        esp_data.Drawings.TeamText.Outline = true
        esp_data.Drawings.TeamText.Visible = false
        esp_data.Drawings.TeamText.ZIndex = 3
        
        esp_data.Drawings.HealthText.Color = Color3.fromRGB(255, 255, 255)
        esp_data.Drawings.HealthText.Size = 11
        esp_data.Drawings.HealthText.Center = false
        esp_data.Drawings.HealthText.Outline = true
        esp_data.Drawings.HealthText.Visible = false
        esp_data.Drawings.HealthText.Text = ""
        esp_data.Drawings.HealthText.ZIndex = 3
        
        esp_data.Drawings.WeaponText.Color = Color3.fromRGB(255, 255, 255)
        esp_data.Drawings.WeaponText.Size = 12
        esp_data.Drawings.WeaponText.Center = true
        esp_data.Drawings.WeaponText.Outline = true
        esp_data.Drawings.WeaponText.Visible = false
        esp_data.Drawings.WeaponText.Text = ""
        esp_data.Drawings.WeaponText.ZIndex = 3
        
        esp_data.Drawings.HealthBar.Color = Color3.fromRGB(0, 255, 0)
        esp_data.Drawings.HealthBar.Thickness = 25
        esp_data.Drawings.HealthBar.Visible = false
        esp_data.Drawings.HealthBar.ZIndex = 2
        
        esp_data.Drawings.HealthBarOutline.Color = Color3.fromRGB(0, 0, 0)
        esp_data.Drawings.HealthBarOutline.Thickness = 35
        esp_data.Drawings.HealthBarOutline.Visible = false
        esp_data.Drawings.HealthBarOutline.ZIndex = 1
    end
    
    local function update_esp()
        if not player.Character then
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
            return
        end
        
        local character = player.Character
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local root = character:FindFirstChild("HumanoidRootPart")
        
        if not humanoid or not root or humanoid.Health <= 0 then
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
            if esp_data.Highlight then
                esp_data.Highlight.Enabled = false
            end
            return
        end
        
        if not esp_data.Highlight and State.esp_highlights then
            local highlight = Instance.new("Highlight")
            highlight.Name = "ESP_Highlight"
            highlight.Adornee = character
            
            local teamColor = Color3.fromRGB(255, 255, 255)
            if player.Team then
                if player.Team.TeamColor then
                    teamColor = player.Team.TeamColor.Color
                elseif player.TeamColor then
                    teamColor = player.TeamColor.Color
                end
            end
            
            highlight.FillColor = teamColor
            highlight.FillTransparency = 0.5
            highlight.OutlineColor = teamColor
            highlight.OutlineTransparency = 0
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = character
            esp_data.Highlight = highlight
        end
        
        if esp_data.Highlight then
            if State.esp_highlights then
                local teamColor = Color3.fromRGB(255, 255, 255)
                if player.Team then
                    if player.Team.TeamColor then
                        teamColor = player.Team.TeamColor.Color
                    elseif player.TeamColor then
                        teamColor = player.TeamColor.Color
                    end
                end
                esp_data.Highlight.FillColor = teamColor
                esp_data.Highlight.OutlineColor = teamColor
                esp_data.Highlight.Enabled = true
            else
                esp_data.Highlight.Enabled = false
            end
        end
        
        if ESPSystem.TeamCheck and player.Team == LocalPlayer.Team then
            if esp_data.Highlight then
                esp_data.Highlight.Enabled = false
            end
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
            return
        else
            if esp_data.Highlight then
                esp_data.Highlight.Enabled = true
            end
        end
        
        local camera = workspace.CurrentCamera
        local rootPos, onScreen = camera:WorldToViewportPoint(root.Position)
        
        if not onScreen then
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
            return
        end
        
        local head = character:FindFirstChild("Head")
        if not head then
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
            return
        end
        
        local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
        local legPos = camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
        
        local height = math.abs(headPos.Y - legPos.Y)
        local width = height / 1.5
        
        esp_data.Drawings.Box.Size = Vector2.new(width, height)
        esp_data.Drawings.Box.Position = Vector2.new(rootPos.X - width / 2, headPos.Y)
        esp_data.Drawings.Box.Visible = not State.esp_show_only_highlights
        
        esp_data.Drawings.NameText.Text = player.Name
        esp_data.Drawings.NameText.Visible = not State.esp_show_only_highlights
        
        local my_char = LocalPlayer.Character
        local my_root = my_char and my_char:FindFirstChild("HumanoidRootPart")
        if my_root then
            local distance = math.floor((my_root.Position - root.Position).Magnitude)
            
            local nameWidth = #player.Name * 4.25
            local textOffset = math.max(12.5, height * 0.05)
            
            esp_data.Drawings.NameText.Position = Vector2.new(rootPos.X - nameWidth / 2 - 12, headPos.Y - textOffset)
            
            esp_data.Drawings.DistanceText.Text = string.format("[%d]", distance)
            esp_data.Drawings.DistanceText.Position = Vector2.new(rootPos.X - nameWidth / 2 + nameWidth + 0.5, headPos.Y - textOffset)
            esp_data.Drawings.DistanceText.Visible = not State.esp_show_only_highlights
        else
            esp_data.Drawings.NameText.Position = Vector2.new(rootPos.X - (#player.Name * 3.25), headPos.Y - textOffset)
            esp_data.Drawings.DistanceText.Visible = false
        end
        
        if player.Team and State.esp_show_teamname then
            esp_data.Drawings.TeamText.Text = player.Team.Name
            esp_data.Drawings.TeamText.Position = Vector2.new(rootPos.X, legPos.Y + 5)
            esp_data.Drawings.TeamText.Visible = not State.esp_show_only_highlights
        else
            esp_data.Drawings.TeamText.Visible = false
        end
        
        local healthPercentage = humanoid.Health / humanoid.MaxHealth
        local barHeight = height
        
        esp_data.Drawings.HealthBarOutline.From = Vector2.new(rootPos.X - width / 2 - 7, headPos.Y)
        esp_data.Drawings.HealthBarOutline.To = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y)
        esp_data.Drawings.HealthBarOutline.Visible = not State.esp_show_only_highlights
        
        local healthBarLength = barHeight * healthPercentage
        esp_data.Drawings.HealthBar.From = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y)
        esp_data.Drawings.HealthBar.To = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y - healthBarLength)
        esp_data.Drawings.HealthBar.Visible = not State.esp_show_only_highlights
        
        local r = math.floor((1 - healthPercentage) * 255)
        local g = math.floor(healthPercentage * 255)
        esp_data.Drawings.HealthBar.Color = Color3.fromRGB(r, g, 0)
        
        local healthPercent = math.floor(healthPercentage * 100)
        esp_data.Drawings.HealthText.Text = tostring(healthPercent)
        esp_data.Drawings.HealthText.Position = Vector2.new(rootPos.X - width / 2 - 30, legPos.Y - healthBarLength - 1)
        esp_data.Drawings.HealthText.Visible = not State.esp_show_only_highlights
        
        local weapon = character:FindFirstChildWhichIsA("Tool")
        if not weapon or is_weapon_blacklisted(weapon.Name) then
            local backpack = player:FindFirstChild("Backpack")
            if backpack then
                weapon = nil
                for _, tool in ipairs(backpack:GetChildren()) do
                    if tool:IsA("Tool") and not is_weapon_blacklisted(tool.Name) then
                        weapon = tool
                        break
                    end
                end
            else
                weapon = nil
            end
        end
        
        if weapon then
            local teamColor = Color3.fromRGB(255, 255, 255)
            if player.Team then
                if player.Team.TeamColor then
                    teamColor = player.Team.TeamColor.Color
                elseif player.TeamColor then
                    teamColor = player.TeamColor.Color
                end
            end
            
            esp_data.Drawings.WeaponText.Color = teamColor
            esp_data.Drawings.WeaponText.Text = string.format("[%s]", weapon.Name)
            esp_data.Drawings.WeaponText.Position = Vector2.new(rootPos.X, legPos.Y + (State.esp_show_teamname and 20 or 5))
            esp_data.Drawings.WeaponText.Visible = true
        else
            esp_data.Drawings.WeaponText.Visible = false
        end
    end
    
    local function cleanup_esp()
        if esp_data.Highlight then
            esp_data.Highlight:Destroy()
            esp_data.Highlight = nil
        end
        for _, drawing in pairs(esp_data.Drawings) do
            drawing:Remove()
        end
        esp_data.Drawings = {}
        for _, conn in pairs(esp_data.Connections) do
            conn:Disconnect()
        end
        esp_data.Connections = {}
    end
    
    table.insert(esp_data.Connections, player.CharacterAdded:Connect(function()
        cleanup_esp()
        task.wait(0.07)
        if next(esp_data.Drawings) == nil then
            create_drawings()
        end
        update_esp()
    end))
    
    table.insert(esp_data.Connections, player.CharacterRemoving:Connect(function()
        cleanup_esp()
    end))
    
    create_drawings()
    
    if ESPSystem.Enabled then
        update_esp()
    end
    
    ESPSystem.ESPs[player] = esp_data
end

function ESPSystem.CreateESPForPlayer(player)
    if ESPSystem.ESPs[player] then
        ESPSystem.RemoveESP(player)
    end
    create_esp_for_player(player)
end

function ESPSystem.RemoveESP(player)
    local esp_data = ESPSystem.ESPs[player]
    if not esp_data then return end
    
    pcall(function()
        if esp_data.Highlight then
            esp_data.Highlight.Enabled = false
            esp_data.Highlight:Destroy()
            esp_data.Highlight = nil
        end
    end)
    
    for _, drawing in pairs(esp_data.Drawings) do
        pcall(function()
            drawing.Visible = false
            drawing:Remove()
        end)
    end
    esp_data.Drawings = {}
    
    for _, conn in pairs(esp_data.Connections) do
        pcall(function()
            conn:Disconnect()
        end)
    end
    esp_data.Connections = {}
    
    ESPSystem.ESPs[player] = nil
end

function ESPSystem.Toggle(enabled)
    ESPSystem.Enabled = enabled
    
    if enabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                ESPSystem.CreateESPForPlayer(player)
            end
        end
    else
        for player, esp_data in pairs(ESPSystem.ESPs) do
            if esp_data.Highlight then
                esp_data.Highlight.Enabled = false
            end
            for _, drawing in pairs(esp_data.Drawings) do
                drawing.Visible = false
            end
        end
        
        for player, _ in pairs(ESPSystem.ESPs) do
            ESPSystem.RemoveESP(player)
        end
    end
end

function ESPSystem.RefreshAll()
    for player, esp_data in pairs(ESPSystem.ESPs) do
        if player.Character then
            local root = player.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if root and humanoid and humanoid.Health > 0 then
                if ESPSystem.TeamCheck and player.Team == LocalPlayer.Team then
                    if esp_data.Highlight then
                        esp_data.Highlight.Enabled = false
                    end
                    for _, drawing in pairs(esp_data.Drawings) do
                        drawing.Visible = false
                    end
                else
                    if esp_data.Highlight and State.esp_highlights then
                        esp_data.Highlight.Enabled = true
                    end
                end
            end
        end
    end
end

function ESPSystem.RefreshHighlights()
    for player, esp_data in pairs(ESPSystem.ESPs) do
        if player.Character then
            local character = player.Character
            local root = character:FindFirstChild("HumanoidRootPart")
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            
            if root and humanoid and humanoid.Health > 0 then
                if State.esp_highlights then
                    if not esp_data.Highlight then
                        local highlight = Instance.new("Highlight")
                        highlight.Name = "ESP_Highlight"
                        highlight.Adornee = character
                        
                        local teamColor = Color3.fromRGB(255, 255, 255)
                        if player.Team then
                            if player.Team.TeamColor then
                                teamColor = player.Team.TeamColor.Color
                            elseif player.TeamColor then
                                teamColor = player.TeamColor.Color
                            end
                        end
                        
                        highlight.FillColor = teamColor
                        highlight.FillTransparency = 0.5
                        highlight.OutlineColor = teamColor
                        highlight.OutlineTransparency = 0
                        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
                        highlight.Parent = character
                        esp_data.Highlight = highlight
                    end
                    
                    if esp_data.Highlight then
                        local teamColor = Color3.fromRGB(255, 255, 255)
                        if player.Team then
                            if player.Team.TeamColor then
                                teamColor = player.Team.TeamColor.Color
                            elseif player.TeamColor then
                                teamColor = player.TeamColor.Color
                            end
                        end
                        esp_data.Highlight.FillColor = teamColor
                        esp_data.Highlight.OutlineColor = teamColor
                        esp_data.Highlight.Enabled = true
                    end
                else
                    if esp_data.Highlight then
                        esp_data.Highlight.Enabled = false
                    end
                end
            end
        end
    end
end

RunService.RenderStepped:Connect(function()
    if not ESPSystem.Enabled then return end
    
    local current_time = tick()
    if current_time - State.esp_last_update < State.esp_update_rate then
        return
    end
    State.esp_last_update = current_time
    
    for player, esp_data in pairs(ESPSystem.ESPs) do
        if not player or not player.Parent or not Players:FindFirstChild(player.Name) then
            ESPSystem.RemoveESP(player)
        elseif player.Character then
            local root = player.Character:FindFirstChild("HumanoidRootPart")
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            
            if root and humanoid and humanoid.Health > 0 then
                local function update_drawings()
                    if esp_data.Highlight then
                        if State.esp_highlights then
                            local teamColor = Color3.fromRGB(255, 255, 255)
                            if player.Team then
                                if player.Team.TeamColor then
                                    teamColor = player.Team.TeamColor.Color
                                elseif player.TeamColor then
                                    teamColor = player.TeamColor.Color
                                end
                            end
                            esp_data.Highlight.FillColor = teamColor
                            esp_data.Highlight.OutlineColor = teamColor
                            esp_data.Highlight.Enabled = true
                        else
                            esp_data.Highlight.Enabled = false
                        end
                    end
                    
                    if ESPSystem.TeamCheck and player.Team == LocalPlayer.Team then
                        if esp_data.Highlight then
                            esp_data.Highlight.Enabled = false
                        end
                        for _, drawing in pairs(esp_data.Drawings) do
                            drawing.Visible = false
                        end
                        return
                    else
                        if esp_data.Highlight and State.esp_highlights then
                            esp_data.Highlight.Enabled = true
                        end
                    end
                    
                    local camera = workspace.CurrentCamera
                    local rootPos, onScreen = camera:WorldToViewportPoint(root.Position)
                    
                    if not onScreen then
                        for _, drawing in pairs(esp_data.Drawings) do
                            drawing.Visible = false
                        end
                        return
                    end
                    
                    local head = player.Character:FindFirstChild("Head")
                    if not head then
                        for _, drawing in pairs(esp_data.Drawings) do
                            drawing.Visible = false
                        end
                        return
                    end
                    
                    local headPos = camera:WorldToViewportPoint(head.Position + Vector3.new(0, 0.5, 0))
                    local legPos = camera:WorldToViewportPoint(root.Position - Vector3.new(0, 3, 0))
                    
                    local height = math.abs(headPos.Y - legPos.Y)
                    local width = height / 1.5
                    
                    esp_data.Drawings.Box.Size = Vector2.new(width, height)
                    esp_data.Drawings.Box.Position = Vector2.new(rootPos.X - width / 2, headPos.Y)
                    esp_data.Drawings.Box.Visible = not State.esp_show_only_highlights
                    
                    esp_data.Drawings.NameText.Text = player.Name
                    esp_data.Drawings.NameText.Visible = not State.esp_show_only_highlights
                    
                    local my_char = LocalPlayer.Character
                    local my_root = my_char and my_char:FindFirstChild("HumanoidRootPart")
                    if my_root then
                        local distance = math.floor((my_root.Position - root.Position).Magnitude)
                        
                        local nameWidth = #player.Name * 4.25
                        local textOffset = math.max(12.5, height * 0.05)
                        
                        esp_data.Drawings.NameText.Position = Vector2.new(rootPos.X - nameWidth / 2 - 12, headPos.Y - textOffset)
                        
                        esp_data.Drawings.DistanceText.Text = string.format("[%d]", distance)
                        esp_data.Drawings.DistanceText.Position = Vector2.new(rootPos.X - nameWidth / 2 + nameWidth + 0.5, headPos.Y - textOffset)
                        esp_data.Drawings.DistanceText.Visible = not State.esp_show_only_highlights
                    else
                        esp_data.Drawings.NameText.Position = Vector2.new(rootPos.X - (#player.Name * 3.25), headPos.Y - textOffset)
                        esp_data.Drawings.DistanceText.Visible = false
                    end
                    
                    if player.Team and State.esp_show_teamname then
                        esp_data.Drawings.TeamText.Text = player.Team.Name
                        esp_data.Drawings.TeamText.Position = Vector2.new(rootPos.X, legPos.Y + 5)
                        esp_data.Drawings.TeamText.Visible = not State.esp_show_only_highlights
                    else
                        esp_data.Drawings.TeamText.Visible = false
                    end
                    
                    local healthPercentage = humanoid.Health / humanoid.MaxHealth
                    local barHeight = height
                    
                    esp_data.Drawings.HealthBarOutline.From = Vector2.new(rootPos.X - width / 2 - 7, headPos.Y)
                    esp_data.Drawings.HealthBarOutline.To = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y)
                    esp_data.Drawings.HealthBarOutline.Visible = not State.esp_show_only_highlights
                    
                    local healthBarLength = barHeight * healthPercentage
                    esp_data.Drawings.HealthBar.From = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y)
                    esp_data.Drawings.HealthBar.To = Vector2.new(rootPos.X - width / 2 - 7, legPos.Y - healthBarLength)
                    esp_data.Drawings.HealthBar.Visible = not State.esp_show_only_highlights
                    
                    local r = math.floor((1 - healthPercentage) * 255)
                    local g = math.floor(healthPercentage * 255)
                    esp_data.Drawings.HealthBar.Color = Color3.fromRGB(r, g, 0)
                    
                    local healthPercent = math.floor(healthPercentage * 100)
                    esp_data.Drawings.HealthText.Text = tostring(healthPercent)
                    esp_data.Drawings.HealthText.Position = Vector2.new(rootPos.X - width / 2 - 30, legPos.Y - healthBarLength - 1)
                    esp_data.Drawings.HealthText.Visible = not State.esp_show_only_highlights
                    
                    local weapon = player.Character:FindFirstChildWhichIsA("Tool")
                    if not weapon or is_weapon_blacklisted(weapon.Name) then
                        local backpack = player:FindFirstChild("Backpack")
                        if backpack then
                            weapon = nil
                            for _, tool in ipairs(backpack:GetChildren()) do
                                if tool:IsA("Tool") and not is_weapon_blacklisted(tool.Name) then
                                    weapon = tool
                                    break
                                end
                            end
                        else
                            weapon = nil
                        end
                    end
                    
                    if weapon then
                        local teamColor = Color3.fromRGB(255, 255, 255)
                        if player.Team then
                            if player.Team.TeamColor then
                                teamColor = player.Team.TeamColor.Color
                            elseif player.TeamColor then
                                teamColor = player.TeamColor.Color
                            end
                        end
                        
                        esp_data.Drawings.WeaponText.Color = teamColor
                        esp_data.Drawings.WeaponText.Text = string.format("[%s]", weapon.Name)
                        esp_data.Drawings.WeaponText.Position = Vector2.new(rootPos.X, legPos.Y + (State.esp_show_teamname and 20 or 5))
                        esp_data.Drawings.WeaponText.Visible = true
                    else
                        esp_data.Drawings.WeaponText.Visible = false
                    end
                end
                
                pcall(update_drawings)
            else
                if esp_data.Highlight then
                    esp_data.Highlight.Enabled = false
                end
                for _, drawing in pairs(esp_data.Drawings) do
                    drawing.Visible = false
                end
            end
        end
    end
end)


ScriptJanitor:Add(Players.PlayerAdded:Connect(function(player)
    if ESPSystem.Enabled and player ~= LocalPlayer then
        task.wait(0.25)
        ESPSystem.CreateESPForPlayer(player)
    end
end))

ScriptJanitor:Add(Players.PlayerRemoving:Connect(function(player)
    ESPSystem.RemoveESP(player)
end))


local E = {}
E.toggle_tracks = {}
E.settings_sliders = {}
local file = '__Avatar__Changer__.json'
local UI_VERSION = 7
    
    local function calculate_preview_position(check_other_preview, prefer_left)
   if not E.saved_pos or not E.main then
    return UDim2.new(0, 10, 0, 100)
end
    local vp = workspace.CurrentCamera.ViewportSize
    local main_x = E.saved_pos.X.Offset
    local main_y = E.saved_pos.Y.Offset
    local main_w = E.main.AbsoluteSize.X
    local prev_w = 210
    local prev_h = 340
    
    local right_x = main_x + main_w + 12
    local left_x = main_x - prev_w - 12
    local can_right = right_x + prev_w <= vp.X - 10
    local can_left = left_x >= 10
    
    local x
    if check_other_preview then
        if prefer_left then
            if can_left then
                x = left_x
            elseif can_right then
                x = right_x
            else
                x = 10
            end
        else
            if can_right then
                x = right_x
            elseif can_left then
                x = left_x
            else
                x = vp.X - prev_w - 10
            end
        end
    else
        if prefer_left then
            if can_left then
                x = left_x
            elseif can_right then
                x = right_x
            else
                x = 10
            end
        else
            if can_right then
                x = right_x
            elseif can_left then
                x = left_x
            else
                x = vp.X - prev_w - 10
            end
        end
    end
    
    local y = main_y
    if y + prev_h > vp.Y - 10 then
        y = vp.Y - prev_h - 10
    end
    if y < 10 then
        y = 10
    end
    
    return UDim2.new(0, x, 0, y)
end

local ComponentFactory = {}

local TweenInfoCache = {}

local function get_tween_info(duration, style, direction)
    duration = duration or 0.2
    style = style or Enum.EasingStyle.Quint
    direction = direction or Enum.EasingDirection.Out
    
    local key = string.format("%s_%s_%s", tostring(duration), tostring(style), tostring(direction))
    
    if not TweenInfoCache[key] then
        TweenInfoCache[key] = TweenInfo.new(duration, style, direction)
    end
    
    return TweenInfoCache[key]
end

local function tween(obj, props, dur, style, dir)
    local info = get_tween_info(dur, style, dir)
    local t = TweenService:Create(obj, info, props)
    t:Play()
    return t
end

local function spring(obj, props, dur)
    return tween(obj, props, dur or 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.Out)
end

local function add_hover_effect(btn, normal_color, hover_color, duration, maid)
    normal_color = normal_color or C.elevated
    hover_color = hover_color or C.hover
    duration = duration or 0.1
    
    local enter_conn = btn.MouseEnter:Connect(function() 
        tween(btn, { BackgroundColor3 = hover_color }, duration) 
    end)
    local leave_conn = btn.MouseLeave:Connect(function() 
        tween(btn, { BackgroundColor3 = normal_color }, duration) 
    end)
    
    if maid then
        maid:AddConnection(enter_conn)
        maid:AddConnection(leave_conn)
    end
    
    return enter_conn, leave_conn
end

local TOGGLE_POSITIONS = {
    small = { 
        on = UDim2.new(1, -19, 0.5, -8), 
        off = UDim2.new(0, 3, 0.5, -8) 
    },
    medium = { 
        on = UDim2.new(1, -23, 0.5, -10), 
        off = UDim2.new(0, 3, 0.5, -10) 
    }
}

local function animate_toggle_knob(knob, enabled, size)
    size = size or 'medium'
    local pos = TOGGLE_POSITIONS[size]
    if pos then
        spring(knob, { Position = enabled and pos.on or pos.off }, 0.2)
    end
end

local function new(class, props)
    local obj = Instance.new(class)
    for k, v in pairs(props) do
        if k ~= 'Parent' then
            obj[k] = v
        end
    end
    if props.Parent then
        obj.Parent = props.Parent
    end
    return obj
end

function ComponentFactory.Frame(props)
    local defaults = {
        BackgroundColor3 = C.card,
        BackgroundTransparency = 0,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 100)
    }
    for k, v in pairs(defaults) do
        if props[k] == nil then props[k] = v end
    end
    return new('Frame', props)
end

function ComponentFactory.TextLabel(props)
    local defaults = {
        BackgroundTransparency = 1,
        Font = Enum.Font.GothamMedium,
        TextColor3 = C.text,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Size = UDim2.new(1, 0, 0, 20)
    }
    for k, v in pairs(defaults) do
        if props[k] == nil then props[k] = v end
    end
    return new('TextLabel', props)
end

function ComponentFactory.TextButton(props)
    local defaults = {
        BackgroundColor3 = C.elevated,
        Font = Enum.Font.GothamBold,
        TextColor3 = C.text,
        TextSize = 13,
        AutoButtonColor = false,
        BorderSizePixel = 0,
        Size = UDim2.new(1, 0, 0, 40)
    }
    for k, v in pairs(defaults) do
        if props[k] == nil then props[k] = v end
    end
    return new('TextButton', props)
end

function ComponentFactory.TextBox(props)
    local defaults = {
        BackgroundTransparency = 1,
        Font = Enum.Font.GothamMedium,
        TextColor3 = C.text,
        PlaceholderColor3 = C.muted,
        TextSize = 13,
        ClearTextOnFocus = false,
        Size = UDim2.new(1, 0, 0, 40)
    }
    for k, v in pairs(defaults) do
        if props[k] == nil then props[k] = v end
    end
    return new('TextBox', props)
end

function ComponentFactory.Icon(props)
    local size = props.IconSize or 16
    local defaults = {
        Size = UDim2.new(0, size, 0, size),
        Position = props.Position or UDim2.new(0.5, -size / 2, 0.5, -size / 2),
        BackgroundTransparency = 1,
        ImageColor3 = C.text
    }
    for k, v in pairs(defaults) do
        if k ~= 'IconSize' and props[k] == nil then props[k] = v end
    end
    props.IconSize = nil
    return new('ImageLabel', props)
end

function ComponentFactory.ImageButton(props)
    local size = props.IconSize or 16
    local defaults = {
        Size = UDim2.new(0, size, 0, size),
        BackgroundTransparency = 1,
        ImageColor3 = C.text,
        AutoButtonColor = false
    }
    for k, v in pairs(defaults) do
        if k ~= 'IconSize' and props[k] == nil then props[k] = v end
    end
    props.IconSize = nil
    return new('ImageButton', props)
end

function ComponentFactory.ScrollingFrame(props)
    local defaults = {
        BackgroundTransparency = 1,
        BorderSizePixel = 0,
        ScrollBarThickness = 4,
        ScrollBarImageColor3 = C.accent,
        ScrollBarImageTransparency = 0.5,
        CanvasSize = UDim2.new(0, 0, 0, 0),
        AutomaticCanvasSize = Enum.AutomaticSize.Y,
        ScrollingDirection = Enum.ScrollingDirection.Y,
        ScrollingEnabled = true
    }
    for k, v in pairs(defaults) do
        if props[k] == nil then props[k] = v end
    end
    return new('ScrollingFrame', props)
end

function ComponentFactory.Corner(parent, radius)
    return new('UICorner', {
        CornerRadius = UDim.new(0, radius or 8),
        Parent = parent
    })
end

function ComponentFactory.Stroke(parent, color, thickness, transparency)
    return new('UIStroke', {
        Color = color or C.border,
        Thickness = thickness or 1,
        Transparency = transparency or 0.5,
        Parent = parent
    })
end

function ComponentFactory.ListLayout(parent, props)
    local defaults = {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 8),
        Parent = parent
    }
    for k, v in pairs(props or {}) do
        defaults[k] = v
    end
    return new('UIListLayout', defaults)
end

function ComponentFactory.Padding(parent, all)
    if type(all) == 'number' then
        return new('UIPadding', {
            PaddingTop = UDim.new(0, all),
            PaddingBottom = UDim.new(0, all),
            PaddingLeft = UDim.new(0, all),
            PaddingRight = UDim.new(0, all),
            Parent = parent
        })
    else
        return new('UIPadding', all)
    end
end

local function corner(p, r)
    return ComponentFactory.Corner(p, r)
end

local function stroke(p, c, t, trans)
    return ComponentFactory.Stroke(p, c, t, trans)
end

local function icon(parent, id, size, color, position)
    return ComponentFactory.Icon({
        Parent = parent,
        Image = id,
        IconSize = size,
        ImageColor3 = color,
        Position = position
    })
end

local function save_data()
    if not writefile then
        return
    end
    if not E.main then
        return
    end
    pcall(function()
        local pos_x = E.saved_pos and E.saved_pos.X.Offset or (E.main and E.main.Position.X.Offset or 0)
        local pos_y = E.saved_pos and E.saved_pos.Y.Offset or (E.main and E.main.Position.Y.Offset or 0)
        
        writefile(file, HttpService:JSONEncode({
            ui_version = UI_VERSION,
            input = E.input and E.input.Text or '',
            auto = State.auto,
            minimized = State.minimized,
            visible = State.visible,
            x = pos_x,
            y = pos_y,
            fab_x = E.fab and E.fab.Position.X.Offset or 0,
            fab_y = E.fab and E.fab.Position.Y.Offset or 0,
            favorites = State.favorites,
            width_scale = State.width_scale,
            width_enabled = State.width_enabled,
            height_scale = State.height_scale,
            height_enabled = State.height_enabled,
            depth_scale = State.depth_scale,
            depth_enabled = State.depth_enabled,
            music_index = State.music_index,
            music_loop = State.music_loop,
            sound_effects_enabled = State.sound_effects_enabled,
            apply_counts = State.apply_counts,
            rgb_mode = State.rgb_mode,
            rgb_mode_type = State.rgb_mode_type,
            rgb_speed = State.rgb_speed,
            current_theme = State.current_theme,
            esp_enabled = State.esp_enabled,
            esp_teamcheck = State.esp_teamcheck,
            esp_highlights = State.esp_highlights,
            esp_show_teamname = State.esp_show_teamname,
            toggle_keybind = State.toggle_keybind.Name,
            applied_id = State.applied_id,
            notifications_enabled = State.notifications_enabled
        }))
    end)
end

local function load_data()
    if not readfile then
        return {}
    end
    local ok, d = pcall(function()
        return HttpService:JSONDecode(readfile(file))
    end)
    return ok and d or {}
end

local function play_sound(sound_id, volume)
    return SoundManager.play(sound_id, volume or 0.5)
end

local ApiUtils = {}
ApiUtils.retry_config = {
    max_attempts = 3,
    initial_delay = 0.5,
    max_delay = 5,
    backoff_multiplier = 2
}

local function resolve(txt)
    if type(txt) == 'number' then
        return txt
    end
    if not txt or txt == '' then
        return nil
    end
    if type(txt) == 'string' then
        txt = txt:match('^%s*(.-)%s*$')
        if tonumber(txt) then
            return tonumber(txt)
        end
    end
    return nil
end

local function clamp_frame(frame, avoid_overlap)
    local vp = workspace.CurrentCamera.ViewportSize
    local s = frame.AbsoluteSize
    local max_x = math.max(10, vp.X - s.X - 10)
    local max_y = math.max(10, vp.Y - s.Y - 10)
    local x = math.clamp(frame.Position.X.Offset, 10, max_x)
    local y = math.clamp(frame.Position.Y.Offset, 10, max_y)
    
    if avoid_overlap and State.preview_open and E.preview and E.preview.Visible then
        local prev_x = E.preview.Position.X.Offset
        local prev_y = E.preview.Position.Y.Offset
        local prev_w = 210
        local prev_h = 340
        local main_right = x + s.X
        local main_bottom = y + s.Y
        local prev_right = prev_x + prev_w
        local prev_bottom = prev_y + prev_h
        
        if x < prev_right and main_right > prev_x and y < prev_bottom and main_bottom > prev_y then
            local left_x = prev_x - s.X - 12
            if left_x >= 10 then
                x = left_x
            else
                local right_x = prev_right + 12
                if right_x + s.X <= vp.X - 10 then
                    x = right_x
                else
                    local above_y = prev_y - s.Y - 12
                    local below_y = prev_bottom + 12
                    if above_y >= 10 then
                        y = above_y
                    elseif below_y + s.Y <= vp.Y - 10 then
                        y = below_y
                    end
                end
            end
        end
    end
    return UDim2.new(0, x, 0, y)
end

local function cleanup_all()
    ScriptJanitor:Cleanup()
    State.conns = {}
    
    if State.music_sound then
        State.music_sound:Stop()
        State.music_sound:Destroy()
        State.music_sound = nil
    end
    
    SoundManager.cleanup()
    SoundManager.init()
    
    for player, _ in pairs(ESPSystem.ESPObjects) do
    ESPSystem.RemoveESP(player)
    end
    
    if State.cache then
        table.clear(State.cache)
    end
    if State.player_original_descs then
        table.clear(State.player_original_descs)
    end
    if State.apply_counts then
        table.clear(State.apply_counts)
    end
    
    if State.original_desc and State.applied_id then
        local char = LocalPlayer.Character
        if char then
            local hum = char:FindFirstChildOfClass('Humanoid')
            if hum then
                pcall(function()
                    if hum.ApplyDescriptionClientServer then
                        hum:ApplyDescriptionClientServer(State.original_desc)
                    else
                        hum:ApplyDescription(State.original_desc)
                    end
                end)
            end
        end
    end
    
    if E.screen then
        E.screen:Destroy()
    end
    
    State.applied_id = nil
end

env[SCRIPT_FLAG] = {
    cleanup = cleanup_all,
    state = State
}

local PlayerAutocomplete = {}

function PlayerAutocomplete.setup(textbox, autocomplete_label, on_change)
    local current_suggestion = ''
    
    local function update_suggestion()
        local input_text = textbox.Text:lower()
        
        if input_text == '' then
            autocomplete_label.Text = ''
            current_suggestion = ''
            if on_change then on_change('') end
            return
        end
        
        local match = nil
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                local username = player.Name:lower()
                local display = player.DisplayName:lower()
                
                if username:sub(1, #input_text) == input_text then
                    match = player.Name
                    break
                elseif display:sub(1, #input_text) == input_text then
                    match = player.Name
                    break
                end
            end
        end
        
        if match and #input_text < #match then
            current_suggestion = match
            autocomplete_label.Text = match
        else
            autocomplete_label.Text = ''
            current_suggestion = ''
        end
        
        if on_change then on_change(input_text) end
    end
    
    local is_updating_from_autocomplete = false
    
    textbox:GetPropertyChangedSignal('Text'):Connect(function()
        if not is_updating_from_autocomplete then
            update_suggestion()
        end
    end)
    
    textbox.FocusLost:Connect(function(enterPressed)
        if enterPressed and current_suggestion ~= '' then
            is_updating_from_autocomplete = true
            textbox.Text = current_suggestion
            autocomplete_label.Text = ''
            local final_suggestion = current_suggestion
            current_suggestion = ''
            
            if on_change then 
                on_change(final_suggestion:lower())
            end
            
            task.wait()
            is_updating_from_autocomplete = false
        elseif not enterPressed then
            if on_change then on_change(textbox.Text:lower()) end
        end
    end)
    
    ScriptJanitor:Add(Players.PlayerAdded:Connect(function()
        if textbox:IsFocused() and textbox.Text ~= "" then
            update_suggestion()
        end
    end))
    
    ScriptJanitor:Add(Players.PlayerRemoving:Connect(function(leaving_player)
        if current_suggestion == leaving_player.Name then
            autocomplete_label.Text = ''
            current_suggestion = ''
        end
    end))
    
    return {
        update = update_suggestion,
        clear = function()
            textbox.Text = ''
            autocomplete_label.Text = ''
            current_suggestion = ''
        end
    }
end

local Notify = {}
Notify.list = {}

function Notify.show(msg, ntype, dur)
    if not State.notifications_enabled then
        return
    end
    
    if not E.screen or not E.screen.Parent then
        return
    end
    
    dur = dur or 3
    local color = C.accent
    local ico = Icons.info
    
    if ntype == 'success' then
        color = C.success
        ico = Icons.check
    elseif ntype == 'error' then
        color = C.error
        ico = Icons.x
    elseif ntype == 'warning' then
        color = C.warning
        ico = Icons.warning
    end
    
    local container = ComponentFactory.Frame({
        Size = UDim2.new(0, 300, 0, 0),
        Position = UDim2.new(1, -315, 1, -15 - (#Notify.list * 75)),
        AnchorPoint = Vector2.new(0, 1),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        ClipsDescendants = true,
        Parent = E.screen
    })
    corner(container, 12)
    stroke(container, color, 1.5, 0.3)
    
    new('Frame', {
        Size = UDim2.new(0, 4, 1, -16),
        Position = UDim2.new(0, 12, 0, 8),
        BackgroundColor3 = color,
        Parent = container
    })
    
    local icon_bg = ComponentFactory.Frame({
        Size = UDim2.new(0, 36, 0, 36),
        Position = UDim2.new(0, 26, 0.5, -18),
        BackgroundColor3 = color,
        BackgroundTransparency = 0.85,
        Parent = container
    })
    corner(icon_bg, 10)
    icon(icon_bg, ico, 18, color)
    
    local titles = {
        success = 'Success',
        error = 'Error',
        warning = 'Warning',
        info = 'Info'
    }
    
    new('TextLabel', {
        Size = UDim2.new(1, -85, 0, 16),
        Position = UDim2.new(0, 72, 0, 14),
        BackgroundTransparency = 1,
        Text = titles[ntype] or titles.info,
        TextColor3 = color,
        Font = Enum.Font.GothamBold,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container
    })
    
    new('TextLabel', {
        Size = UDim2.new(1, -85, 0, 18),
        Position = UDim2.new(0, 72, 0, 32),
        BackgroundTransparency = 1,
        Text = msg,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        TextTruncate = Enum.TextTruncate.AtEnd,
        Parent = container
    })
    
    local prog_bg = ComponentFactory.Frame({
        Size = UDim2.new(1, -24, 0, 3),
        Position = UDim2.new(0, 12, 1, -10),
        BackgroundColor3 = C.card,
        Parent = container
    })
    corner(prog_bg, 2)
    
    local prog = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundColor3 = color,
        Parent = prog_bg
    })
    corner(prog, 2)
    
    table.insert(Notify.list, container)
    spring(container, { Size = UDim2.new(0, 300, 0, 70) }, 0.25)
    tween(prog, { Size = UDim2.new(0, 0, 1, 0) }, dur, Enum.EasingStyle.Linear)
    
    task.delay(dur, function()
        tween(container, { Size = UDim2.new(0, 300, 0, 0), BackgroundTransparency = 1 }, 0.2)
        task.delay(0.25, function()
            for i, n in ipairs(Notify.list) do
                if n == container then
                    table.remove(Notify.list, i)
                    break
                end
            end
            container:Destroy()
            for i, n in ipairs(Notify.list) do
                tween(n, { Position = UDim2.new(1, -315, 1, -15 - ((i - 1) * 75)) }, 0.2)
            end
        end)
    end)
end

local Fav = {}
Fav.removing = false

function Fav.is_favorited(id)
    return State.favorites_index[id] == true
end

function Fav.update_star_icon()
    if not E.star_icon then
        return
    end
    if State.applied_id and Fav.is_favorited(State.applied_id) then
        E.star_icon.Image = Icons.heart
        tween(E.star_icon, { ImageColor3 = Color3.fromRGB(239, 68, 68) }, 0.15)
    else
        E.star_icon.Image = Icons.heart_off
        tween(E.star_icon, { ImageColor3 = C.subtext }, 0.15)
    end
end

function Fav.add(id)
    if Fav.is_favorited(id) then
        return
    end
    local name
    local ok, n = pcall(Players.GetNameFromUserIdAsync, Players, id)
    name = ok and n or tostring(id)
    table.insert(State.favorites, {id = id, name = name, time = os.time()})
    State.favorites_index[id] = true
    save_data()
    State.fav_ui_initialized = false
    if State.current_tab == 'favorites' then
        Fav.update_ui()
        State.fav_ui_initialized = true
    end
    play_sound(Sounds.favorite)
    Notify.show('Added To Favorites!', 'success', 2)
    Fav.update_star_icon()
end

function Fav.remove(id)
    if Fav.removing then
        return
    end
    Fav.removing = true
    
    for i, fav in ipairs(State.favorites) do
        if fav.id == id then
            table.remove(State.favorites, i)
            State.favorites_index[id] = nil
            save_data()
            State.fav_ui_initialized = false
            if State.current_tab == 'favorites' then
                Fav.update_ui()
                State.fav_ui_initialized = true
            end
            play_sound(Sounds.unfavorite)
            Notify.show('Removed From Favorites', 'info', 2)
            task.delay(0.2, function() Fav.removing = false end)
            Fav.update_star_icon()
            return
        end
    end
    Fav.removing = false
end

function Fav.toggle(id)
    if Fav.is_favorited(id) then
        Fav.remove(id)
    else
        Fav.add(id)
    end
end

local Av = {}

function Fav.update_ui()
    if not E.fav_list then
        return
    end
    
    for _, child in ipairs(E.fav_list:GetChildren()) do
        if child:IsA('Frame') or child:IsA('TextLabel') then
            child:Destroy()
        end
    end
    
    local filtered_favorites = {}
    local search_lower = State.fav_search_text:lower()
    
    for _, fav in ipairs(State.favorites) do
        if search_lower == '' or 
           fav.name:lower():find(search_lower, 1, true) or 
           tostring(fav.id):find(search_lower, 1, true) then
            table.insert(filtered_favorites, fav)
        end
    end
    
    if #filtered_favorites == 0 then
        local empty_text = #State.favorites == 0 and
            '⭐ No Favorites Yet!\nApply An Avatar And Click\nThe Button To Save It' or
            '🔍 No Matches Found\nTry A Different Search'
        
        new('TextLabel', {
            Size = UDim2.new(1, 0, 0, 100),
            BackgroundTransparency = 1,
            Text = empty_text,
            TextColor3 = C.muted,
            Font = Enum.Font.GothamMedium,
            TextSize = 13,
            Parent = E.fav_list
        })
        E.fav_list.CanvasSize = UDim2.new(0, 0, 0, 100)
        return
    end
    
    local total_height = 0
    for i = #filtered_favorites, 1, -1 do
        local fav = filtered_favorites[i]
        
        local item = ComponentFactory.Frame({
            Size = UDim2.new(1, -12, 0, 68),
            BackgroundColor3 = C.elevated,
            Parent = E.fav_list
        })
        corner(item, 12)
        stroke(item, C.border, 1, 0.3)
        
        local content_container = ComponentFactory.Frame({
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Parent = item
        })
        
        new('TextLabel', {
            Size = UDim2.new(1, -140, 0, 20),
            Position = UDim2.new(0, 16, 0, 12),
            BackgroundTransparency = 1,
            Text = fav.name,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Left,
            TextTruncate = Enum.TextTruncate.AtEnd,
            Parent = content_container
        })
        
        new('TextLabel', {
            Size = UDim2.new(1, -140, 0, 16),
            Position = UDim2.new(0, 16, 0, 36),
            BackgroundTransparency = 1,
            Text = 'ID : ' .. tostring(fav.id),
            TextColor3 = C.muted,
            Font = Enum.Font.GothamMedium,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = content_container
        })
        
        local apply_btn = ComponentFactory.TextButton({
            Size = UDim2.new(0, 70, 0, 50),
            Position = UDim2.new(1, -120, 0.5, -25),
            BackgroundColor3 = C.accent,
            Text = '',
            AutoButtonColor = false,
            Parent = content_container
        })
        corner(apply_btn, 10)
        
        new('TextLabel', {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = 'APPLY',
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 12,
            Parent = apply_btn
        })
        
        apply_btn.MouseEnter:Connect(function() tween(apply_btn, { BackgroundColor3 = C.accent_glow }, 0.1) end)
        apply_btn.MouseLeave:Connect(function() tween(apply_btn, { BackgroundColor3 = C.accent }, 0.1) end)
        
        local captured_id = fav.id
        apply_btn.InputBegan:Connect(function(inp)
            if is_click_input(inp) then
                E.input.Text = tostring(captured_id)
                E.switch_tab('main')
                Av.apply(tostring(captured_id), nil, false, true)
            end
        end)
        
        local remove_btn = ComponentFactory.TextButton({
            Size = UDim2.new(0, 36, 0, 50),
            Position = UDim2.new(1, -44, 0.5, -25),
            BackgroundColor3 = C.card,
            Text = '',
            AutoButtonColor = false,
            Parent = content_container
        })
        corner(remove_btn, 10)
        icon(remove_btn, Icons.x, 16, C.subtext)
        
        remove_btn.MouseEnter:Connect(function() tween(remove_btn, { BackgroundColor3 = C.hover }, 0.1) end)
        remove_btn.MouseLeave:Connect(function() tween(remove_btn, { BackgroundColor3 = C.card }, 0.1) end)
        
        local captured_id_remove = fav.id
        remove_btn.InputBegan:Connect(function(inp)
            if is_click_input(inp) then
                Fav.remove(captured_id_remove)
            end
        end)
        
        total_height = total_height + 68 + 12
    end
    
    E.fav_list.CanvasSize = UDim2.new(0, 0, 0, total_height + 30)
end

local Prev = {
    rot = 180,
    model = nil,
    cam = nil,
    world = nil,
    loading = false,
    current_id = nil,
    load_token = 0
}

function Prev.clear()
    if Prev.model then
        Prev.model:Destroy() Prev.model = nil
    end
    if Prev.cam then
        Prev.cam:Destroy() Prev.cam = nil
    end
    if Prev.world then
        Prev.world:Destroy() Prev.world = nil
    end
    Prev.rot = 180
    Prev.current_id = nil
end

function Prev.update()
    if not Prev.cam or not Prev.model then
        return
    end
    local root = Prev.model:FindFirstChild('HumanoidRootPart')
    if not root or not root.Parent then
        Prev.clear()
        return
    end
    local a = math.rad(Prev.rot)
    local zoom = State.zoom_level
    Prev.cam.CFrame = CFrame.new(
        root.Position + Vector3.new(math.sin(a) * zoom, 0.4, math.cos(a) * zoom),
        root.Position + Vector3.new(0, 0.2, 0)
    )
end

function Prev.load(target)
    Prev.load_token = Prev.load_token + 1
    local this_token = Prev.load_token
    
    if not target or target == '' then
        Prev.clear()
        E.vp_label.Text = 'Enter ID'
        E.vp_label.Visible = true
        E.vp_user.Text = ''
        return
    end
    
    local id = resolve(target)
    if not id then
        Prev.clear()
        E.vp_label.Text = 'Not Found'
        E.vp_label.Visible = true
        E.vp_user.Text = ''
        return
    end
    
    if Prev.current_id == id and not Prev.loading then
        return
    end
    
    E.vp_label.Text = 'Loading...'
    E.vp_label.Visible = true
    E.vp_user.Text = ''
    
    task.spawn(function()
        if Prev.load_token ~= this_token then
            return
        end
        Prev.clear()
        Prev.loading = true
        Prev.current_id = id
        
        local ok, name = pcall(Players.GetNameFromUserIdAsync, Players, id)
        if Prev.load_token ~= this_token then
            Prev.loading = false return
        end
        E.vp_user.Text = ok and name or tostring(id)
        
        local cok, char = pcall(Players.CreateHumanoidModelFromUserId, Players, id)
        if Prev.load_token ~= this_token then
            if char then
                char:Destroy()
            end
            Prev.loading = false
            return
        end
        
        if not cok or not char then
            E.vp_label.Text = 'Failed'
            Prev.loading = false
            Prev.current_id = nil
            return
        end
        
        Prev.world = Instance.new('WorldModel')
        Prev.world.Parent = E.viewport
        Prev.model = char
        Prev.model.Parent = Prev.world
        
        local hum = Prev.model:FindFirstChildOfClass('Humanoid')
        if hum then
            hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
        end
        
        local root = Prev.model:FindFirstChild('HumanoidRootPart')
        if root then
            root.Anchored = true
            Prev.model.PrimaryPart = root
            root.CFrame = CFrame.new(0, 0, 0)
        end
        
        Prev.cam = Instance.new('Camera')
        Prev.cam.Parent = E.viewport
        E.viewport.CurrentCamera = Prev.cam
        Prev.rot = 180
        Prev.update()
        E.vp_label.Visible = false
        Prev.loading = false
        
        local rig_type = 'R15'
        if hum then
            if hum.RigType == Enum.HumanoidRigType.R6 then
                rig_type = 'R6'
            end
        end
        
        State.avatar_details[id] = {
            username = ok and name or tostring(id),
            rig_type = rig_type,
            user_id = id
        }
        
        if E.vp_details then
            E.vp_details.Text = string.format('%s • %s', rig_type, ok and name or tostring(id))
        end
        
        task.spawn(function()
            if Prev.load_token ~= this_token or not Prev.model then
                return
            end
            for _, o in ipairs(Prev.model:GetChildren()) do
                if o:IsA('Shirt') then
                    local t = o.ShirtTemplate
                    o.ShirtTemplate = ''
                    o.ShirtTemplate = t
                elseif o:IsA('Pants') then
                    local t = o.PantsTemplate
                    o.PantsTemplate = ''
                    o.PantsTemplate = t
                end
            end
        end)
    end)
end

local ClientPrev = {
    rot = 180,
    model = nil,
    cam = nil,
    world = nil,
    loading = false,
    current_id = nil,
    load_token = 0
}

function ClientPrev.clear()
    if ClientPrev.model then
        ClientPrev.model:Destroy() ClientPrev.model = nil
    end
    if ClientPrev.cam then
        ClientPrev.cam:Destroy() ClientPrev.cam = nil
    end
    if ClientPrev.world then
        ClientPrev.world:Destroy() ClientPrev.world = nil
    end
    ClientPrev.rot = 180
    ClientPrev.current_id = nil
end

function ClientPrev.update()
    if not ClientPrev.cam or not ClientPrev.model then
        return
    end
    local root = ClientPrev.model:FindFirstChild('HumanoidRootPart')
    if not root then
        return
    end
    local a = math.rad(ClientPrev.rot)
    local zoom = State.client_zoom_level
    ClientPrev.cam.CFrame = CFrame.new(
        root.Position + Vector3.new(math.sin(a) * zoom, 0.4, math.cos(a) * zoom),
        root.Position + Vector3.new(0, 0.2, 0)
    )
end

function ClientPrev.load(target)
    ClientPrev.load_token = ClientPrev.load_token + 1
    local this_token = ClientPrev.load_token
    
    if not target or target == '' then
        ClientPrev.clear()
        if E.client_vp_label then
            E.client_vp_label.Text = 'Enter ID'
            E.client_vp_label.Visible = true
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ''
        end
        return
    end
    
    local id = resolve(target)
    if not id then
        ClientPrev.clear()
        if E.client_vp_label then
            E.client_vp_label.Text = 'Not Found'
            E.client_vp_label.Visible = true
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ''
        end
        return
    end
    
    if ClientPrev.current_id == id and not ClientPrev.loading then
        return
    end
    
    if E.client_vp_label then
        E.client_vp_label.Text = 'Loading...'
        E.client_vp_label.Visible = true
    end
    if E.client_vp_user then
        E.client_vp_user.Text = ''
    end
    
    task.spawn(function()
        if ClientPrev.load_token ~= this_token then
            return
        end
        ClientPrev.clear()
        ClientPrev.loading = true
        ClientPrev.current_id = id
        
        local ok, name = pcall(Players.GetNameFromUserIdAsync, Players, id)
        if ClientPrev.load_token ~= this_token then
            ClientPrev.loading = false return
        end
        if E.client_vp_user then
            E.client_vp_user.Text = ok and name or tostring(id)
        end
        
        local cok, char = pcall(Players.CreateHumanoidModelFromUserId, Players, id)
        if ClientPrev.load_token ~= this_token then
            if char then
                char:Destroy()
            end
            ClientPrev.loading = false
            return
        end
        
        if not cok or not char then
            if E.client_vp_label then
                E.client_vp_label.Text = 'Failed'
            end
            ClientPrev.loading = false
            ClientPrev.current_id = nil
            return
        end
        
        ClientPrev.world = Instance.new('WorldModel')
        ClientPrev.world.Parent = E.client_viewport
        ClientPrev.model = char
        ClientPrev.model.Parent = ClientPrev.world
        
        local hum = ClientPrev.model:FindFirstChildOfClass('Humanoid')
        if hum then
            hum.DisplayDistanceType = Enum.HumanoidDisplayDistanceType.None
        end
        
        local root = ClientPrev.model:FindFirstChild('HumanoidRootPart')
        if root then
            root.Anchored = true
            ClientPrev.model.PrimaryPart = root
            root.CFrame = CFrame.new(0, 0, 0)
        end
        
        ClientPrev.cam = Instance.new('Camera')
        ClientPrev.cam.Parent = E.client_viewport
        E.client_viewport.CurrentCamera = ClientPrev.cam
        ClientPrev.rot = 180
        ClientPrev.update()
        if E.client_vp_label then
            E.client_vp_label.Visible = false
        end
        ClientPrev.loading = false
        
        task.spawn(function()
            if ClientPrev.load_token ~= this_token or not ClientPrev.model then
                return
            end
            for _, o in ipairs(ClientPrev.model:GetChildren()) do
                if o:IsA('Shirt') then
                    local t = o.ShirtTemplate
                    o.ShirtTemplate = ''
                    o.ShirtTemplate = t
                elseif o:IsA('Pants') then
                    local t = o.PantsTemplate
                    o.PantsTemplate = ''
                    o.PantsTemplate = t
                end
            end
        end)
    end)
end

function Av.get_desc(id)
    if State.cache[id] then
        return State.cache[id]
    end
    local ok, desc = pcall(Players.GetHumanoidDescriptionFromUserId, Players, id)
    if ok and desc then
        State.cache[id] = desc
        return desc
    end
    return nil
end

function Av.build_allowed_from_userid(userId)
    local ok, model = pcall(function()
        return Players:GetCharacterAppearanceAsync(userId)
    end)
    if not ok or not model then
        return nil
    end
    local allowedAccessories = {}
    local allowedShirt, allowedPants, allowedGraphic
    for _, inst in ipairs(model:GetChildren()) do
        if inst:IsA('Accessory') then
            allowedAccessories[inst.Name] = true
        elseif inst:IsA('Shirt') then
            allowedShirt = inst.ShirtTemplate
        elseif inst:IsA('Pants') then
            allowedPants = inst.PantsTemplate
        elseif inst:IsA('ShirtGraphic') then
            allowedGraphic = inst.Graphic
        end
    end
    model:Destroy()
    return {
        Accessories = allowedAccessories,
        Shirt = allowedShirt,
        Pants = allowedPants,
        Graphic = allowedGraphic,
    }
end

function Av.selective_cleanup(Character, allowed)
    if not allowed then
        return
    end
    for _, v in ipairs(Character:GetChildren()) do
        if v:IsA('Accessory') then
            if not allowed.Accessories[v.Name] then
                v:Destroy()
            end
        elseif v:IsA('Shirt') then
            if not allowed.Shirt or v.ShirtTemplate ~= allowed.Shirt then
                v:Destroy()
            end
        elseif v:IsA('Pants') then
            if not allowed.Pants or v.PantsTemplate ~= allowed.Pants then
                v:Destroy()
            end
        elseif v:IsA('ShirtGraphic') then
            if not allowed.Graphic or v.Graphic ~= allowed.Graphic then
                v:Destroy()
            end
        end
    end
end

function Av.clean(char)
    local preserved_tools = {}
    for _, c in ipairs(char:GetChildren()) do
        if c:IsA('Tool') or c:IsA('HopperBin') then
            table.insert(preserved_tools, c)
            c.Parent = nil
        end
    end
    
    local backpack = char.Parent and char.Parent:FindFirstChild('Backpack')
    if backpack then
        for _, t in ipairs(backpack:GetChildren()) do
            if t:IsA('Tool') or t:IsA('HopperBin') then
                table.insert(preserved_tools, t)
            end
        end
    end
    
    local safe = {}
    for _, o in ipairs(char:GetDescendants()) do
        if o:IsA('BaseScript') then
            safe[o] = true
            if o.Parent then
                safe[o.Parent] = true
            end
        end
    end
    
    for _, c in ipairs(char:GetChildren()) do
        if safe[c] then
            continue
        end
        if c:IsA('Accessory') or c:IsA('Hat') or c:IsA('BodyColors') or 
           c:IsA('CharacterMesh') or c:IsA('Shirt') or c:IsA('Pants') or 
           c:IsA('ShirtGraphic') then
            c:Destroy()
        end
    end
    
    for _, tool in ipairs(preserved_tools) do
        if tool and tool.Parent == nil then
            if backpack then
                tool.Parent = backpack
            else
                tool.Parent = char
            end
        end
    end
end

function Av.apply_body_scales(char)
    if not char then
        char = LocalPlayer.Character
    end
    if not char then
        return
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    if not hum then
        return
    end
    
    local desc = hum:GetAppliedDescription()
    if not desc then
        return
    end
    
    local changed = false
    
    if State.width_enabled then
        desc.WidthScale = State.width_scale
        changed = true
    end
    
    if State.height_enabled then
        desc.HeightScale = State.height_scale
        changed = true
    end
    
    if State.depth_enabled then
        desc.DepthScale = State.depth_scale
        changed = true
    end
    
    if State.head_enabled then
        desc.HeadScale = State.head_scale
        changed = true
    end
    
    if changed then
        apply_description(hum, desc)
    end
end

function Av.apply(target, targetChar, skip_history, is_manual)
    if State.applying then
        return
    end
    
    local current_time = tick()
    if not targetChar and not is_manual and (current_time - State.last_apply_time) < State.apply_cooldown then
        return
    end
    
    State.applying = true
    
    task.spawn(function()
        local id = resolve(target)
        if not id then
            State.applying = false
            Notify.show('User Not Found', 'error')
            return
        end
        
     if not targetChar and State.applied_id == id and not skip_history and State.last_apply_time > 0 then
       State.applying = false
       Notify.show('Avatar Already Applied!', 'warning', 2)
           return
        end
        
        local char = targetChar or LocalPlayer.Character
        if not char or not char:FindFirstChild('HumanoidRootPart') then
            State.applying = false
            return
        end
        
        if not targetChar then
            Notify.show('Loading Avatar...', 'info')
        end
        
        local desc = Av.get_desc(id)
        if not desc then
            State.applying = false
            Notify.show('Failed To Fetch', 'error')
            return
        end
        
        local hum = char:FindFirstChildOfClass('Humanoid')
        if not hum then
            State.applying = false
            return
        end
        
        if not targetChar and not State.original_desc then
            local original_desc = hum:GetAppliedDescription()
            if original_desc then
                State.original_desc = original_desc
            end
        end
        
        local tools, backpack = collect_tools(char)
        
        local allowed = Av.build_allowed_from_userid(id)
        if allowed then
            Av.selective_cleanup(char, allowed)
        else
            Av.clean(char)
        end
        
        apply_description(hum, desc)
        
        restore_tools(tools, backpack, char)
        
        local bc = char:FindFirstChildOfClass('BodyColors')
        if not bc then
            bc = Instance.new('BodyColors')
            bc.Parent = char
        end
        
        bc.HeadColor3 = desc.HeadColor
        bc.TorsoColor3 = desc.TorsoColor
        bc.LeftArmColor3 = desc.LeftArmColor
        bc.RightArmColor3 = desc.RightArmColor
        bc.LeftLegColor3 = desc.LeftLegColor
        bc.RightLegColor3 = desc.RightLegColor
        
        if not targetChar then
            if not skip_history and State.applied_id then
                for i = #State.undo_history, 1, -1 do
                    if State.undo_history[i] == id then
                        table.remove(State.undo_history, i)
                        break
                    end
                end
                
                table.insert(State.undo_history, State.applied_id)
                if #State.undo_history > State.max_history then
                    table.remove(State.undo_history, 1)
                end
                State.redo_history = {}
            end
            
            State.applied_id = id
            State.apply_counts[tostring(id)] = (State.apply_counts[tostring(id)] or 0) + 1
            State.last_apply_time = tick()
            save_data()
            Av.apply_body_scales(char)
            Fav.update_star_icon()
            if E.update_stats_ui then
                task.spawn(function()
                    E.update_stats_ui()
                end)
            end
            if E.update_undo_redo_ui then
                E.update_undo_redo_ui()
            end
        end
        
        State.applying = false
        Notify.show('Avatar Applied!', 'success')
    end)
end

function Av.undo()
    apply_history_state(State.undo_history, State.redo_history, true)
end

function Av.redo()
    apply_history_state(State.redo_history, State.undo_history, false)
end

function Av.apply_to_player(targetPlayer, avatarId, skipNotify)
    local char = targetPlayer.Character
    if not char or not char:FindFirstChild('HumanoidRootPart') then
        if not skipNotify then
            Notify.show('Player Has No Character', 'error')
        end
        return false
    end
    
    local id = resolve(avatarId)
    if not id then
        if not skipNotify then
            Notify.show('Avatar ID Not Found', 'error')
        end
        return false
    end
    
    local desc = Av.get_desc(id)
    if not desc then
        if not skipNotify then
            Notify.show('Failed To Fetch Avatar', 'error')
        end
        return false
    end
    
    local hum = char:FindFirstChildOfClass('Humanoid')
    if not hum then
        if not skipNotify then
            Notify.show('No Humanoid Found', 'error')
        end
        return false
    end
    
    if not State.player_original_descs[targetPlayer.UserId] then
        local original = hum:GetAppliedDescription()
        if original then
            State.player_original_descs[targetPlayer.UserId] = original
        end
    end
    
    local allowed = Av.build_allowed_from_userid(id)
    if allowed then
        Av.selective_cleanup(char, allowed)
    else
        Av.clean(char)
    end
    
    pcall(function()
        if hum.ApplyDescriptionClientServer then
            hum:ApplyDescriptionClientServer(desc)
        else
            hum:ApplyDescription(desc)
        end
    end)
    
    local bc = char:FindFirstChildOfClass('BodyColors')
    if not bc then
        bc = Instance.new('BodyColors')
        bc.Parent = char
    end
    
    bc.HeadColor3 = desc.HeadColor
    bc.TorsoColor3 = desc.TorsoColor
    bc.LeftArmColor3 = desc.LeftArmColor
    bc.RightArmColor3 = desc.RightArmColor
    bc.LeftLegColor3 = desc.LeftLegColor
    bc.RightLegColor3 = desc.RightLegColor
    
    local fields = {
        'HatAccessory', 'HairAccessory', 'FaceAccessory', 'NeckAccessory',
        'FrontAccessory', 'BackAccessory', 'WaistAccessory'
    }
    return true
end

function Av.apply_to_player_by_name(playerName, avatarId)
    client_apply_guard(function()
        local targetPlayer = find_player_by_name(playerName)
        
        if not targetPlayer then
            Notify.show('Player Not Found', 'error')
            return
        end
        
        local success = Av.apply_to_player(targetPlayer, avatarId)
        
        if success then
            Notify.show('Applied To ' .. targetPlayer.Name .. '!', 'success')
        end
    end)
end

function Av.reset_player_avatar(playerName)
    local targetPlayer = find_player_by_name(playerName)
    
    if not targetPlayer then
        Notify.show('Player Not Found', 'error')
        return
    end
    
    if not State.player_original_descs[targetPlayer.UserId] then
        Notify.show('No Avatar Applied To ' .. targetPlayer.Name, 'warning')
        return
    end
    
    local char, hum = get_char_and_hum(targetPlayer)
    if not char or not hum then
        Notify.show('Player Has No Character', 'error')
        return
    end
    
    local originalDesc = State.player_original_descs[targetPlayer.UserId]
    
    local allowed = Av.build_allowed_from_userid(targetPlayer.UserId)
    if allowed then
        Av.selective_cleanup(char, allowed)
    end
    
    apply_description(hum, originalDesc)
    
    State.player_original_descs[targetPlayer.UserId] = nil
    Notify.show('Reset ' .. targetPlayer.Name .. '!', 'success')
end

function Av.apply_to_all_players(avatarId)
    client_apply_guard(function()
        local id = resolve(avatarId)
        if not id then
            Notify.show('Avatar ID Not Found', 'error')
            return
        end
        
        local count = 0
        local players = Players:GetPlayers()
        
        for _, player in ipairs(players) do
            if player ~= LocalPlayer then
                local success = Av.apply_to_player(player, avatarId, true)
                if success then
                    count = count + 1
                end
            end
        end
        
        Notify.show('Applied To ' .. count .. ' Players!', 'success')
    end)
end

function Av.reset_all_players()
    client_apply_guard(function()
        local count = 0
        local skipped = 0
        local players = Players:GetPlayers()
        
        for _, player in ipairs(players) do
            if player ~= LocalPlayer then
                if State.player_original_descs[player.UserId] then
                    local char, hum = get_char_and_hum(player)
                    if char and hum then
                        local originalDesc = State.player_original_descs[player.UserId]
                        local allowed = Av.build_allowed_from_userid(player.UserId)
                        if allowed then
                            Av.selective_cleanup(char, allowed)
                        end
                        
                        apply_description(hum, originalDesc)
                        State.player_original_descs[player.UserId] = nil
                        count = count + 1
                    end
                else
                    skipped = skipped + 1
                end
            end
        end
        
        if count > 0 then
            Notify.show('Reset ' .. count .. ' Players!', 'success')
        else
            Notify.show('No Players To Reset', 'warning')
        end
    end)
end

function Av.reset()
    if State.applying then
        return
    end
    if not State.original_desc then
        Notify.show('What We Trying?', 'warning')
        return
    end
    if not State.applied_id then
        Notify.show('Already At Original Avatar', 'info')
        return
    end
    
    State.applying = true
    task.spawn(function()
        local char = LocalPlayer.Character
        if not char or not char:FindFirstChild('HumanoidRootPart') then
            State.applying = false
            return
        end
        
        local hum = char:FindFirstChildOfClass('Humanoid')
        if not hum then
            State.applying = false
            return
        end
        
        local tools = {}
        for _, c in ipairs(char:GetChildren()) do
            if c:IsA('Tool') then
                table.insert(tools, c)
            end
        end
        
        local backpack = LocalPlayer:FindFirstChild('Backpack')
        if backpack then
            for _, t in ipairs(backpack:GetChildren()) do
                if t:IsA('Tool') then
                    table.insert(tools, t)
                end
            end
        end
        
        Av.clean(char)
        
        pcall(function()
            if hum.ApplyDescriptionClientServer then
                hum:ApplyDescriptionClientServer(State.original_desc)
            else
                hum:ApplyDescription(State.original_desc)
            end
        end)
        
        for _, t in ipairs(tools) do
            if t and t.Parent == nil then
                if backpack then
                    t.Parent = backpack
                else
                    t.Parent = char
                end
            end
        end
        
        State.applied_id = nil
        State.applying = false
        State.width_scale = 1
        State.width_enabled = false
        State.height_scale = 1
        State.height_enabled = false
        State.depth_scale = 1
        State.depth_enabled = false
        save_data()
        
        Fav.update_star_icon()
        Notify.show('Original Avatar Restored!', 'success')
    end)
end

local Auto = { running = false, thread = nil, connection = nil }

function Auto.start()
    if Auto.running then
        return
    end
    Auto.running = true
    
    Auto.connection = RunService.Heartbeat:Connect(function()
        if not Auto.running then return end
        
        if E.input.Text ~= '' and not State.applying and State.input_ready then
            local id = resolve(E.input.Text)
            if id and State.applied_id ~= id then
                Av.apply(E.input.Text, nil, false, true)
            end
            State.input_ready = false
        end
    end)
    ScriptJanitor:Add(Auto.connection)
end

function Auto.stop()
    Auto.running = false
    if Auto.connection then
        Auto.connection:Disconnect()
        Auto.connection = nil
    end
end

local function get_preview_pos()
    return calculate_preview_position(State.client_preview_open, false)
end

local function get_client_preview_pos()
    return calculate_preview_position(State.preview_open, true)
end

local function update_fab_state(visible)
    tween(E.fab_indicator, { BackgroundColor3 = visible and C.success or C.error }, 0.15)
end

local function update_preview_icon()
    if E.prev_icon then
        tween(E.prev_icon, { ImageColor3 = State.preview_open and C.accent or C.subtext }, 0.15)
    end
end

local function update_client_preview_icon()
    if E.client_prev_icon then
        tween(E.client_prev_icon, { ImageColor3 = State.client_preview_open and C.accent or C.subtext }, 0.15)
    end
end

local function show_gui()
    if State.visibility_animating then return end
    
    State.visibility_animating = true
    State.visible = true
    update_fab_state(true)
    save_data()
    play_sound(Sounds.ui_toggle)
    
    local vp = workspace.CurrentCamera.ViewportSize
    local ui_w = IS_MOBILE and 525 or 565
    local ui_h = IS_MOBILE and 425 or 440
    local minimized_w = IS_MOBILE and 340 or 360
    local correct_size = State.minimized and UDim2.new(0, minimized_w, 0, 50) or UDim2.new(0, ui_w, 0, ui_h)
    
    local size_w = State.minimized and minimized_w or ui_w
    local size_h = State.minimized and 50 or ui_h
    local max_x = math.max(10, vp.X - size_w - 10)
    local max_y = math.max(10, vp.Y - size_h - 10)
    local x = math.clamp(E.saved_pos.X.Offset, 10, max_x)
    local y = math.clamp(E.saved_pos.Y.Offset, 10, max_y)
    local final_pos = UDim2.new(0, x, 0, y)
    
    E.saved_pos = final_pos
    E.main.Position = UDim2.new(0, final_pos.X.Offset, 0, vp.Y + 50)
    E.main.Visible = true
    
    spring(E.main, { Position = final_pos }, 0.35)
    
    if E.volume_slider_fill and E.volume_slider_handle then
        local volume_percent = math.clamp(State.music_volume, 0, 1)
        tween(E.volume_slider_fill, { Size = UDim2.new(volume_percent, 0, 1, 0) }, 0.4, Enum.EasingStyle.Quint)
        tween(E.volume_slider_handle, { Position = UDim2.new(volume_percent, -8, 0.5, -8) }, 0.4, Enum.EasingStyle.Quint)
        
        if E.volume_value_label then
            E.volume_value_label.Text = string.format('%d%%', math.floor(volume_percent * 100))
        end
    end
    
    if E.dynamic_volume_toggle_track and E.dynamic_volume_toggle_thumb then
        tween(E.dynamic_volume_toggle_track, {
            BackgroundColor3 = State.music_dynamic_volume and C.accent or C.elevated
        }, 0.3)
        tween(E.dynamic_volume_toggle_thumb, {
            Position = State.music_dynamic_volume and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8)
        }, 0.3, Enum.EasingStyle.Quad)
    end
    
    if State.preview_open then
        local prev_pos = get_preview_pos()
        E.preview.Position = UDim2.new(0, prev_pos.X.Offset, 0, vp.Y + 50)
        E.preview.Visible = true
        task.spawn(function()
            spring(E.preview, { Position = prev_pos }, 0.35)
        end)
    end
    
    if State.client_preview_open then
        local prev_pos = get_client_preview_pos()
        E.client_preview.Position = UDim2.new(0, prev_pos.X.Offset, 0, vp.Y + 50)
        E.client_preview.Visible = true
        task.spawn(function()
            spring(E.client_preview, { Position = prev_pos }, 0.35)
        end)
    end
    
    task.delay(0.35, function()
        State.visibility_animating = false
    end)
end

local function hide_gui()
    if State.visibility_animating then return end
    
    State.visibility_animating = true
    State.visible = false
    update_fab_state(false)
    play_sound(Sounds.ui_toggle)
    
    local vp = workspace.CurrentCamera.ViewportSize
    local current_pos = E.main.Position
    
    local s = E.main.AbsoluteSize
    local max_x = math.max(10, vp.X - s.X - 10)
    local max_y = math.max(10, vp.Y - s.Y - 10)
    local x = math.clamp(current_pos.X.Offset, 10, max_x)
    local y = math.clamp(current_pos.Y.Offset, 10, max_y)
    E.saved_pos = UDim2.new(0, x, 0, y)
    save_data()
    
    if State.preview_open then
        tween(E.preview, { Position = UDim2.new(0, E.preview.Position.X.Offset, 0, vp.Y + 50) }, 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    end
    
    if State.client_preview_open then
        tween(E.client_preview, { Position = UDim2.new(0, E.client_preview.Position.X.Offset, 0, vp.Y + 50) }, 0.25, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    end
    
    tween(E.main, { Position = UDim2.new(0, current_pos.X.Offset, 0, vp.Y + 50) }, 0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In)
    
    task.delay(0.35, function()
        State.visibility_animating = false
        if not State.visible then
            E.main.Visible = false
            E.preview.Visible = false
            E.client_preview.Visible = false
        end
    end)
end

local function create_icon_btn(parent, ico, pos, size)
    size = size or 36
    local btn = ComponentFactory.TextButton({
        Size = UDim2.new(0, size, 0, size),
        Position = pos,
        BackgroundColor3 = C.elevated,
        Text = '',
        AutoButtonColor = false,
        Parent = parent
    })
    corner(btn, 10)
    local ico_img = icon(btn, ico, 16, C.subtext)
    ico_img.ZIndex = 2
    
    btn.MouseEnter:Connect(function() tween(btn, { BackgroundColor3 = C.hover }, 0.1) end)
    btn.MouseLeave:Connect(function() tween(btn, { BackgroundColor3 = C.elevated }, 0.1) end)
    
    return btn, ico_img
end

local function create_button(parent, text, is_primary, order, ico)
    local btn = ComponentFactory.TextButton({
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundColor3 = is_primary and C.accent or C.elevated,
        Text = '',
        AutoButtonColor = false,
        LayoutOrder = order or 0,
        Parent = parent
    })
    corner(btn, 10)
    if not is_primary then
        stroke(btn, C.border, 1, 0.5)
    end
    
    local content = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = btn
    })
    
    if ico then
        icon(content, ico, 16, C.text, UDim2.new(0, 14, 0.5, -8))
        new('TextLabel', {
            Size = UDim2.new(1, -44, 1, 0),
            Position = UDim2.new(0, 38, 0, 0),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = content
        })
    else
        new('TextLabel', {
            Size = UDim2.new(1, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            Parent = content
        })
    end
    
    local hover = is_primary and C.accent_glow or C.hover
    local normal = is_primary and C.accent or C.elevated
    
    btn.MouseEnter:Connect(function() tween(btn, { BackgroundColor3 = hover }, 0.1) end)
    btn.MouseLeave:Connect(function() tween(btn, { BackgroundColor3 = normal }, 0.1) end)
    
    btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            spring(btn, { Size = UDim2.new(1, -4, 0, 40) }, 0.15)
        end
    end)
    
    btn.InputEnded:Connect(function(inp)
        if is_click_input(inp) then
            spring(btn, { Size = UDim2.new(1, 0, 0, 44) }, 0.15)
        end
    end)
    
    return btn
end

local function create_toggle(parent, text, initial, callback, order)
    local container = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 50),
        BackgroundColor3 = C.card,
        LayoutOrder = order or 0,
        Parent = parent
    })
    corner(container, 10)
    stroke(container, C.border, 1, 0.5)
    
    new('TextLabel', {
        Size = UDim2.new(1, -70, 1, 0),
        Position = UDim2.new(0, 16, 0, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = C.text,
        Font = Enum.Font.GothamSemibold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = container
    })
    
    local track = ComponentFactory.Frame({
        Size = UDim2.new(0, 48, 0, 26),
        Position = UDim2.new(1, -60, 0.5, -13),
        BackgroundColor3 = initial and C.accent or C.elevated,
        Parent = container
    })
    corner(track, 13)
    
    local knob = ComponentFactory.Frame({
        Size = UDim2.new(0, 20, 0, 20),
        Position = initial and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10),
        BackgroundColor3 = C.text,
        Parent = track
    })
    corner(knob, 10)
    
    local enabled = initial
    
local toggle_data = {track = track, is_enabled = function() return enabled end}
table.insert(E.toggle_tracks, toggle_data)
    
    track.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            enabled = not enabled
            tween(track, { BackgroundColor3 = enabled and C.accent or C.elevated }, 0.15)
            spring(knob, { Position = enabled and UDim2.new(1, -23, 0.5, -10) or UDim2.new(0, 3, 0.5, -10) }, 0.2)
            if callback then
                callback(enabled)
            end
        end
    end)
    
    return container, track, knob
end

function E.switch_tab(tab_id)
    if State.current_tab == tab_id then return end
    
    State.current_tab = tab_id
    play_sound(Sounds.tab_switch, 0.6)
    
    if E.main_content then E.main_content.Visible = false end
    if E.fav_content then E.fav_content.Visible = false end
    if E.client_content then E.client_content.Visible = false end
    if E.customize_content then E.customize_content.Visible = false end
    if E.settings_content then E.settings_content.Visible = false end
    
    if tab_id == 'main' then
        if E.main_content then E.main_content.Visible = true end
        if E.input and E.input.Parent and E.input.Parent.Parent then
            E.input.Parent.Parent.Visible = true
        end
    elseif tab_id == 'favorites' then
        if E.fav_content then E.fav_content.Visible = true end
        if E.input and E.input.Parent and E.input.Parent.Parent then
            E.input.Parent.Parent.Visible = false
        end
        if not State.fav_ui_initialized then
            Fav.update_ui()
            State.fav_ui_initialized = true
        end
    elseif tab_id == 'client' then
        if E.client_content then E.client_content.Visible = true end
        if E.input and E.input.Parent and E.input.Parent.Parent then
            E.input.Parent.Parent.Visible = false
        end
    elseif tab_id == 'customize' then
        if E.customize_content then E.customize_content.Visible = true end
        if E.input and E.input.Parent and E.input.Parent.Parent then
            E.input.Parent.Parent.Visible = false
        end
    elseif tab_id == 'settings' then
        if E.settings_content then E.settings_content.Visible = true end
        if E.input and E.input.Parent and E.input.Parent.Parent then
            E.input.Parent.Parent.Visible = false
        end
    end
    
    local tab_buttons = {
        {btn = E.main_tab_btn, icon = E.main_tab_icon, id = 'main'},
        {btn = E.fav_tab_btn, icon = E.fav_tab_icon, id = 'favorites'},
        {btn = E.client_tab_btn, icon = E.client_tab_icon, id = 'client'},
        {btn = E.customize_tab_btn, icon = E.customize_tab_icon, id = 'customize'},
        {btn = E.settings_tab_btn, icon = E.settings_tab_icon, id = 'settings'}
    }
    
    for _, tab_data in ipairs(tab_buttons) do
        if not tab_data.btn then continue end
        
        local is_active = tab_data.id == tab_id
        local target_bg = is_active and C.accent or C.elevated
        local target_icon = is_active and C.text or C.subtext
        
        if not State.rgb_mode or not is_active then
            tween(tab_data.btn, { BackgroundColor3 = target_bg }, 0.25)
        end
        
        if tab_data.icon then
            tween(tab_data.icon, { ImageColor3 = target_icon }, 0.25)
        end
    end
end

function E.build()
    local saved = load_data()
    
    State.auto = saved.auto or false
    State.minimized = saved.minimized or false
    State.visible = saved.visible ~= false
    State.favorites = saved.favorites or {}
    
    State.favorites_index = {}
    for _, fav in ipairs(State.favorites) do
        if fav and fav.id then
            State.favorites_index[fav.id] = true
        end
    end
    State.width_scale = saved.width_scale or 1
    State.width_enabled = saved.width_enabled or false
    State.height_scale = saved.height_scale or 1
    State.height_enabled = saved.height_enabled or false
    State.depth_scale = saved.depth_scale or 1
    State.depth_enabled = saved.depth_enabled or false
    State.music_index = saved.music_index or 1
    State.music_loop = saved.music_loop or false
    State.sound_effects_enabled = saved.sound_effects_enabled ~= false
    State.apply_counts = saved.apply_counts or {}
    State.rgb_mode = saved.rgb_mode or false
    State.rgb_mode_type = saved.rgb_mode_type or 'cycle'
    State.rgb_speed = saved.rgb_speed or 1
    State.current_theme = saved.current_theme or 'purple'
        if saved.toggle_keybind then
        State.toggle_keybind = Enum.KeyCode[saved.toggle_keybind] or Enum.KeyCode.LeftControl
    end
    State.esp_enabled = saved.esp_enabled or false
    State.esp_teamcheck = saved.esp_teamcheck or false
    State.esp_highlights = saved.esp_highlights ~= false
    State.esp_show_teamname = saved.esp_show_teamname ~= false
    State.applied_id = saved.applied_id or nil
    State.notifications_enabled = saved.notifications_enabled ~= false
    
    apply_theme(State.current_theme)
    
       local ui_width = IS_MOBILE and 525 or 565
       local ui_height = IS_MOBILE and 425 or 440
    local minimized_width = IS_MOBILE and 340 or 360
    local fab_size = IS_MOBILE and 50 or 56
    E.fab_size = fab_size
    
    local screen = new('ScreenGui', {
        Name = 'AvatarUI',
        ResetOnSpawn = false,
        ZIndexBehavior = Enum.ZIndexBehavior.Sibling,
        DisplayOrder = 999999,
        IgnoreGuiInset = true,
        Parent = PlayerGui
    })
    E.screen = screen
    
    local vp = workspace.CurrentCamera.ViewportSize
    local default_x = (vp.X - ui_width) / 2
    local default_y = (vp.Y - ui_height) / 2
    
    local use_saved_pos = (saved.ui_version == UI_VERSION)
    
    local main = ComponentFactory.Frame({
        Size = State.minimized and UDim2.new(0, minimized_width, 0, 50) or UDim2.new(0, ui_width, 0, ui_height),
        Position = UDim2.new(0, (use_saved_pos and saved.x) or default_x, 0, (use_saved_pos and saved.y) or default_y),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        ClipsDescendants = true,
        Parent = screen
    })
    corner(main, State.minimized and 8 or 14)
    E.main_stroke = stroke(main, C.accent, 1.5, 0.6)
    E.main = main
    E.saved_pos = main.Position
    
    local header = ComponentFactory.Frame({
        Size = State.minimized and UDim2.new(1, 0, 1, 0) or UDim2.new(1, 0, 0, 52),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = main
    })
    corner(header, State.minimized and 8 or 14)
    
    local header_extension = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 18),
        Position = UDim2.new(0, 0, 1, -18),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Visible = not State.minimized,
        Parent = header
    })
    E.header = header
    E.header_extension = header_extension
    
    local title_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -138, 1, 0),
        Position = UDim2.new(0, 16, 0, 0),
        BackgroundTransparency = 1,
        Parent = header
    })
    
    local title_text = 'AURA HUB'
    E.title_letters = {}
    
    for i = 1, #title_text do
        local letter = ComponentFactory.TextLabel({
            Size = UDim2.new(0, 15, 1, 0),
            Position = UDim2.new(0, (i - 1) * 15, 0, 0),
            BackgroundTransparency = 1,
            Text = title_text:sub(i, i),
            TextColor3 = C.text,
            Font = Enum.Font.GothamBlack,
            TextSize = 14,
            TextXAlignment = Enum.TextXAlignment.Center,
            Parent = title_container
        })
        table.insert(E.title_letters, letter)
    end
    
    local loading_label = ComponentFactory.TextLabel({
        Size = UDim2.new(0, 100, 1, 0),
        Position = UDim2.new(0, #title_text * 15 + 5, 0, 0),
        BackgroundTransparency = 1,
        Text = '•  Loading...',
        TextColor3 = C.muted,
        Font = Enum.Font.GothamMedium,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = title_container
    })
    E.loading_label = loading_label
    
    E.title = title_container
    
    
    E.star_btn, E.star_icon = create_icon_btn(header, Icons.heart_off, UDim2.new(1, -128, 0.5, -18))
    E.prev_btn, E.prev_icon = create_icon_btn(header, Icons.eye, UDim2.new(1, -86, 0.5, -18))
    E.min_btn, E.min_icon = create_icon_btn(header, State.minimized and Icons.plus or Icons.minus, UDim2.new(1, -44, 0.5, -18))
    
    local content_height = IS_MOBILE and 410 or 400
    local content = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, content_height),
        Position = UDim2.new(0, 14, 0, 58),
        BackgroundTransparency = 1,
        ClipsDescendants = true,
        Visible = not State.minimized,
        Parent = main
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = content
    })
    E.content = content
    
    local tabs_frame = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 38),
        BackgroundTransparency = 1,
        LayoutOrder = 0.5,
        Parent = content
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = tabs_frame
    })

    local function create_tab(ico_id, id, order)
        local is_initial_active = (State.current_tab == id)
        local btn = ComponentFactory.TextButton({
            Size = UDim2.new(0.1985, -6.4, 1, 0),
            BackgroundColor3 = is_initial_active and C.accent or C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = order,
            Parent = tabs_frame
        })
        corner(btn, 8)
        
        local ico_img = icon(btn, ico_id, 18, is_initial_active and C.text or C.subtext)
        
        btn.MouseEnter:Connect(function()
            if State.current_tab ~= id then
                tween(btn, { BackgroundColor3 = C.hover }, 0.1)
            end
        end)
        
        btn.MouseLeave:Connect(function()
            if State.current_tab ~= id then
                tween(btn, { BackgroundColor3 = C.elevated }, 0.1)
            end
        end)
        
        btn.InputBegan:Connect(function(inp)
            if is_click_input(inp) then
                spring(btn, { Size = UDim2.new(0.2, -8.4, 1, -2) }, 0.1)
                E.switch_tab(id)
                task.delay(0.1, function()
                    spring(btn, { Size = UDim2.new(0.2, -6.4, 1, 0) }, 0.15)
                end)
            end
        end)
        
        return btn, ico_img
    end

    E.main_tab_btn, E.main_tab_icon = create_tab(Icons.home, 'main', 1)
    E.fav_tab_btn, E.fav_tab_icon = create_tab(Icons.bookmark, 'favorites', 2)
    E.client_tab_btn, E.client_tab_icon = create_tab(Icons.users, 'client', 3)
    E.customize_tab_btn, E.customize_tab_icon = create_tab(Icons.palette, 'customize', 4)
    E.settings_tab_btn, E.settings_tab_icon = create_tab(Icons.settings, 'settings', 5)
    
    local top_row = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = content
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 12),
        Parent = top_row
    })
    
    local input_frame = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -6, 0, 48),
        BackgroundColor3 = C.card,
        Parent = top_row
    })
    corner(input_frame, 10)
    stroke(input_frame, C.border, 1, 0.5)
    
    icon(input_frame, Icons.search, 16, C.muted, UDim2.new(0, 14, 0.5, -8))
    
    local input = ComponentFactory.TextBox({
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
    Text = saved.applied_id and tostring(saved.applied_id) or saved.input or '',
    PlaceholderText = 'Search Username or ID...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = input_frame
    })
    E.input = input
    
    local stats_top_frame = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -6, 0, 48),
        BackgroundTransparency = 1,
        Parent = top_row
    })
    
    E.stats_icon = icon(stats_top_frame, Icons.stats, 18, C.accent, UDim2.new(0, 0, 0.5, -9))
    
    new('TextLabel', {
        Size = UDim2.new(1, -28, 1, 0),
        Position = UDim2.new(0, 28, 0, 0),
        BackgroundTransparency = 1,
        Text = 'Most Applied Avatars',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 15,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = stats_top_frame
    })
    
local main_content = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, -98),
    Position = UDim2.new(0, 0, 0, 98),
    BackgroundTransparency = 1,
    Visible = true,
    LayoutOrder = 2,
    ZIndex = 1,
    Parent = content
})

local main_horizontal = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Parent = main_content
})

new('UIListLayout', {
    FillDirection = Enum.FillDirection.Horizontal,
    Padding = UDim.new(0, 12),
    Parent = main_horizontal
})

local main_left = ComponentFactory.Frame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    Parent = main_horizontal
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10),
    Parent = main_left
})

local main_right = ComponentFactory.Frame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    Parent = main_horizontal
})

local main_right_scroll = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    Parent = main_right
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10),
    Parent = main_right_scroll
})

local fav_content = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, -50),
    Position = UDim2.new(0, 0, 0, 50),
    BackgroundTransparency = 1,
    Visible = false,
    LayoutOrder = 2,
    ZIndex = 2,
    Parent = content
})

local fav_top = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 42),
    BackgroundTransparency = 1,
    Parent = fav_content
})
    
    local fav_search_frame = ComponentFactory.Frame({
        Size = UDim2.new(1, -48, 0, 42),
        BackgroundColor3 = C.card,
        LayoutOrder = 0,
        Parent = fav_top
    })
    corner(fav_search_frame, 10)
    stroke(fav_search_frame, C.border, 1, 0.5)
    
    icon(fav_search_frame, Icons.search, 14, C.muted, UDim2.new(0, 12, 0.5, -7))
    
    local fav_search_input = ComponentFactory.TextBox({
        Size = UDim2.new(1, -40, 1, 0),
        Position = UDim2.new(0, 34, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Search Favorites...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = fav_search_frame
    })
    E.fav_search_input = fav_search_input
    
    local fav_random_btn = ComponentFactory.TextButton({
        Size = UDim2.new(0, 42, 0, 42),
        Position = UDim2.new(1, -42, 0, 0),
        BackgroundColor3 = C.card,
        Text = '',
        AutoButtonColor = false,
        Parent = fav_top
    })
    corner(fav_random_btn, 10)
    stroke(fav_random_btn, C.border, 1, 0.5)
    local fav_random_icon = icon(fav_random_btn, Icons.dice, 18, C.accent)
    E.fav_random_icon = fav_random_icon
    
    
    fav_random_btn.MouseEnter:Connect(function()
        tween(fav_random_btn, { BackgroundColor3 = C.hover }, 0.1)
    end)
    fav_random_btn.MouseLeave:Connect(function()
        tween(fav_random_btn, { BackgroundColor3 = C.card }, 0.1)
    end)
    
    fav_random_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if #State.favorites == 0 then
                Notify.show('No Favorites Yet!', 'warning')
                return
            end
            
            local available_favs = {}
            for _, fav in ipairs(State.favorites) do
                if fav.id ~= State.applied_id then
                    table.insert(available_favs, fav)
                end
            end
            
            if #available_favs == 0 then
                Notify.show('All Favorites Already Applied!', 'info')
                return
            end
            
            play_sound(Sounds.dice)
            local random_fav = available_favs[math.random(#available_favs)]
            E.input.Text = tostring(random_fav.id)
            E.switch_tab('main')
            Av.apply(tostring(random_fav.id), nil, false, true)
        end
    end)

local fav_scroll = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(1, 0, 1, -52),
    Position = UDim2.new(0, 0, 0, 48),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    LayoutOrder = 1,
    Parent = fav_content
})

    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 12),
        Parent = fav_scroll
    })

    E.fav_list = fav_scroll
    E.main_content = main_content
    E.fav_content = fav_content

local client_content = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, -50),
    Position = UDim2.new(0, 0, 0, 50),
    BackgroundTransparency = 1,
    Visible = false,
    LayoutOrder = 2,
    ZIndex = 3,
    Parent = content
})

local client_horizontal = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Parent = client_content
})

new('UIListLayout', {
    FillDirection = Enum.FillDirection.Horizontal,
    Padding = UDim.new(0, 12),
    Parent = client_horizontal
})

local client_left = ComponentFactory.Frame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    Parent = client_horizontal
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 8),
    Parent = client_left
})

local client_right = ComponentFactory.Frame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    Parent = client_horizontal
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 8),
    Parent = client_right
})

    E.client_content = client_content
    
local customize_content = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, -50),
    Position = UDim2.new(0, 0, 0, 50),
    BackgroundTransparency = 1,
    Visible = false,
    LayoutOrder = 2,
    ZIndex = 4,
    Parent = content
})

local customize_scroll = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 550),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    ScrollingEnabled = true,
    ClipsDescendants = true,
    Parent = customize_content
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 8.5),
    Parent = customize_scroll
})

E.customize_content = customize_content
  
  local esp_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 180),
    BackgroundColor3 = C.card,
    LayoutOrder = 2,
    Parent = client_right
})
corner(esp_frame, 10)
stroke(esp_frame, C.border, 1, 0.5)

local settings_content = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, -50),
    Position = UDim2.new(0, 0, 0, 50),
    BackgroundTransparency = 1,
    Visible = false,
    LayoutOrder = 2,
    ZIndex = 4,
    Parent = content
})

local settings_horizontal = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Parent = settings_content
})

new('UIListLayout', {
    FillDirection = Enum.FillDirection.Horizontal,
    Padding = UDim.new(0, 12),
    Parent = settings_horizontal
})

local settings_left = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    Parent = settings_horizontal
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 12),
    Parent = settings_left
})

new('UIPadding', {
    PaddingBottom = UDim.new(0, 50),
    PaddingTop = UDim.new(0, 5),
    Parent = settings_left
})

local settings_right = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(0.5, -6, 1, 0),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    Parent = settings_horizontal
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 10),
    Parent = settings_right
})

new('UIPadding', {
    PaddingBottom = UDim.new(0, 45),
    PaddingTop = UDim.new(0, 5),
    Parent = settings_right
})

local keybind_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 50),
    BackgroundColor3 = C.card,
    LayoutOrder = 15,
    Parent = settings_right
})
corner(keybind_frame, 10)
stroke(keybind_frame, C.border, 1, 0.5)

E.update_undo_redo_ui = function()
    local has_undo = #State.undo_history > 0
    local has_redo = #State.redo_history > 0
    
    if E.main_undo_btn then
        E.main_undo_btn.BackgroundColor3 = has_undo and C.accent or C.elevated
    end
    if E.main_redo_btn then
        E.main_redo_btn.BackgroundColor3 = has_redo and C.accent or C.elevated
    end
    if E.main_history_count_label then
        E.main_history_count_label.Text = tostring(#State.undo_history) .. ' / ' .. tostring(#State.redo_history)
    end
end

local keybind_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -90, 0, 16),
    Position = UDim2.new(0, 14, 0, 10),
    BackgroundTransparency = 1,
    Text = 'UI Toggle Keybind',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = keybind_frame
})

local keybind_current = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 14),
    Position = UDim2.new(0, 14, 0, 30),
    BackgroundTransparency = 1,
    Text = 'Current: ' .. State.toggle_keybind.Name,
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 11,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = keybind_frame
})

local keybind_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 70, 0, 26),
    Position = UDim2.new(1, -84, 0, 12),
    BackgroundColor3 = C.accent,
    Text = 'Change',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 11,
    Parent = keybind_frame
})
corner(keybind_btn, 6)

local keybind_changing = false
local current_keybind_connection = nil

local esp_title = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 20),
    Position = UDim2.new(0, 14, 0, 10),
    BackgroundTransparency = 1,
    Text = 'ESP Settings',
    TextColor3 = C.text,
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = esp_frame
})

local esp_scroll = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(1, -28, 0, 145),
    Position = UDim2.new(0, 14, 0, 35),
    BackgroundTransparency = 1,
    ScrollBarThickness = 4,
    BorderSizePixel = 0,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    ScrollingEnabled = false,
    Parent = esp_frame
})

new('UIListLayout', {
    SortOrder = Enum.SortOrder.LayoutOrder,
    Padding = UDim.new(0, 8),
    Parent = esp_scroll
})

local function create_esp_toggle(text, state_key, callback, order)
    local toggle_frame = ComponentFactory.Frame({
        Size = UDim2.new(1, -5, 0, 28),
        BackgroundTransparency = 1,
        LayoutOrder = order,
        Parent = esp_scroll
    })
    

keybind_btn.MouseButton1Click:Connect(function()
    if keybind_changing then return end
    keybind_changing = true
    
    if current_keybind_connection then
        current_keybind_connection:Disconnect()
        current_keybind_connection = nil
    end
    
    keybind_btn.Text = 'Press Key...'
    keybind_btn.BackgroundColor3 = C.warning
    
    current_keybind_connection = UserInputService.InputBegan:Connect(function(inp, gameProcessed)
        if inp.UserInputType == Enum.UserInputType.Keyboard then
            if current_keybind_connection then
                current_keybind_connection:Disconnect()
                current_keybind_connection = nil
            end
            
            State.toggle_keybind = inp.KeyCode
            keybind_current.Text = 'Current: ' .. inp.KeyCode.Name
            keybind_btn.Text = 'Change'
            keybind_btn.BackgroundColor3 = C.accent
            keybind_changing = false
            save_data()
            Notify.show('Keybind Changed to ' .. inp.KeyCode.Name, 'success', 2)
        end
    end)
    
    task.delay(10, function()
        if keybind_changing and current_keybind_connection then
            current_keybind_connection:Disconnect()
            current_keybind_connection = nil
            keybind_btn.Text = 'Change'
            keybind_btn.BackgroundColor3 = C.accent
            keybind_changing = false
        end
    end)
end)
    
    E.settings_content = settings_content
    E.settings_scroll = settings_scroll
    
    local label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, -40, 1, 0),
        BackgroundTransparency = 1,
        Text = text,
        TextColor3 = C.subtext,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = toggle_frame
    })
    
    local track = ComponentFactory.Frame({
        Size = UDim2.new(0, 38, 0, 20),
        Position = UDim2.new(1, -38, 0.5, -10),
        BackgroundColor3 = State[state_key] and C.accent or C.elevated,
        Parent = toggle_frame
    })
    corner(track, 10)
    
    local thumb = ComponentFactory.Frame({
        Size = UDim2.new(0, 14, 0, 14),
        Position = State[state_key] and UDim2.new(0, 21, 0.5, -7) or UDim2.new(0, 3, 0.5, -7),
        BackgroundColor3 = C.text,
        Parent = track
    })
    corner(thumb, 7)
    
    local btn = ComponentFactory.TextButton({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = '',
        Parent = toggle_frame
    })
    
    btn.MouseButton1Click:Connect(function()
        State[state_key] = not State[state_key]
        tween(track, { BackgroundColor3 = State[state_key] and C.accent or C.elevated }, 0.2)
        tween(thumb, { Position = State[state_key] and UDim2.new(0, 21, 0.5, -7) or UDim2.new(0, 3, 0.5, -7) }, 0.2)
        
        if callback then
            callback(State[state_key])
        end
        
        save_data()
    end)
    
    return toggle_frame
end

create_esp_toggle('Enable ESP', 'esp_enabled', function(enabled)
    ESPSystem.Toggle(enabled)
end, 1)

create_esp_toggle('Team Check', 'esp_teamcheck', function(enabled)
    ESPSystem.TeamCheck = enabled
    
    if ESPSystem.Enabled then
        ESPSystem.RefreshAll()
    end
    
    if Notify and Notify.show then
        Notify.show('Team Check: ' .. (enabled and 'ON' or 'OFF'), 'info', 2)
    end
end, 2)

create_esp_toggle('Show Highlights', 'esp_highlights', function(enabled)
    State.esp_highlights = enabled
  
    if not enabled and State.esp_show_only_highlights then
        State.esp_show_only_highlights = false
        save_data()
        
        if State.esp_enabled then
            ESPSystem.RefreshHighlights()
        end
        
        local esp_scroll_children = esp_scroll:GetChildren()
        for _, child in ipairs(esp_scroll_children) do
            if child:IsA('Frame') and child.LayoutOrder == 4 then
                local track = child:FindFirstChild('Frame')
                local thumb = track and track:FindFirstChild('Frame')
                if track and thumb then
                    tween(track, { BackgroundColor3 = C.elevated }, 0.2)
                    tween(thumb, { Position = UDim2.new(0, 3, 0.5, -7) }, 0.2)
                end
                break
            end
        end
    end
    
    if State.esp_enabled then
        ESPSystem.RefreshHighlights()
    end
    
    if Notify and Notify.show then
        Notify.show('Highlights: ' .. (enabled and 'ON' or 'OFF'), 'info', 2)
    end
end, 3)

create_esp_toggle('Show Only Highlights', 'esp_show_only_highlights', function(enabled)
    if State.esp_enabled then
        ESPSystem.RefreshAll()
    end
    if Notify and Notify.show then
        Notify.show('Only Highlights: ' .. (enabled and 'ON' or 'OFF'), 'info', 2)
    end
end, 4)

create_esp_toggle('Show Team Names', 'esp_show_teamname', function(enabled)
    if Notify and Notify.show then
        Notify.show('Team Names: ' .. (enabled and 'ON' or 'OFF'), 'info', 2)
    end
end, 5)

local notif_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 70),
    BackgroundColor3 = C.card,
    LayoutOrder = 10,
    Parent = settings_right
})
corner(notif_frame, 10)
stroke(notif_frame, C.border, 1, 0.5)

local notif_title = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 20),
    Position = UDim2.new(0, 14, 0, 10),
    BackgroundTransparency = 1,
    Text = 'Notifications',
    TextColor3 = C.text,
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = notif_frame
})

local notif_toggle_container = ComponentFactory.Frame({
    Size = UDim2.new(1, -28, 0, 28),
    Position = UDim2.new(0, 14, 0, 35),
    BackgroundTransparency = 1,
    Parent = notif_frame
})

local notif_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -50, 1, 0),
    BackgroundTransparency = 1,
    Text = 'Show Notifications',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = notif_toggle_container
})

local notif_track = ComponentFactory.Frame({
    Size = UDim2.new(0, 38, 0, 20),
    Position = UDim2.new(1, -38, 0.5, -10),
    BackgroundColor3 = State.notifications_enabled and C.accent or C.elevated,
    Parent = notif_toggle_container
})
corner(notif_track, 10)

local notif_thumb = ComponentFactory.Frame({
    Size = UDim2.new(0, 14, 0, 14),
    Position = State.notifications_enabled and UDim2.new(0, 21, 0.5, -7) or UDim2.new(0, 3, 0.5, -7),
    BackgroundColor3 = C.text,
    Parent = notif_track
})
corner(notif_thumb, 7)

local notif_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 38, 0, 20),
    Position = UDim2.new(1, -38, 0.5, -10),
    BackgroundTransparency = 1,
    Text = '',
    Parent = notif_toggle_container
})

notif_btn.MouseButton1Click:Connect(function()
    State.notifications_enabled = not State.notifications_enabled
    tween(notif_track, { BackgroundColor3 = State.notifications_enabled and C.accent or C.elevated }, 0.2)
    tween(notif_thumb, { Position = State.notifications_enabled and UDim2.new(0, 21, 0.5, -7) or UDim2.new(0, 3, 0.5, -7) }, 0.2)
    save_data()
    
    if State.notifications_enabled then
        Notify.show('Notifications Enabled', 'success', 2)
    end
end)

    E.settings_content = settings_content
    E.settings_scroll = settings_scroll
    
    local function create_slider(parent, label_text, initial_value, min_val, max_val, callback, order)
    local frame = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 70),
        BackgroundColor3 = C.card,
        LayoutOrder = order or 0,
        Parent = parent
    })
    corner(frame, 10)
    stroke(frame, C.border, 1, 0.5)
    
    new('TextLabel', {
        Size = UDim2.new(0.7, 0, 0, 20),
        Position = UDim2.new(0, 14, 0, 10),
        BackgroundTransparency = 1,
        Text = label_text,
        TextColor3 = C.text,
        Font = Enum.Font.GothamSemibold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = frame
    })
    
    local value_label = ComponentFactory.TextLabel({
        Size = UDim2.new(0, 50, 0, 20),
        Position = UDim2.new(1, -64, 0, 10),
        BackgroundTransparency = 1,
        Text = string.format('%.1fx', initial_value),
        TextColor3 = C.accent,
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = frame
    })
    
    local slider_bg = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 6),
        Position = UDim2.new(0, 14, 0, 42),
        BackgroundColor3 = C.elevated,
        Parent = frame
    })
    corner(slider_bg, 3)
    
    local slider_percent = math.clamp((initial_value - min_val) / (max_val - min_val), 0, 1)
    
    local slider_fill = ComponentFactory.Frame({
        Size = UDim2.new(slider_percent, 0, 1, 0),
        BackgroundColor3 = C.accent,
        Parent = slider_bg
    })
    corner(slider_fill, 3)
    
    local slider_handle = ComponentFactory.Frame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(slider_percent, -8, 0.5, -8),
        BackgroundColor3 = C.text,
        ZIndex = 2,
        Parent = slider_bg
    })
    corner(slider_handle, 8)
    
    local dragging = false
    local active_slider_input = nil
    
    slider_bg.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if dragging then return end
            dragging = true
            active_slider_input = inp
        end
    end)
    
    ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
        if not dragging or active_slider_input ~= inp then return end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local mouse_pos = UserInputService:GetMouseLocation()
        local slider_pos = slider_bg.AbsolutePosition
        local slider_size = slider_bg.AbsoluteSize
        
        local relative_x = mouse_pos.X - slider_pos.X
        local percent = math.clamp(relative_x / slider_size.X, 0, 1)
        
        local value = min_val + (percent * (max_val - min_val))
        
        slider_fill.Size = UDim2.new(percent, 0, 1, 0)
        slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
        value_label.Text = string.format('%.1fx', value)
        
        if callback then
            callback(value)
        end
    end))
    
    ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
        if active_slider_input ~= inp then return end
        if is_click_input(inp) then
            dragging = false
            active_slider_input = nil
        end
    end))
    
    return frame
end
    
    local function create_body_scale_slider(parent, label_text, state_key, enabled_key, order)
        local frame = ComponentFactory.Frame({
            Size = UDim2.new(1, -6, 0, 125),
            BackgroundColor3 = C.card,
            LayoutOrder = order,
            Parent = parent
        })
        corner(frame, 10)
        stroke(frame, C.border, 1, 0.5)

        new('TextLabel', {
            Size = UDim2.new(0.5, 0, 0, 20),
            Position = UDim2.new(0, 14, 0, 10),
            BackgroundTransparency = 1,
            Text = label_text,
            TextColor3 = C.text,
            Font = Enum.Font.GothamSemibold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = frame
        })

        local value_label = ComponentFactory.TextLabel({
            Size = UDim2.new(0, 50, 0, 20),
            Position = UDim2.new(1, -64, 0, 10),
            BackgroundTransparency = 1,
            Text = math.floor((State[state_key] or 1) * 100) .. '%',
            TextColor3 = State[enabled_key] and C.accent or C.muted,
            Font = Enum.Font.GothamBold,
            TextSize = 13,
            TextXAlignment = Enum.TextXAlignment.Right,
            Parent = frame
        })

        local input_box = new('TextBox', {
            Size = UDim2.new(1, -28, 0, 28),
            Position = UDim2.new(0, 14, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            PlaceholderText = 'Enter Value (50-150)',
            TextColor3 = C.text,
            PlaceholderColor3 = C.muted,
            Font = Enum.Font.GothamMedium,
            TextSize = 12,
            TextXAlignment = Enum.TextXAlignment.Center,
            ClearTextOnFocus = false,
            Parent = frame
        })
        corner(input_box, 6)

        local slider_bg = ComponentFactory.Frame({
            Size = UDim2.new(1, -28, 0, 6),
            Position = UDim2.new(0, 14, 0, 72),
            BackgroundColor3 = C.elevated,
            Parent = frame
        })
        corner(slider_bg, 3)

        local slider_percent = math.clamp((State[state_key] - 0.5) / 1, 0, 1)
        
        local slider_fill = ComponentFactory.Frame({
            Size = UDim2.new(slider_percent, 0, 1, 0),
            BackgroundColor3 = State[enabled_key] and C.accent or C.muted,
            Parent = slider_bg
        })
        corner(slider_fill, 3)

        local slider_handle = ComponentFactory.Frame({
            Size = UDim2.new(0, 16, 0, 16),
            Position = UDim2.new(slider_percent, -8, 0.5, -8),
            BackgroundColor3 = C.text,
            ZIndex = 2,
            Parent = slider_bg
        })
        corner(slider_handle, 8)

        local toggle_frame = ComponentFactory.Frame({
            Size = UDim2.new(1, -28, 0, 26),
            Position = UDim2.new(0, 14, 0, 86),
            BackgroundTransparency = 1,
            Parent = frame
        })
        
        new('TextLabel', {
            Size = UDim2.new(0.5, 0, 1, 0),
            BackgroundTransparency = 1,
            Text = 'Enable ' .. label_text,
            TextColor3 = C.subtext,
            Font = Enum.Font.GothamMedium,
            TextSize = 11,
            TextXAlignment = Enum.TextXAlignment.Left,
            Parent = toggle_frame
        })
        
local toggle_track = ComponentFactory.Frame({
    Size = UDim2.new(0, 42, 0, 22),
    Position = UDim2.new(1, -42, 0.5, -11),
    BackgroundColor3 = State[enabled_key] and C.accent or C.elevated,
    Parent = toggle_frame
})
corner(toggle_track, 11)

table.insert(E.settings_sliders, {
    fill = slider_fill,
    value_label = value_label,
    toggle_track = toggle_track,
    enabled_key = enabled_key
})
        
        local toggle_knob = ComponentFactory.Frame({
            Size = UDim2.new(0, 16, 0, 16),
            Position = State[enabled_key] and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8),
            BackgroundColor3 = C.text,
            Parent = toggle_track
        })
        corner(toggle_knob, 8)
        
        local function update_slider_from_value(value)
            if not State[enabled_key] then
                Notify.show('Enable ' .. label_text .. ' first!', 'warning', 2)
                return
            end
            
            local clamped_value = math.clamp(value, 50, 150) / 100
            State[state_key] = clamped_value
            
            local percent = math.clamp((clamped_value - 0.5) / 1, 0, 1)
            slider_fill.Size = UDim2.new(percent, 0, 1, 0)
            slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
            value_label.Text = math.floor(clamped_value * 100) .. '%'
            
            if State.applied_id and State[enabled_key] then
                Av.apply_body_scales()
            end
        end
        
        input_box:GetPropertyChangedSignal('Text'):Connect(function()
            local text = input_box.Text
            local number = tonumber(text)
            
            if number then
                if number > 150 then
                    input_box.Text = '150'
                elseif number < 50 and string.len(text) >= 2 then
                    input_box.Text = '50'
                end
            end
        end)
        
        input_box.FocusLost:Connect(function(enter_pressed)
            local text = input_box.Text
            local number = tonumber(text)
            
            if number then
                if number < 50 then
                    number = 50
                elseif number > 150 then
                    number = 150
                end
                
                update_slider_from_value(number)
                Notify.show(label_text .. ' set to ' .. number .. '%', 'success', 1.5)
            elseif text ~= '' then
                Notify.show('Please enter a valid number', 'error', 2)
            end
            
            input_box.Text = ''
            save_data()
        end)
        
        toggle_track.InputBegan:Connect(function(inp)
            if is_click_input(inp) then
                State[enabled_key] = not State[enabled_key]
                tween(toggle_track, { BackgroundColor3 = State[enabled_key] and C.accent or C.elevated }, 0.15)
                spring(toggle_knob, { Position = State[enabled_key] and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8) }, 0.2)
                tween(slider_fill, { BackgroundColor3 = State[enabled_key] and C.accent or C.muted }, 0.15)
                tween(value_label, { TextColor3 = State[enabled_key] and C.accent or C.muted }, 0.15)
                
                if not State[enabled_key] then
                    State[state_key] = 1
                    local reset_percent = 0.5
                    tween(slider_fill, { Size = UDim2.new(reset_percent, 0, 1, 0) }, 0.2)
                    tween(slider_handle, { Position = UDim2.new(reset_percent, -8, 0.5, -8) }, 0.2)
                    value_label.Text = '100%'
                    
                    if State.applied_id then
                        local char = LocalPlayer.Character
                        if char then
                            local hum = char:FindFirstChildOfClass('Humanoid')
                            if hum then
                                pcall(function()
                                    local desc = hum:GetAppliedDescription()
                                    if desc then
                                        if state_key == 'width_scale' then
                                            desc.WidthScale = 1
                                        elseif state_key == 'height_scale' then
                                            desc.HeightScale = 1
                                        elseif state_key == 'depth_scale' then
                                            desc.DepthScale = 1
                                        elseif state_key == 'head_scale' then
                                            desc.HeadScale = 1
                                        end
                                        
                                        if hum.ApplyDescriptionClientServer then
                                            hum:ApplyDescriptionClientServer(desc)
                                        else
                                            hum:ApplyDescription(desc)
                                        end
                                    end
                                end)
                            end
                        end
                    end
                end
                
                if State.applied_id then
                    if State[enabled_key] then
                        Av.apply_body_scales()
                    end
                    Notify.show(label_text .. (State[enabled_key] and ' Enabled' or ' Disabled → Reset To 100%'), State[enabled_key] and 'success' or 'info', 1.5)
                end
                save_data()
            end
        end)

        local dragging = false
        local active_rgb_input = nil

        slider_bg.InputBegan:Connect(function(inp)
            if is_click_input(inp) then
                if not State[enabled_key] then
                    Notify.show('Enable ' .. label_text .. ' first!', 'warning', 1.5)
                    return
                end
                if dragging then return end
                dragging = true
                active_rgb_input = inp
            end
        end)

        ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
            if not dragging or active_rgb_input ~= inp then
                return
            end
            if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
                return
            end
            
            local mouse_pos = UserInputService:GetMouseLocation()
            local slider_pos = slider_bg.AbsolutePosition
            local slider_size = slider_bg.AbsoluteSize
            
            local relative_x = mouse_pos.X - slider_pos.X
            local percent = math.clamp(relative_x / slider_size.X, 0, 1)
            
            State[state_key] = 0.5 + (percent * 1)
            
            slider_fill.Size = UDim2.new(percent, 0, 1, 0)
            slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
            value_label.Text = math.floor(State[state_key] * 100) .. '%'
            
            if State.applied_id and State[enabled_key] then
                Av.apply_body_scales()
            end
        end))

        ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
            if active_rgb_input ~= inp then return end
            if is_click_input(inp) then
                if dragging then
                    dragging = false
                    active_rgb_input = nil
                    save_data()
                end
            end
        end))
        
        return frame
    end
    
create_body_scale_slider(settings_left, 'Avatar Width', 'width_scale', 'width_enabled', 1)
create_body_scale_slider(settings_left, 'Avatar Height', 'height_scale', 'height_enabled', 2)
create_body_scale_slider(settings_left, 'Avatar Depth', 'depth_scale', 'depth_enabled', 3)
create_body_scale_slider(settings_left, 'Head Size', 'head_scale', 'head_enabled', 4)

create_toggle(customize_scroll, 'Disable Sound Effects', not State.sound_effects_enabled, function(enabled)
    State.sound_effects_enabled = not enabled
    save_data()
    Notify.show('Sound Effects : ' .. (State.sound_effects_enabled and 'Enabled' or 'Disabled'), 'info', 2)
end, 1)

create_toggle(customize_scroll, 'Enable RGB Mode', State.rgb_mode, function(enabled)
    State.rgb_mode = enabled
    save_data()
    Notify.show('RGB Mode : ' .. (State.rgb_mode and 'Enabled' or 'Disabled'), 'info', 2)
    
    
if enabled then
        State.rgb_intro_playing = true
        
        if E.title_letters then
            for i, letter in ipairs(E.title_letters) do
                if letter and letter.Parent then
                    task.delay((i - 1) * 0.08, function()
                        if State.rgb_mode then
                            local hue = ((State.rgb_hue + (i * 40)) % 360) / 360
                            local rainbow_color = Color3.fromHSV(hue, 1, 1)
                            tween(letter, { TextColor3 = rainbow_color }, 0.3)
                        end
                    end)
                end
            end
        end
        
        task.delay(0.1, function()
            if State.rgb_mode then
                local hue = (State.rgb_hue % 360) / 360
                local rainbow_color = Color3.fromHSV(hue, 1, 1)
                tween(E.main_stroke, { Color = rainbow_color }, 0.4)
            end
        end)
        
        task.delay(0.8, function()
            State.rgb_intro_playing = false
        end)
        
    elseif not enabled then
        if E.title_letters then
            for i = #E.title_letters, 1, -1 do
                local letter = E.title_letters[i]
                if letter and letter.Parent then
                    task.delay((#E.title_letters - i) * 0.08, function()
                        if not State.rgb_mode then
                            tween(letter, { TextColor3 = C.text }, 0.3)
                        end
                    end)
                end
            end
        end
        
        task.delay(0.1, function()
            if not State.rgb_mode then
                tween(E.main_stroke, { Color = C.accent }, 0.4)
            end
        end)
        
        tween(E.apply_btn, { BackgroundColor3 = C.accent }, 0.4)
        tween(E.client_apply_btn, { BackgroundColor3 = C.accent }, 0.4)
        tween(E.fav_random_icon, { ImageColor3 = C.accent }, 0.3)
        tween(E.music_play_pause_btn, { BackgroundColor3 = State.music_playing and C.success or C.accent }, 0.3)
        if State.music_loop then
            tween(E.music_loop_btn, { BackgroundColor3 = C.accent }, 0.3)
        end
        tween(E.music_name_label, { TextColor3 = C.accent }, 0.3)
        tween(E.progress_fill, { BackgroundColor3 = C.accent }, 0.3)
        if E.volume_slider_fill then
            tween(E.volume_slider_fill, { BackgroundColor3 = C.accent }, 0.3)
        end
        if E.stats_icon then
            tween(E.stats_icon, { ImageColor3 = C.accent }, 0.3)
        end
        
        if State.current_tab == 'main' then
            tween(E.main_tab_btn, { BackgroundColor3 = C.accent }, 0.4)
            tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.customize_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
        elseif State.current_tab == 'favorites' then
            tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.fav_tab_btn, { BackgroundColor3 = C.accent }, 0.4)
            tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.customize_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
        elseif State.current_tab == 'client' then
            tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.client_tab_btn, { BackgroundColor3 = C.accent }, 0.4)
            tween(E.customize_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
        elseif State.current_tab == 'customize' then
            tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.customize_tab_btn, { BackgroundColor3 = C.accent }, 0.4)
            tween(E.settings_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
        elseif State.current_tab == 'settings' then
            tween(E.main_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.fav_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.client_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.customize_tab_btn, { BackgroundColor3 = C.elevated }, 0.4)
            tween(E.settings_tab_btn, { BackgroundColor3 = C.accent }, 0.4)
        end
    end
end, 2)

local rgb_mode_section = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 85),
    BackgroundColor3 = C.card,
    LayoutOrder = 3,
    Parent = customize_scroll
})
corner(rgb_mode_section, 10)
stroke(rgb_mode_section, C.border, 1, 0.5)

local rgb_mode_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 20),
    Position = UDim2.new(0, 14, 0, 12),
    BackgroundTransparency = 1,
    Text = 'RGB Effect Mode',
    TextColor3 = C.text,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Font = Enum.Font.GothamSemibold,
    Parent = rgb_mode_section
})

local rgb_mode_grid = ComponentFactory.Frame({
    Size = UDim2.new(1, -28, 0, 62),
    Position = UDim2.new(0, 14, 0, 38),
    BackgroundTransparency = 1,
    Parent = rgb_mode_section
})

new('UIGridLayout', {
    CellSize = UDim2.new(0, 70, 0, 25),
    CellPadding = UDim2.new(0, 6, 0, 6),
    FillDirection = Enum.FillDirection.Horizontal,
    Parent = rgb_mode_grid
})

local rgb_modes = {
    {id = 'cycle', name = '       Cycle'},
    {id = 'pulse', name = '        Pulse'},
    {id = 'wave', name = '       Wave'},
    {id = 'breathing', name = '     Breathe'},
    {id = 'music_sync', name = '       Music'},
    {id = 'rainbow_trail', name = '         Trail'}
}

E.rgb_mode_btns = {}

local function update_rgb_mode_buttons()
    for _, btn_data in ipairs(E.rgb_mode_btns) do
        local is_active = btn_data.mode == State.rgb_mode_type
        tween(btn_data.btn, {
            BackgroundColor3 = is_active and C.accent or C.elevated
        }, 0.2)
        tween(btn_data.label, {
            TextColor3 = is_active and C.text or C.subtext
        }, 0.2)
    end
end

for _, mode_data in ipairs(rgb_modes) do
    local mode_btn = ComponentFactory.TextButton({
        BackgroundColor3 = mode_data.id == State.rgb_mode_type and C.accent or C.elevated,
        Text = '',
        AutoButtonColor = false,
        Parent = rgb_mode_grid
    })
    corner(mode_btn, 6)
    
    local mode_label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = mode_data.name,
        TextColor3 = mode_data.id == State.rgb_mode_type and C.text or C.subtext,
        TextSize = 12,
        Font = Enum.Font.GothamMedium,
        Parent = mode_btn
    })
    
    table.insert(E.rgb_mode_btns, {btn = mode_btn, label = mode_label, mode = mode_data.id})
    
    mode_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            State.rgb_mode_type = mode_data.id
            State.rgb_time = 0
            update_rgb_mode_buttons()
            save_data()
            Notify.show('RGB Mode: ' .. mode_data.name, 'info', 1.5)
        end
    end)
end

create_slider(customize_scroll, 'RGB Speed', State.rgb_speed, 0.1, 3, function(value)
    State.rgb_speed = value
    save_data()
end, 2.5)

local function update_theme_colors()
    if not State.rgb_mode then
        tween(E.main_stroke, { Color = C.accent }, 0.3)
        tween(E.progress_fill, { BackgroundColor3 = C.accent }, 0.3)
    end
    
    tween(E.apply_btn, { BackgroundColor3 = C.accent }, 0.3)
    tween(E.client_apply_btn, { BackgroundColor3 = C.accent }, 0.3)
    
    tween(E.fav_random_icon, { ImageColor3 = C.accent }, 0.3)
    
    tween(E.music_play_pause_btn, { 
        BackgroundColor3 = State.music_playing and C.success or C.accent 
    }, 0.3)
    
    if State.music_loop then
        tween(E.music_loop_btn, { BackgroundColor3 = C.accent }, 0.3)
    end
    
    tween(E.music_name_label, { TextColor3 = C.accent }, 0.3)
    
    if E.stats_icon then
        tween(E.stats_icon, { ImageColor3 = C.accent }, 0.3)
    end
    
    if State.current_tab == 'main' then
        tween(E.main_tab_btn, { BackgroundColor3 = C.accent }, 0.3)
    elseif State.current_tab == 'favorites' then
        tween(E.fav_tab_btn, { BackgroundColor3 = C.accent }, 0.3)
    elseif State.current_tab == 'client' then
        tween(E.client_tab_btn, { BackgroundColor3 = C.accent }, 0.3)
    elseif State.current_tab == 'customize' then
        tween(E.customize_tab_btn, { BackgroundColor3 = C.accent }, 0.3)
    elseif State.current_tab == 'settings' then
        tween(E.settings_tab_btn, { BackgroundColor3 = C.accent }, 0.3)
    end
    
    for _, toggle_data in ipairs(E.toggle_tracks) do
        if toggle_data.track and toggle_data.track.Parent then
            local is_enabled = toggle_data.is_enabled()
            if is_enabled then
                tween(toggle_data.track, { BackgroundColor3 = C.accent }, 0.3)
            end
        end
    end
    
    if E.dynamic_volume_toggle_track and State.music_dynamic_volume then
        tween(E.dynamic_volume_toggle_track, { BackgroundColor3 = C.accent }, 0.3)
    end
    
    for _, slider_data in ipairs(E.settings_sliders) do
        if State[slider_data.enabled_key] then
            if slider_data.fill then
                tween(slider_data.fill, { BackgroundColor3 = C.accent }, 0.3)
            end
            if slider_data.value_label then
                tween(slider_data.value_label, { TextColor3 = C.accent }, 0.3)
            end
            if slider_data.toggle_track then
                tween(slider_data.toggle_track, { BackgroundColor3 = C.accent }, 0.3)
            end
        end
    end
    
    if E.volume_slider_fill then
        tween(E.volume_slider_fill, { BackgroundColor3 = C.accent }, 0.3)
    end
    
    if E.apply_btn then
        for _, conn in pairs(getconnections(E.apply_btn.MouseEnter)) do
            conn:Disconnect()
        end
        for _, conn in pairs(getconnections(E.apply_btn.MouseLeave)) do
            conn:Disconnect()
        end
        E.apply_btn.MouseEnter:Connect(function()
            tween(E.apply_btn, { BackgroundColor3 = C.accent_glow }, 0.1)
        end)
        E.apply_btn.MouseLeave:Connect(function()
            tween(E.apply_btn, { BackgroundColor3 = C.accent }, 0.1)
        end)
    end
    
    if E.client_apply_btn then
        for _, conn in pairs(getconnections(E.client_apply_btn.MouseEnter)) do
            conn:Disconnect()
        end
        for _, conn in pairs(getconnections(E.client_apply_btn.MouseLeave)) do
            conn:Disconnect()
        end
        E.client_apply_btn.MouseEnter:Connect(function()
            tween(E.client_apply_btn, { BackgroundColor3 = C.accent_glow }, 0.1)
        end)
        E.client_apply_btn.MouseLeave:Connect(function()
            tween(E.client_apply_btn, { BackgroundColor3 = C.accent }, 0.1)
        end)
    end
end

local theme_selector_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 145),
    BackgroundColor3 = C.card,
    LayoutOrder = 3,
    Parent = customize_scroll
})
corner(theme_selector_frame, 10)
stroke(theme_selector_frame, C.border, 1, 0.5)

new('TextLabel', {
    Size = UDim2.new(1, -20, 0, 20),
    Position = UDim2.new(0, 10, 0, 10),
    BackgroundTransparency = 1,
    Text = 'UI Theme',
    TextColor3 = C.text,
    Font = Enum.Font.GothamBold,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = theme_selector_frame
})

local theme_grid = ComponentFactory.Frame({
    Size = UDim2.new(1, -20, 0, 140),
    Position = UDim2.new(0, 10, 0, 35),
    BackgroundTransparency = 1,
    Parent = theme_selector_frame
})

new('UIGridLayout', {
    CellSize = UDim2.new(0.333, -5, 0, 42),
    CellPadding = UDim2.new(0, 6, 0, 8),
    Parent = theme_grid
})

local theme_data = {
    {name = 'purple', display = 'Purple'},
    {name = 'blue', display = 'Blue'},
    {name = 'red', display = 'Red'},
    {name = 'green', display = 'Green'},
    {name = 'pink', display = 'Pink'},
    {name = 'cyan', display = 'Cyan'}
}

for _, theme_info in ipairs(theme_data) do
    local theme_name = theme_info.name
    local theme_container = ComponentFactory.Frame({
        BackgroundColor3 = C.elevated,
        Parent = theme_grid
    })
    corner(theme_container, 8)
    
    local theme_btn = ComponentFactory.TextButton({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Text = '',
        AutoButtonColor = false,
        Parent = theme_container
    })
    
    local color_preview = ComponentFactory.Frame({
        Size = UDim2.new(0, 20, 0, 20),
        Position = UDim2.new(0, 8, 0.5, -10),
        BackgroundColor3 = Themes[theme_name].accent,
        Parent = theme_container
    })
    corner(color_preview, 4)
    
    new('TextLabel', {
        Size = UDim2.new(1, -36, 1, 0),
        Position = UDim2.new(0, 32, 0, 0),
        BackgroundTransparency = 1,
        Text = theme_info.display,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = theme_container
    })
    
    if State.current_theme == theme_name then
        stroke(theme_container, C.accent, 2, 0)
        new('ImageLabel', {
            Size = UDim2.new(0, 14, 0, 14),
            Position = UDim2.new(1, -20, 0.5, -7),
            BackgroundTransparency = 1,
            Image = Icons.check,
            ImageColor3 = C.accent,
            Parent = theme_container
        })
    end
    
    theme_btn.MouseEnter:Connect(function()
        tween(theme_container, { BackgroundColor3 = C.hover }, 0.1)
    end)
    
    theme_btn.MouseLeave:Connect(function()
        tween(theme_container, { BackgroundColor3 = C.elevated }, 0.1)
    end)
    
theme_btn.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        State.current_theme = theme_name
        apply_theme(theme_name)
        save_data()
        
        for _, container in ipairs(theme_grid:GetChildren()) do
            if container:IsA('Frame') then
                local s = container:FindFirstChildOfClass('UIStroke')
                if s then s:Destroy() end
                
                local check = container:FindFirstChildOfClass('ImageLabel')
                if check then check:Destroy() end
            end
        end
        
        stroke(theme_container, C.accent, 2, 0)
        new('ImageLabel', {
            Size = UDim2.new(0, 14, 0, 14),
            Position = UDim2.new(1, -20, 0.5, -7),
            BackgroundTransparency = 1,
            Image = Icons.check,
            ImageColor3 = C.accent,
            Parent = theme_container
        })
        
        update_theme_colors()
        
        Notify.show('Theme: ' .. theme_info.display, 'info', 2)
    end
end)
end

local player_input_container = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 48),
    BackgroundTransparency = 1,
    LayoutOrder = 1,
    Parent = client_left
})
    
    local player_input_frame = ComponentFactory.Frame({
        Size = UDim2.new(1, -46, 0, 48),
        BackgroundColor3 = C.card,
        Parent = player_input_container
    })
    corner(player_input_frame, 10)
    stroke(player_input_frame, C.border, 1, 0.5)

    icon(player_input_frame, Icons.user, 16, C.muted, UDim2.new(0, 14, 0.5, -8))

    local player_input = ComponentFactory.TextBox({
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Player Username...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = player_input_frame
    })
    E.player_input = player_input

    local autocomplete_label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        TextColor3 = C.muted,
        TextTransparency = 0.6,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ZIndex = 0,
        Parent = player_input_frame
    })

    local client_prev_btn, client_prev_icon = create_icon_btn(player_input_container, Icons.eye, UDim2.new(1, -38, 0, 6))
    E.client_prev_btn = client_prev_btn
    E.client_prev_icon = client_prev_icon

    PlayerAutocomplete.setup(player_input, autocomplete_label)

local client_input_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 48),
    BackgroundColor3 = C.card,
    LayoutOrder = 2,
    Parent = client_left
})
    corner(client_input_frame, 10)
    stroke(client_input_frame, C.border, 1, 0.5)

    icon(client_input_frame, Icons.search, 16, C.muted, UDim2.new(0, 14, 0.5, -8))

    local client_input = ComponentFactory.TextBox({
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 40, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = 'Avatar ID To Apply...',
        PlaceholderColor3 = C.muted,
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 14,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = client_input_frame
    })
    E.client_input = client_input

    client_input:GetPropertyChangedSignal('Text'):Connect(function()
        if State.client_preview_open then
            ClientPrev.load(client_input.Text)
        end
    end)

local client_btn_row = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 44),
    BackgroundTransparency = 1,
    LayoutOrder = 3,
    Parent = client_left
})

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = client_btn_row
    })

    local client_apply_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = client_btn_row
    })
    E.client_apply_btn = create_button(client_apply_wrap, 'APPLY', true, 0, Icons.play)

    local client_reset_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = client_btn_row
    })
    E.client_reset_btn = create_button(client_reset_wrap, 'RESET', false, 0, Icons.rotate)

local client_all_row = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 44),
    BackgroundTransparency = 1,
    LayoutOrder = 4,
    Parent = client_left
})

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 8),
        Parent = client_all_row
    })

    local client_apply_all_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = client_all_row
    })
    E.client_apply_all_btn = create_button(client_apply_all_wrap, 'APPLY ALL', false, 0, Icons.users)

    local client_reset_all_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.5, -4, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = client_all_row
    })
    E.client_reset_all_btn = create_button(client_reset_all_wrap, 'RESET ALL', false, 0, Icons.refresh)

    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 10),
        Parent = main_content
    })

    local btn_row = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 48),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = main_left
    })

    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        Padding = UDim.new(0, 10),
        Parent = btn_row
    })

    local apply_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.55, -5, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = btn_row
    })
    E.apply_btn = create_button(apply_wrap, 'APPLY', true, 0, Icons.play)

    local rand_wrap = ComponentFactory.Frame({
        Size = UDim2.new(0.45, -5, 1, 0),
        BackgroundTransparency = 1,
        LayoutOrder = 2,
        Parent = btn_row
    })
    E.rand_btn = create_button(rand_wrap, 'RANDOM', false, 0, Icons.dice)

    local reset_row = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 44),
        BackgroundTransparency = 1,
        LayoutOrder = 3,
        Parent = main_left
    })

    local reset_wrap = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = reset_row
    })
    E.reset_btn = create_button(reset_wrap, 'RESET TO ORIGINAL', false, 0, Icons.rotate)

    new('Frame', {
        Size = UDim2.new(1, 0, 0, 1),
        BackgroundColor3 = C.border,
        BackgroundTransparency = 0.5,
        LayoutOrder = 4,
        Parent = main_left
    })

local stats_container = ComponentFactory.ScrollingFrame({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    BorderSizePixel = 0,
    ScrollBarThickness = 4,
    ScrollBarImageColor3 = C.accent,
    CanvasSize = UDim2.new(0, 0, 0, 0),
    AutomaticCanvasSize = Enum.AutomaticSize.Y,
    Parent = main_right
})
    
    local stats_layout = new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 4),
        Parent = stats_container
    })
    
    E.stats_list = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 0),
        AutomaticSize = Enum.AutomaticSize.Y,
        BackgroundTransparency = 1,
        LayoutOrder = 1,
        Parent = stats_container
    })
    
    new('UIListLayout', {
        SortOrder = Enum.SortOrder.LayoutOrder,
        Padding = UDim.new(0, 6),
        Parent = E.stats_list
    })
    
    new('UIPadding', {
        PaddingTop = UDim.new(0, 4),
        PaddingBottom = UDim.new(0, 4),
        Parent = E.stats_list
    })
    
    local function update_stats_ui()
        for _, c in ipairs(E.stats_list:GetChildren()) do
            if c:IsA('Frame') then
                c:Destroy()
            end
        end
        
        local sorted_stats = {}
        for id, count in pairs(State.apply_counts) do
            table.insert(sorted_stats, {id = tonumber(id), count = count})
        end
        table.sort(sorted_stats, function(a, b) return a.count > b.count end)
        
        local max_count = sorted_stats[1] and sorted_stats[1].count or 1
        local max_display = 5
        
        if #sorted_stats == 0 then
            local empty_label = ComponentFactory.TextLabel({
                Size = UDim2.new(1, 0, 0, 60),
                BackgroundColor3 = C.card,
                Text = 'No Avatars Applied Yet\nStart Applying To See Stats!',
                TextColor3 = C.muted,
                Font = Enum.Font.Gotham,
                TextSize = 12,
                TextWrapped = true,
                Parent = E.stats_list
            })
            corner(empty_label, 8)
            stroke(empty_label, C.border, 1, 0.5)
        else
            for i = 1, math.min(#sorted_stats, max_display) do
                local stat = sorted_stats[i]
                
                local rank_styles = {
                    {bg = Color3.fromRGB(255, 215, 0), glow = Color3.fromRGB(255, 200, 0), label = 'TOP 1', icon_size = 20},
                    {bg = Color3.fromRGB(192, 192, 192), glow = Color3.fromRGB(170, 170, 170), label = 'TOP 2', icon_size = 18},
                    {bg = Color3.fromRGB(205, 127, 50), glow = Color3.fromRGB(185, 110, 40), label = 'TOP 3', icon_size = 18},
                    {bg = Color3.fromRGB(100, 120, 140), glow = Color3.fromRGB(80, 100, 120), label = '#4', icon_size = 16},
                    {bg = Color3.fromRGB(80, 100, 120), glow = Color3.fromRGB(60, 80, 100), label = '#5', icon_size = 16}
                }
                
                local style = rank_styles[i]
                local is_top_3 = i <= 3
                
                local stat_card = ComponentFactory.Frame({
                    Size = UDim2.new(1, 0, 0, is_top_3 and 48 or 40),
                    BackgroundColor3 = is_top_3 and C.card or C.elevated,
                    BackgroundTransparency = 0,
                    LayoutOrder = i,
                    Parent = E.stats_list
                })
                corner(stat_card, 12)
                
                if is_top_3 then
                    local glow_stroke = Instance.new('UIStroke')
                    glow_stroke.Color = style.bg
                    glow_stroke.Thickness = 1.5
                    glow_stroke.Transparency = 0.3
                    glow_stroke.Parent = stat_card
                else
                    stroke(stat_card, C.border, 0.5, 0.3)
                end
                
                local rank_badge = ComponentFactory.Frame({
                    Size = UDim2.new(0, is_top_3 and 38 or 34, 0, is_top_3 and 38 or 34),
                    Position = UDim2.new(0, 8, 0.5, is_top_3 and -19 or -17),
                    BackgroundColor3 = style.bg,
                    Parent = stat_card
                })
                corner(rank_badge, is_top_3 and 10 or 8)
                
                if is_top_3 then
                    local gradient = Instance.new('UIGradient')
                    gradient.Color = ColorSequence.new({
                        ColorSequenceKeypoint.new(0, style.bg),
                        ColorSequenceKeypoint.new(1, style.glow)
                    })
                    gradient.Rotation = 45
                    gradient.Parent = rank_badge
                    
                    local badge_stroke = Instance.new('UIStroke')
                    badge_stroke.Color = style.bg
                    badge_stroke.Thickness = 1
                    badge_stroke.Transparency = 0.2
                    badge_stroke.Parent = rank_badge
                end
                
                local rank_label = ComponentFactory.TextLabel({
                    Size = UDim2.new(1, 0, 1, 0),
                    BackgroundTransparency = 1,
                    Text = style.label,
                    TextColor3 = Color3.fromRGB(255, 255, 255),
                    Font = Enum.Font.GothamBlack,
                    TextSize = is_top_3 and 10 or 9,
                    TextXAlignment = Enum.TextXAlignment.Center,
                    TextYAlignment = Enum.TextYAlignment.Center,
                    Parent = rank_badge
                })
                
                if is_top_3 then
                    local shadow = Instance.new('UIStroke')
                    shadow.Color = Color3.fromRGB(0, 0, 0)
                    shadow.Thickness = 2
                    shadow.Transparency = 0.7
                    shadow.Parent = rank_label
                end
                
                local id_label = ComponentFactory.TextLabel({
                    Size = UDim2.new(1, -180, 1, 0),
                    Position = UDim2.new(0, is_top_3 and 52 or 48, 0, 0),
                    BackgroundTransparency = 1,
                    Text = 'Loading...',
                    TextColor3 = C.text,
                    Font = Enum.Font.GothamBold,
                    TextSize = is_top_3 and 12 or 11,
                    TextXAlignment = Enum.TextXAlignment.Left,
                    TextTruncate = Enum.TextTruncate.AtEnd,
                    Parent = stat_card
                })
                
                task.spawn(function()
                    local success, username = pcall(function()
                        return Players:GetNameFromUserIdAsync(stat.id)
                    end)
                    
                    if success and username then
                        id_label.Text = '@' .. username
                    else
                        id_label.Text = 'ID: ' .. tostring(stat.id)
                    end
                end)
                
                local count_label = ComponentFactory.TextLabel({
                    Size = UDim2.new(0, 60, 1, 0),
                    Position = UDim2.new(1, -125, 0, 0),
                    BackgroundTransparency = 1,
                    Text = stat.count .. ' Applies',
                    TextColor3 = style.bg,
                    Font = Enum.Font.GothamBold,
                    TextSize = is_top_3 and 10 or 9,
                    TextXAlignment = Enum.TextXAlignment.Right,
                    Parent = stat_card
                })
                
                local quick_apply_btn = ComponentFactory.TextButton({
                    Size = UDim2.new(0, 58, 0, 28),
                    Position = UDim2.new(1, -63, 0.5, -14),
                    BackgroundColor3 = C.accent,
                    Text = 'APPLY',
                    TextColor3 = C.text,
                    Font = Enum.Font.GothamBold,
                    TextSize = 10,
                    AutoButtonColor = false,
                    Parent = stat_card
                })
                corner(quick_apply_btn, 8)
                
                quick_apply_btn.MouseEnter:Connect(function()
                    tween(quick_apply_btn, { BackgroundColor3 = C.accent_glow }, 0.1)
                end)
                
                quick_apply_btn.MouseLeave:Connect(function()
                    tween(quick_apply_btn, { BackgroundColor3 = C.accent }, 0.1)
                end)
                
                quick_apply_btn.InputBegan:Connect(function(inp)
                    if is_click_input(inp) then
                        if State.stats_apply_cooldown then
                            return
                        end
                        State.stats_apply_cooldown = true
                        
                        for _, card in ipairs(E.stats_list:GetChildren()) do
                            if card:IsA('Frame') then
                                local btn = card:FindFirstChild('TextButton')
                                if btn then
                                    tween(btn, { BackgroundColor3 = C.muted }, 0.15)
                                    btn.Active = false
                                end
                            end
                        end
                        
                        local id_str = tostring(stat.id)
                        E.input.Text = id_str
                        State.input_ready = true
                        local was_applied = State.applied_id == stat.id
                        if was_applied then
                            State.applied_id = nil
                        end
                        Av.apply(id_str, nil, false, true)
                        
                        task.delay(0.75, function()
                            State.stats_apply_cooldown = false
                            for _, card in ipairs(E.stats_list:GetChildren()) do
                                if card:IsA('Frame') then
                                    local btn = card:FindFirstChild('TextButton')
                                    if btn then
                                        tween(btn, { BackgroundColor3 = C.accent }, 0.15)
                                        btn.Active = true
                                    end
                                end
                            end
                        end)
                    end
                end)
                
                quick_apply_btn.MouseEnter:Connect(function()
                    if not State.stats_apply_cooldown then
                        tween(quick_apply_btn, { BackgroundColor3 = C.accent_glow }, 0.15)
                    end
                end)
                
                quick_apply_btn.MouseLeave:Connect(function()
                    if not State.stats_apply_cooldown then
                        tween(quick_apply_btn, { BackgroundColor3 = C.accent }, 0.15)
                    end
                end)
            end
        end
    end
    
    E.update_stats_ui = update_stats_ui
    update_stats_ui()

local main_undoredo_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 70),
    BackgroundColor3 = C.card,
    LayoutOrder = 5,
    Parent = main_left
})
corner(main_undoredo_frame, 10)
stroke(main_undoredo_frame, C.border, 1, 0.5)

local main_undoredo_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 16),
    Position = UDim2.new(0, 14, 0, 8),
    BackgroundTransparency = 1,
    Text = 'Avatar History',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = main_undoredo_frame
})

local main_undo_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 85, 0, 32),
    Position = UDim2.new(0, 14, 0, 30),
    BackgroundColor3 = C.elevated,
    Text = '← Undo',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 12,
    Parent = main_undoredo_frame
})
corner(main_undo_btn, 6)
E.main_undo_btn = main_undo_btn

local main_redo_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 85, 0, 32),
    Position = UDim2.new(0, 109, 0, 30),
    BackgroundColor3 = C.elevated,
    Text = 'Redo →',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 12,
    Parent = main_undoredo_frame
})
corner(main_redo_btn, 6)
E.main_redo_btn = main_redo_btn

local main_history_count = ComponentFactory.TextLabel({
    Size = UDim2.new(0, 100, 0, 32),
    Position = UDim2.new(1, -114, 0, 30),
    BackgroundTransparency = 1,
    Text = '0 / 0',
    TextColor3 = C.muted,
    Font = Enum.Font.GothamMedium,
    TextSize = 11,
    TextXAlignment = Enum.TextXAlignment.Right,
    Parent = main_undoredo_frame
})
E.main_history_count_label = main_history_count

main_undo_btn.MouseButton1Click:Connect(function()
    Av.undo()
end)

main_redo_btn.MouseButton1Click:Connect(function()
    Av.redo()
end)

main_undo_btn.MouseEnter:Connect(function()
    if #State.undo_history > 0 then
        tween(main_undo_btn, { BackgroundColor3 = C.accent_glow }, 0.1)
    end
end)

main_undo_btn.MouseLeave:Connect(function()
    if #State.undo_history > 0 then
        tween(main_undo_btn, { BackgroundColor3 = C.accent }, 0.1)
    else
        tween(main_undo_btn, { BackgroundColor3 = C.elevated }, 0.1)
    end
end)

main_redo_btn.MouseEnter:Connect(function()
    if #State.redo_history > 0 then
        tween(main_redo_btn, { BackgroundColor3 = C.accent_glow }, 0.1)
    end
end)

main_redo_btn.MouseLeave:Connect(function()
    if #State.redo_history > 0 then
        tween(main_redo_btn, { BackgroundColor3 = C.accent }, 0.1)
    else
        tween(main_redo_btn, { BackgroundColor3 = C.elevated }, 0.1)
    end
end)

create_toggle(main_left, 'Auto Apply', State.auto, function(enabled)
    State.auto = enabled
    save_data()
    
    if enabled then
        Notify.show('Auto Apply Enabled', 'success', 2)
        Auto.start()
        E.reset_btn.BackgroundTransparency = 0.5
        E.reset_btn.Active = false
        if E.input.Text ~= '' then
            State.input_ready = true
        end
    else
        Notify.show('Auto Apply Disabled', 'info', 2)
        Auto.stop()
        E.reset_btn.BackgroundTransparency = 0
        E.reset_btn.Active = true
    end
end, 6)
    
local music_frame = ComponentFactory.Frame({
    Size = UDim2.new(1, 0, 0, 315),
    BackgroundColor3 = C.card,
    LayoutOrder = 0.5,
    Parent = settings_right
})
corner(music_frame, 10)
stroke(music_frame, C.border, 1, 0.5)

new('TextLabel', {
    Size = UDim2.new(1, -28, 0, 18),
    Position = UDim2.new(0, 14, 0, 8),
    BackgroundTransparency = 1,
    Text = 'Music Player',
    TextColor3 = C.text,
    Font = Enum.Font.GothamSemibold,
    TextSize = 13,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = music_frame
})

local music_name_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -28, 0, 16),
    Position = UDim2.new(0, 14, 0, 28),
    BackgroundTransparency = 1,
    Text = Music[State.music_index].name,
    TextColor3 = C.accent,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Left,
    TextTruncate = Enum.TextTruncate.AtEnd,
    Parent = music_frame
})
E.music_name_label = music_name_label

local progress_container = ComponentFactory.Frame({
    Size = UDim2.new(1, -28, 0, 32),
    Position = UDim2.new(0, 14, 0, 48),
    BackgroundTransparency = 1,
    Parent = music_frame
})

local time_current = ComponentFactory.TextLabel({
    Size = UDim2.new(0, 40, 0, 14),
    Position = UDim2.new(0, 0, 0, 0),
    BackgroundTransparency = 1,
    Text = '0:00',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 10,
    TextXAlignment = Enum.TextXAlignment.Left,
    Parent = progress_container
})
E.time_current = time_current

local time_total = ComponentFactory.TextLabel({
    Size = UDim2.new(0, 40, 0, 14),
    Position = UDim2.new(1, -40, 0, 0),
    BackgroundTransparency = 1,
    Text = '0:00',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 10,
    TextXAlignment = Enum.TextXAlignment.Right,
    Parent = progress_container
})
E.time_total = time_total

local function format_time(seconds)
    local mins = math.floor(seconds / 60)
    local secs = math.floor(seconds % 60)
    return string.format('%d:%02d', mins, secs)
end

local progress_bg = ComponentFactory.Frame({
    Size = UDim2.new(1, -90, 0, 4),
    Position = UDim2.new(0, 45, 0, 18),
    BackgroundColor3 = C.elevated,
    Parent = progress_container
})
corner(progress_bg, 2)

local progress_dragging = false
local active_progress_input = nil

progress_bg.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        if State.music_sound then
            if progress_dragging then return end
            progress_dragging = true
            active_progress_input = inp
            
            local mouse_pos = UserInputService:GetMouseLocation()
            local bar_pos = progress_bg.AbsolutePosition
            local bar_size = progress_bg.AbsoluteSize
            
            local relative_x = mouse_pos.X - bar_pos.X
            local percent = math.clamp(relative_x / bar_size.X, 0, 1)
            
            local new_time = percent * State.music_sound.TimeLength
            State.music_sound.TimePosition = new_time
            
            E.progress_fill.Size = UDim2.new(percent, 0, 1, 0)
            E.progress_handle.Position = UDim2.new(percent, -5, 0.5, -5)
            E.time_current.Text = format_time(new_time)
        end
    end
end)

ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
    if not progress_dragging or active_progress_input ~= inp then
        return
    end
    if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
        return
    end
    
    if State.music_sound then
        local mouse_pos = UserInputService:GetMouseLocation()
        local bar_pos = progress_bg.AbsolutePosition
        local bar_size = progress_bg.AbsoluteSize
        
        local relative_x = mouse_pos.X - bar_pos.X
        local percent = math.clamp(relative_x / bar_size.X, 0, 1)
        
        local new_time = percent * State.music_sound.TimeLength
        State.music_sound.TimePosition = new_time
        
        E.progress_fill.Size = UDim2.new(percent, 0, 1, 0)
        E.progress_handle.Position = UDim2.new(percent, -5, 0.5, -5)
        E.time_current.Text = format_time(new_time)
    end
end))

ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
    if active_progress_input ~= inp then return end
    if is_click_input(inp) then
        progress_dragging = false
        active_progress_input = nil
    end
end))

local progress_fill = ComponentFactory.Frame({
    Size = UDim2.new(0, 0, 1, 0),
    BackgroundColor3 = C.accent,
    Parent = progress_bg
})
corner(progress_fill, 2)
E.progress_fill = progress_fill

local progress_handle = ComponentFactory.Frame({
    Size = UDim2.new(0, 10, 0, 10),
    Position = UDim2.new(0, -5, 0.5, -5),
    BackgroundColor3 = C.text,
    ZIndex = 2,
    Parent = progress_bg
})
corner(progress_handle, 5)
E.progress_handle = progress_handle

local music_controls = ComponentFactory.Frame({
    Size = UDim2.new(1, -28, 0, 28),
    Position = UDim2.new(0, 14, 0, 84),
    BackgroundTransparency = 1,
    Parent = music_frame
})

new('UIListLayout', {
    FillDirection = Enum.FillDirection.Horizontal,
    Padding = UDim.new(0, 25),
    Parent = music_controls
})

local prev_music_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(prev_music_btn, 6)
icon(prev_music_btn, Icons.chevron_left, 16, C.text)

local play_pause_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.accent,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(play_pause_btn, 6)
local play_icon = icon(play_pause_btn, Icons.play, 14, C.text)
E.music_play_icon = play_icon
E.music_play_pause_btn = play_pause_btn

local next_music_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(next_music_btn, 6)
icon(next_music_btn, Icons.chevron_right, 16, C.text)

local loop_btn = ComponentFactory.TextButton({
    Size = UDim2.new(0, 28, 0, 28),
    BackgroundColor3 = State.music_loop and C.accent or C.elevated,
    Text = '',
    AutoButtonColor = false,
    Parent = music_controls
})
corner(loop_btn, 6)
local loop_icon = icon(loop_btn, Icons.refresh, 14, State.music_loop and C.text or C.muted)
E.music_loop_btn = loop_btn
E.music_loop_icon = loop_icon
E.music_loop_btn_ref = loop_btn

local music_ended_conn = nil
local music_update_conn = nil
local stop_music, pause_music, resume_music, play_music, next_track, prev_track, update_progress
local current_dynamic_volume = 1
local target_dynamic_volume = 1

update_progress = function()
    if not State.music_sound or not State.music_sound.IsPlaying then
        return
    end
    local current = State.music_sound.TimePosition
    local total = State.music_sound.TimeLength
    if total > 0 then
        local progress = current / total
        E.progress_fill.Size = UDim2.new(progress, 0, 1, 0)
        E.progress_handle.Position = UDim2.new(progress, -5, 0.5, -5)
        E.time_current.Text = format_time(current)
        E.time_total.Text = format_time(total)
    end
end

stop_music = function()
    if State.music_sound then
        State.music_sound:Stop()
        State.music_sound:Destroy()
        State.music_sound = nil
    end
    
    if music_ended_conn then
        music_ended_conn:Disconnect()
        music_ended_conn = nil
    end
    
    if music_update_conn then
        music_update_conn:Disconnect()
        music_update_conn = nil
    end
    
    State.music_playing = false
    play_icon.Image = Icons.play
    tween(play_pause_btn, { BackgroundColor3 = C.accent }, 0.2)
    E.progress_fill.Size = UDim2.new(0, 0, 1, 0)
    E.progress_handle.Position = UDim2.new(0, -5, 0.5, -5)
    E.time_current.Text = '0:00'
    E.time_total.Text = '0:00'
end

pause_music = function()
    if State.music_sound and State.music_sound.IsPlaying then
        State.music_sound:Pause()
    end
    State.music_playing = false
    play_icon.Image = Icons.play
    tween(play_pause_btn, { BackgroundColor3 = C.accent }, 0.2)
    update_progress()
end

resume_music = function()
    if State.music_sound and not State.music_sound.IsPlaying then
        State.music_sound:Resume()
        State.music_playing = true
        play_icon.Image = Icons.x
        tween(play_pause_btn, { BackgroundColor3 = C.success }, 0.2)
    end
end

local switch_music_track = function(direction)
    if direction > 0 then
        State.music_index = State.music_index + 1
        if State.music_index > #Music then
            State.music_index = 1
        end
    else
        State.music_index = State.music_index - 1
        if State.music_index < 1 then
            State.music_index = #Music
        end
    end
    
    local was_playing = State.music_playing
    stop_music()
    music_name_label.Text = Music[State.music_index].name
    if was_playing then
        play_music()
    end
    save_data()
end

next_track = function()
    switch_music_track(1)
end

prev_track = function()
    switch_music_track(-1)
end

play_music = function()
    if State.music_sound and not State.music_sound.IsPlaying then
        resume_music()
        return
    end
   
    stop_music()
    State.music_sound = Instance.new('Sound')
    State.music_sound.SoundId = Music[State.music_index].id
    State.music_sound.Volume = State.music_volume
    State.music_sound.Looped = State.music_loop
    State.music_sound.Parent = workspace
    
    if not State.music_loop then
music_ended_conn = State.music_sound.Ended:Connect(function()
    if State.music_playing and State.music_loaded then
        next_track()
    end
end)
    end
    
    State.music_sound:Play()
    State.music_playing = true
    play_icon.Image = Icons.x
    tween(play_pause_btn, { BackgroundColor3 = C.success }, 0.2)
    music_name_label.Text = Music[State.music_index].name
    
    if E.apply_bass_boost then
        E.apply_bass_boost()
    end
    
    task.spawn(function()
        if State.music_sound then
            E.time_total.Text = format_time(State.music_sound.TimeLength)
        end
    end)
    
    if music_update_conn then
        music_update_conn:Disconnect()
    end
    
    local music_update_interval = 0.1
    local last_music_update = 0
    
    music_update_conn = RunService.Heartbeat:Connect(function()
        local now = tick()
        if now - last_music_update < music_update_interval then return end
        last_music_update = now
        
        if State.music_playing and State.music_sound and State.music_sound.IsPlaying then
            update_progress()
            
            if State.music_dynamic_volume then
                local loudness = State.music_sound.PlaybackLoudness / 500
                loudness = math.clamp(loudness, 0, 1)
                
                local base_volume = State.music_volume
                local dynamic_multiplier = 0.5 + (loudness * 0.5)
                
                target_dynamic_volume = base_volume * dynamic_multiplier
                current_dynamic_volume = current_dynamic_volume + (target_dynamic_volume - current_dynamic_volume) * 0.15
                
                State.music_sound.Volume = current_dynamic_volume
                
                if State.visible and E.volume_slider_fill and E.volume_slider_handle and E.volume_value_label then
                    local visual_volume = math.clamp(current_dynamic_volume, 0, 1)
                    
                    E.volume_slider_fill.Size = UDim2.new(visual_volume, 0, 1, 0)
                    E.volume_slider_handle.Position = UDim2.new(visual_volume, -8, 0.5, -8)
                    E.volume_value_label.Text = string.format('%d%%', math.floor(visual_volume * 100))
                end
            else
                State.music_sound.Volume = State.music_volume
                current_dynamic_volume = State.music_volume
                target_dynamic_volume = State.music_volume
                
                if State.visible and E.volume_slider_fill and E.volume_slider_handle and E.volume_value_label then
                    E.volume_slider_fill.Size = UDim2.new(State.music_volume, 0, 1, 0)
                    E.volume_slider_handle.Position = UDim2.new(State.music_volume, -8, 0.5, -8)
                    E.volume_value_label.Text = string.format('%d%%', math.floor(State.music_volume * 100))
                end
            end
        end
    end)
    ScriptJanitor:Add(music_update_conn)
end

play_pause_btn.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        if State.music_playing then
            pause_music()
        else
            play_music()
        end
    end
end)

next_music_btn.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        next_track()
    end
end)

prev_music_btn.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        prev_track()
    end
end)

loop_btn.InputBegan:Connect(function(inp)
    if is_click_input(inp) then
        State.music_loop = not State.music_loop
        tween(loop_btn, { BackgroundColor3 = State.music_loop and C.accent or C.elevated }, 0.2)
        tween(loop_icon, { ImageColor3 = State.music_loop and C.text or C.muted }, 0.2)
        
        if State.music_sound then
            State.music_sound.Looped = State.music_loop
            
            if music_ended_conn then
                music_ended_conn:Disconnect()
                music_ended_conn = nil
            end
            
            if not State.music_loop then
music_ended_conn = State.music_sound.Ended:Connect(function()
    if State.music_playing and State.music_loaded then
        next_track()
    end
end)
            end
        end
        
        Notify.show('Loop : ' .. (State.music_loop and 'ON (Current track)' or 'OFF (Auto-advance)'), 'info', 2)
        save_data()
    end
end)

    
    local sfx_toggle_frame = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 24),
        Position = UDim2.new(0, 14, 1, -27),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    local volume_slider_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 55),
        Position = UDim2.new(0, 14, 0, 120),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    new('TextLabel', {
        Size = UDim2.new(0.7, 0, 0, 18),
        Position = UDim2.new(0, 0, 0, 0),
        BackgroundTransparency = 1,
        Text = 'Volume',
        TextColor3 = C.text,
        Font = Enum.Font.GothamSemibold,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = volume_slider_container
    })
    
    local volume_value_label = ComponentFactory.TextLabel({
        Size = UDim2.new(0, 50, 0, 18),
        Position = UDim2.new(1, -50, 0, 0),
        BackgroundTransparency = 1,
        Text = string.format('%d%%', math.floor(State.music_volume * 100)),
        TextColor3 = C.accent,
        Font = Enum.Font.GothamBold,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Right,
        Parent = volume_slider_container
    })
    E.volume_value_label = volume_value_label
    
    local volume_slider_bg = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 6),
        Position = UDim2.new(0, 0, 0, 28),
        BackgroundColor3 = C.elevated,
        Parent = volume_slider_container
    })
    corner(volume_slider_bg, 3)
    
    local volume_slider_percent = math.clamp(State.music_volume, 0, 1)
    
    local volume_slider_fill = ComponentFactory.Frame({
        Size = UDim2.new(volume_slider_percent, 0, 1, 0),
        BackgroundColor3 = C.accent,
        Parent = volume_slider_bg
    })
    corner(volume_slider_fill, 3)
    E.volume_slider_fill = volume_slider_fill
    
    local volume_slider_handle = ComponentFactory.Frame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = UDim2.new(volume_slider_percent, -8, 0.5, -8),
        BackgroundColor3 = C.text,
        ZIndex = 2,
        Parent = volume_slider_bg
    })
    corner(volume_slider_handle, 8)
    E.volume_slider_handle = volume_slider_handle
    
    local volume_dragging = false
    local active_volume_input = nil
    
    volume_slider_bg.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if volume_dragging then return end
            volume_dragging = true
            active_volume_input = inp
            
            local mouse_pos = UserInputService:GetMouseLocation()
            local slider_pos = volume_slider_bg.AbsolutePosition
            local slider_size = volume_slider_bg.AbsoluteSize
            
            local relative_x = mouse_pos.X - slider_pos.X
            local percent = math.clamp(relative_x / slider_size.X, 0, 1)
            
            State.music_volume = percent
            
            if State.music_sound then
                State.music_sound.Volume = State.music_volume
            end
            
            volume_slider_fill.Size = UDim2.new(percent, 0, 1, 0)
            volume_slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
            volume_value_label.Text = string.format('%d%%', math.floor(percent * 100))
            save_data()
        end
    end)
    
    ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
        if not volume_dragging or active_volume_input ~= inp then return end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local mouse_pos = UserInputService:GetMouseLocation()
        local slider_pos = volume_slider_bg.AbsolutePosition
        local slider_size = volume_slider_bg.AbsoluteSize
        
        local relative_x = mouse_pos.X - slider_pos.X
        local percent = math.clamp(relative_x / slider_size.X, 0, 1)
        
        State.music_volume = percent
        
        if State.music_sound then
            State.music_sound.Volume = State.music_volume
        end
        
        volume_slider_fill.Size = UDim2.new(percent, 0, 1, 0)
        volume_slider_handle.Position = UDim2.new(percent, -8, 0.5, -8)
        volume_value_label.Text = string.format('%d%%', math.floor(percent * 100))
        save_data()
    end))
    
    ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
        if active_volume_input ~= inp then return end
        if is_click_input(inp) then
            volume_dragging = false
            active_volume_input = nil
        end
    end))
    
    local dynamic_volume_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 30),
        Position = UDim2.new(0, 14, 0, 185),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    local dynamic_volume_label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, -50, 1, 0),
        BackgroundTransparency = 1,
        Text = 'Dynamic Volume',
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = dynamic_volume_container
    })
    
    local dynamic_volume_toggle_bg = ComponentFactory.Frame({
        Size = UDim2.new(0, 40, 0, 22),
        Position = UDim2.new(1, -40, 0.5, -11),
        BackgroundColor3 = State.music_dynamic_volume and C.accent or C.elevated,
        Parent = dynamic_volume_container
    })
    corner(dynamic_volume_toggle_bg, 11)
    E.dynamic_volume_toggle_track = dynamic_volume_toggle_bg
    
    local dynamic_volume_toggle_thumb = ComponentFactory.Frame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = State.music_dynamic_volume and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8),
        BackgroundColor3 = C.text,
        Parent = dynamic_volume_toggle_bg
    })
    corner(dynamic_volume_toggle_thumb, 8)
    E.dynamic_volume_toggle_thumb = dynamic_volume_toggle_thumb
    
    local dynamic_volume_btn = ComponentFactory.TextButton({
        Size = UDim2.new(0, 40, 0, 22),
        Position = UDim2.new(1, -40, 0.5, -11),
        BackgroundTransparency = 1,
        Text = '',
        Parent = dynamic_volume_container
    })
    
    dynamic_volume_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.music_dynamic_volume = not State.music_dynamic_volume
            
            tween(dynamic_volume_toggle_bg, {
                BackgroundColor3 = State.music_dynamic_volume and C.accent or C.elevated
            }, 0.2)
            
            tween(dynamic_volume_toggle_thumb, {
                Position = State.music_dynamic_volume and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8)
            }, 0.2, Enum.EasingStyle.Quad)
            
            if not State.music_dynamic_volume and E.volume_slider_fill and E.volume_slider_handle and E.volume_value_label then
                tween(E.volume_slider_fill, { Size = UDim2.new(State.music_volume, 0, 1, 0) }, 0.3)
                tween(E.volume_slider_handle, { Position = UDim2.new(State.music_volume, -8, 0.5, -8) }, 0.3)
                E.volume_value_label.Text = string.format('%d%%', math.floor(State.music_volume * 100))
            end
            
            SoundManager.play_toggle()
            save_data()
            
            Notify.show('Dynamic Volume: ' .. (State.music_dynamic_volume and 'ON' or 'OFF'), 'info', 1.5)
        end
    end)
    
    local bass_boost_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 30),
        Position = UDim2.new(0, 14, 0, 215),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    local bass_boost_label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, -50, 1, 0),
        BackgroundTransparency = 1,
        Text = 'Bass Boost',
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 12,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = bass_boost_container
    })
    
    local bass_boost_toggle_bg = ComponentFactory.Frame({
        Size = UDim2.new(0, 40, 0, 22),
        Position = UDim2.new(1, -40, 0.5, -11),
        BackgroundColor3 = State.bass_boost_enabled and C.accent or C.elevated,
        Parent = bass_boost_container
    })
    corner(bass_boost_toggle_bg, 11)
    E.bass_boost_toggle_track = bass_boost_toggle_bg
    
    local bass_boost_toggle_thumb = ComponentFactory.Frame({
        Size = UDim2.new(0, 16, 0, 16),
        Position = State.bass_boost_enabled and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8),
        BackgroundColor3 = C.text,
        Parent = bass_boost_toggle_bg
    })
    corner(bass_boost_toggle_thumb, 8)
    E.bass_boost_toggle_thumb = bass_boost_toggle_thumb
    
    local bass_boost_btn = ComponentFactory.TextButton({
        Size = UDim2.new(0, 40, 0, 22),
        Position = UDim2.new(1, -40, 0.5, -11),
        BackgroundTransparency = 1,
        Text = '',
        Parent = bass_boost_container
    })
    
    local function apply_bass_boost()
        if State.music_sound then
            local existing_bass = State.music_sound:FindFirstChild('BassBoostEffect')
            
            if State.bass_boost_enabled then
                if not existing_bass then
                    local bass_boost = Instance.new('EqualizerSoundEffect')
                    bass_boost.Name = 'BassBoostEffect'
                    bass_boost.LowGain = 10
                    bass_boost.MidGain = 0
                    bass_boost.HighGain = -5
                    bass_boost.Parent = State.music_sound
                end
            else
                if existing_bass then
                    existing_bass:Destroy()
                end
            end
        end
    end
    
    bass_boost_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.bass_boost_enabled = not State.bass_boost_enabled
            
            tween(bass_boost_toggle_bg, {
                BackgroundColor3 = State.bass_boost_enabled and C.accent or C.elevated
            }, 0.2)
            
            tween(bass_boost_toggle_thumb, {
                Position = State.bass_boost_enabled and UDim2.new(1, -19, 0.5, -8) or UDim2.new(0, 3, 0.5, -8)
            }, 0.2, Enum.EasingStyle.Quad)
            
            apply_bass_boost()
            
            SoundManager.play_toggle()
            save_data()
            
            Notify.show('Bass Boost: ' .. (State.bass_boost_enabled and 'ON' or 'OFF'), 'info', 1.5)
        end
    end)
    
    E.apply_bass_boost = apply_bass_boost
    
    local custom_music_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -28, 0, 50),
        Position = UDim2.new(0, 14, 0, 255),
        BackgroundTransparency = 1,
        Parent = music_frame
    })
    
    local custom_music_label = ComponentFactory.TextLabel({
        Size = UDim2.new(1, 0, 0, 14),
        BackgroundTransparency = 1,
        Text = 'Custom Music (Asset ID)',
        TextColor3 = C.text,
        Font = Enum.Font.GothamMedium,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = custom_music_container
    })
    
    local custom_music_input_bg = ComponentFactory.Frame({
        Size = UDim2.new(1, -55, 0, 30),
        Position = UDim2.new(0, 0, 0, 18),
        BackgroundColor3 = C.elevated,
        Parent = custom_music_container
    })
    corner(custom_music_input_bg, 6)
    
    local custom_music_input = ComponentFactory.TextBox({
        Size = UDim2.new(1, -16, 1, 0),
        Position = UDim2.new(0, 8, 0, 0),
        BackgroundTransparency = 1,
        Text = '',
        PlaceholderText = '123456789',
        TextColor3 = C.text,
        PlaceholderColor3 = C.muted,
        Font = Enum.Font.GothamMedium,
        TextSize = 11,
        TextXAlignment = Enum.TextXAlignment.Left,
        ClearTextOnFocus = false,
        Parent = custom_music_input_bg
    })
    
    local custom_play_btn = ComponentFactory.TextButton({
        Size = UDim2.new(0, 48, 0, 30),
        Position = UDim2.new(1, -48, 0, 18),
        BackgroundColor3 = C.accent,
        Text = 'PLAY',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 11,
        Parent = custom_music_container
    })
    corner(custom_play_btn, 6)
    
    custom_play_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            local input_text = custom_music_input.Text:gsub('%s+', '')
            
            if input_text == '' then
                Notify.show('Enter an Asset ID!', 'warning', 2)
                return
            end
            
            local asset_id = input_text
            if not asset_id:match('^rbxassetid://') then
                if tonumber(asset_id) then
                    asset_id = 'rbxassetid://' .. asset_id
                else
                    Notify.show('Invalid Asset ID!', 'error', 2)
                    return
                end
            end
            
            stop_music()
            State.music_sound = Instance.new('Sound')
            State.music_sound.SoundId = asset_id
            State.music_sound.Volume = State.music_volume
            State.music_sound.Looped = State.music_loop
            State.music_sound.Parent = workspace
            
            if not State.music_loop then
                music_ended_conn = State.music_sound.Ended:Connect(function()
                    if State.music_playing and State.music_loaded then
                        State.music_playing = false
                        play_icon.Image = Icons.play
                        tween(play_pause_btn, { BackgroundColor3 = C.accent }, 0.2)
                    end
                end)
            end
            
            local success = pcall(function()
                State.music_sound:Play()
            end)
            
            if success then
                State.music_playing = true
                play_icon.Image = Icons.x
                tween(play_pause_btn, { BackgroundColor3 = C.success }, 0.2)
                music_name_label.Text = 'Loading...'
                
                if E.apply_bass_boost then
                    E.apply_bass_boost()
                end
                
                Notify.show('Playing Custom Music!', 'success', 2)
                
                task.spawn(function()
                    local asset_id_number = asset_id:match('%d+')
                    if asset_id_number then
                        local success_name, asset_info = pcall(function()
                            return game:GetService('MarketplaceService'):GetProductInfo(tonumber(asset_id_number))
                        end)
                        
                        if success_name and asset_info and asset_info.Name then
                            music_name_label.Text = asset_info.Name
                        else
                            music_name_label.Text = 'Custom Music - ID: ' .. asset_id_number
                        end
                    else
                        music_name_label.Text = 'Custom Music'
                    end
                end)
                
                task.spawn(function()
                    task.wait(0.1)
                    if State.music_sound then
                        E.time_total.Text = format_time(State.music_sound.TimeLength)
                    end
                end)
                
                if music_update_conn then
                    music_update_conn:Disconnect()
                end
                
                local music_update_interval = 0.1
                local last_music_update = 0
                
                music_update_conn = RunService.Heartbeat:Connect(function()
                    local now = tick()
                    if now - last_music_update < music_update_interval then return end
                    last_music_update = now
                    
                    if State.music_playing and State.music_sound and State.music_sound.IsPlaying then
                        update_progress()
                        
                        if State.music_dynamic_volume then
                            local loudness = State.music_sound.PlaybackLoudness / 500
                            loudness = math.clamp(loudness, 0, 1)
                            
                            local base_volume = State.music_volume
                            local dynamic_multiplier = 0.5 + (loudness * 0.5)
                            
                            target_dynamic_volume = base_volume * dynamic_multiplier
                            current_dynamic_volume = current_dynamic_volume + (target_dynamic_volume - current_dynamic_volume) * 0.15
                            
                            State.music_sound.Volume = current_dynamic_volume
                            
                            if State.visible and E.volume_slider_fill and E.volume_slider_handle and E.volume_value_label then
                                local visual_volume = math.clamp(current_dynamic_volume, 0, 1)
                                
                                E.volume_slider_fill.Size = UDim2.new(visual_volume, 0, 1, 0)
                                E.volume_slider_handle.Position = UDim2.new(visual_volume, -8, 0.5, -8)
                                E.volume_value_label.Text = string.format('%d%%', math.floor(visual_volume * 100))
                            end
                        else
                            State.music_sound.Volume = State.music_volume
                            current_dynamic_volume = State.music_volume
                            target_dynamic_volume = State.music_volume
                            
                            if State.visible and E.volume_slider_fill and E.volume_slider_handle and E.volume_value_label then
                                E.volume_slider_fill.Size = UDim2.new(State.music_volume, 0, 1, 0)
                                E.volume_slider_handle.Position = UDim2.new(State.music_volume, -8, 0.5, -8)
                                E.volume_value_label.Text = string.format('%d%%', math.floor(State.music_volume * 100))
                            end
                        end
                    end
                end)
                ScriptJanitor:Add(music_update_conn)
            else
                Notify.show('Failed to load music!', 'error', 2)
                State.music_playing = false
            end
        end
    end)
    
    custom_play_btn.MouseEnter:Connect(function()
        tween(custom_play_btn, { BackgroundColor3 = C.accent_glow }, 0.15)
    end)
    
    custom_play_btn.MouseLeave:Connect(function()
        tween(custom_play_btn, { BackgroundColor3 = C.accent }, 0.15)
    end)
    
    local preview = ComponentFactory.Frame({
        Size = UDim2.new(0, 210, 0, 410),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        Visible = false,
        Parent = screen
    })
    corner(preview, 14)
    stroke(preview, C.accent, 1.5, 0.6)
    E.preview = preview
    
    local pv_header = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 46),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = preview
    })
    corner(pv_header, 14)
    
    new('Frame', {
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(0, 0, 1, -14),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Parent = pv_header
    })
    
    icon(pv_header, Icons.eye, 16, C.subtext, UDim2.new(0, 14, 0.5, -8))
    
    new('TextLabel', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 38, 0, 0),
        BackgroundTransparency = 1,
        Text = 'PREVIEW',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = pv_header
    })
    
    local vp_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 195),
        Position = UDim2.new(0, 10, 0, 54),
        BackgroundColor3 = C.card,
        Parent = preview
    })
    corner(vp_container, 10)
    
    local viewport = new('ViewportFrame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Ambient = Color3.fromRGB(100, 100, 100),
        LightColor = Color3.fromRGB(255, 255, 255),
        LightDirection = Vector3.new(-1, -1, -1),
        Parent = vp_container
    })
    corner(viewport, 10)
    E.viewport = viewport
    
local vp_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Text = 'Enter ID',
    TextColor3 = C.muted,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Center,
    Parent = vp_container
})
    E.vp_label = vp_label
    
    local ctrl_row = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 257),
        BackgroundTransparency = 1,
        Parent = preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = ctrl_row
    })
    
    local function pv_ctrl_btn(ico, ord)
        local b = ComponentFactory.TextButton({
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = ctrl_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.rot_l = pv_ctrl_btn(Icons.chevron_left, 1)
    E.rot_reset = pv_ctrl_btn(Icons.rotate, 2)
    E.rot_r = pv_ctrl_btn(Icons.chevron_right, 3)
    
    local zoom_row = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 303),
        BackgroundTransparency = 1,
        Parent = preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = zoom_row
    })
    
    local function zoom_ctrl_btn(ico, ord)
        local b = ComponentFactory.TextButton({
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = zoom_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.zoom_out_btn = zoom_ctrl_btn(Icons.minus, 1)
    E.zoom_in_btn = zoom_ctrl_btn(Icons.plus, 2)
    
local vp_user = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -20, 0, 22),
    Position = UDim2.new(0, 10, 0, 352),
    BackgroundTransparency = 1,
    Text = '',
    TextColor3 = C.text,
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    TextTruncate = Enum.TextTruncate.AtEnd,
    TextXAlignment = Enum.TextXAlignment.Center,
    Parent = preview
})
E.vp_user = vp_user

local vp_details = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -20, 0, 18),
    Position = UDim2.new(0, 10, 0, 377),
    BackgroundTransparency = 1,
    Text = '',
    TextColor3 = C.subtext,
    Font = Enum.Font.GothamMedium,
    TextSize = 11,
    TextTruncate = Enum.TextTruncate.AtEnd,
    TextXAlignment = Enum.TextXAlignment.Center,
    Parent = preview
})
    E.vp_details = vp_details

    local client_preview = ComponentFactory.Frame({
        Size = UDim2.new(0, 210, 0, 410),
        BackgroundColor3 = C.base,
        BackgroundTransparency = TRANSPARENCY,
        Visible = false,
        Parent = screen
    })
    corner(client_preview, 14)
    stroke(client_preview, C.warning, 1.5, 0.6)
    E.client_preview = client_preview
    
    local cpv_header = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 0, 46),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        Parent = client_preview
    })
    corner(cpv_header, 14)
    
    new('Frame', {
        Size = UDim2.new(1, 0, 0, 14),
        Position = UDim2.new(0, 0, 1, -14),
        BackgroundColor3 = C.panel,
        BackgroundTransparency = TRANSPARENCY,
        BorderSizePixel = 0,
        Parent = cpv_header
    })
    
    icon(cpv_header, Icons.users, 16, C.warning, UDim2.new(0, 14, 0.5, -8))
    
    new('TextLabel', {
        Size = UDim2.new(1, -50, 1, 0),
        Position = UDim2.new(0, 38, 0, 0),
        BackgroundTransparency = 1,
        Text = 'CLIENT',
        TextColor3 = C.text,
        Font = Enum.Font.GothamBold,
        TextSize = 13,
        TextXAlignment = Enum.TextXAlignment.Left,
        Parent = cpv_header
    })
    
    local cvp_container = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 195),
        Position = UDim2.new(0, 10, 0, 54),
        BackgroundColor3 = C.card,
        Parent = client_preview
    })
    corner(cvp_container, 10)
    
    local client_viewport = new('ViewportFrame', {
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Ambient = Color3.fromRGB(100, 100, 100),
        LightColor = Color3.fromRGB(255, 255, 255),
        LightDirection = Vector3.new(-1, -1, -1),
        Parent = cvp_container
    })
    corner(client_viewport, 10)
    E.client_viewport = client_viewport
    
local client_vp_label = ComponentFactory.TextLabel({
    Size = UDim2.new(1, 0, 1, 0),
    BackgroundTransparency = 1,
    Text = 'Enter ID',
    TextColor3 = C.muted,
    Font = Enum.Font.GothamMedium,
    TextSize = 12,
    TextXAlignment = Enum.TextXAlignment.Center,
    Parent = cvp_container
})
    E.client_vp_label = client_vp_label
    
    local c_ctrl_row = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 257),
        BackgroundTransparency = 1,
        Parent = client_preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = c_ctrl_row
    })
    
    local function cpv_ctrl_btn(ico, ord)
        local b = ComponentFactory.TextButton({
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = c_ctrl_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.c_rot_l = cpv_ctrl_btn(Icons.chevron_left, 1)
    E.c_rot_reset = cpv_ctrl_btn(Icons.rotate, 2)
    E.c_rot_r = cpv_ctrl_btn(Icons.chevron_right, 3)
    
    local c_zoom_row = ComponentFactory.Frame({
        Size = UDim2.new(1, -20, 0, 38),
        Position = UDim2.new(0, 10, 0, 303),
        BackgroundTransparency = 1,
        Parent = client_preview
    })
    
    new('UIListLayout', {
        FillDirection = Enum.FillDirection.Horizontal,
        HorizontalAlignment = Enum.HorizontalAlignment.Center,
        Padding = UDim.new(0, 8),
        Parent = c_zoom_row
    })
    
    local function c_zoom_ctrl_btn(ico, ord)
        local b = ComponentFactory.TextButton({
            Size = UDim2.new(0, 55, 0, 36),
            BackgroundColor3 = C.elevated,
            Text = '',
            AutoButtonColor = false,
            LayoutOrder = ord,
            Parent = c_zoom_row
        })
        corner(b, 10)
        icon(b, ico, 16, C.text)
        
        b.MouseEnter:Connect(function() tween(b, { BackgroundColor3 = C.hover }, 0.1) end)
        b.MouseLeave:Connect(function() tween(b, { BackgroundColor3 = C.elevated }, 0.1) end)
        
        return b
    end
    
    E.c_zoom_out_btn = c_zoom_ctrl_btn(Icons.minus, 1)
    E.c_zoom_in_btn = c_zoom_ctrl_btn(Icons.plus, 2)
    
local client_vp_user = ComponentFactory.TextLabel({
    Size = UDim2.new(1, -20, 0, 22),
    Position = UDim2.new(0, 10, 0, 352),
    BackgroundTransparency = 1,
    Text = '',
    TextColor3 = C.text,
    Font = Enum.Font.GothamBold,
    TextSize = 14,
    TextTruncate = Enum.TextTruncate.AtEnd,
    TextXAlignment = Enum.TextXAlignment.Center,
    Parent = client_preview
})
    E.client_vp_user = client_vp_user

local fab = ComponentFactory.TextButton({
        Size = UDim2.new(0, fab_size, 0, fab_size),
        Position = UDim2.new(0, (use_saved_pos and saved.fab_x) or 16, 0, (use_saved_pos and saved.fab_y) or (vp.Y / 2 - fab_size / 2)),
        BackgroundColor3 = C.elevated,
        Text = '',
        AutoButtonColor = false,
        Parent = screen
    })
    corner(fab, math.floor(fab_size / 4))
    stroke(fab, C.border, 1.5, 0.4)
    E.fab = fab

    local fab_indicator = ComponentFactory.Frame({
        Size = UDim2.new(0, 9, 0, 9),
        Position = UDim2.new(1, -14, 0, 8),
        BackgroundColor3 = State.visible and C.success or C.error,
        Parent = fab
    })
    corner(fab_indicator, 5)
    E.fab_indicator = fab_indicator

    local fab_icon_container = ComponentFactory.Frame({
        Size = UDim2.new(1, 0, 1, 0),
        BackgroundTransparency = 1,
        Parent = fab
    })

    icon(fab_icon_container, Icons.eye, IS_MOBILE and 22 or 26, C.text)

    fab.MouseEnter:Connect(function()
        if not IS_MOBILE then
            tween(fab, { BackgroundColor3 = C.hover }, 0.1)
        end
    end)

    fab.MouseLeave:Connect(function()
        if not IS_MOBILE then
            tween(fab, { BackgroundColor3 = C.elevated }, 0.1)
        end
    end)
    
    E.setup_events()
    
    if State.minimized then
        main.Size = UDim2.new(0, ui_width, 0, 52)
        content.Visible = false
        E.min_btn:FindFirstChildOfClass('ImageLabel').Image = Icons.plus
    end

    main.Position = clamp_frame(main)
    E.saved_pos = main.Position

    if not State.visible then
        main.Visible = false
        update_fab_state(false)
    else
        update_fab_state(true)
    end

    if State.auto then
        Auto.start()
        E.reset_btn.BackgroundTransparency = 0.5
        E.reset_btn.Active = false
        if E.input.Text ~= '' then
            State.input_ready = true
        end
    end

    E.switch_tab('main')
    Fav.update_star_icon()
end

function E.setup_events()
    local dragging = false
    local drag_start, start_pos
    local active_drag_input = nil
    
    E.star_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.minimize_cooldown then
                return
            end
            
            if not State.applied_id then
                Notify.show('Apply An Avatar First!', 'warning')
                return
            end
            
            spring(E.star_icon, { Rotation = 360 }, 0.25)
            task.delay(0.25, function() E.star_icon.Rotation = 0 end)
            
            Fav.toggle(State.applied_id)
        end
    end)
    
local function start_drag(inp)
    if is_click_input(inp) then
        if dragging then return end
        dragging = true
        active_drag_input = inp
        drag_start = inp.Position
        start_pos = E.main.Position
    end
end

E.header.InputBegan:Connect(start_drag)
E.main.InputBegan:Connect(start_drag)
    
    ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
        if not dragging or active_drag_input ~= inp then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local delta = inp.Position - drag_start
        E.main.Position = UDim2.new(0, start_pos.X.Offset + delta.X, 0, start_pos.Y.Offset + delta.Y)
        E.saved_pos = E.main.Position
        
        if State.preview_open and E.preview.Visible then
            E.preview.Position = get_preview_pos()
        end
        if State.client_preview_open and E.client_preview.Visible then
            E.client_preview.Position = get_client_preview_pos()
        end
    end))
    
    ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
        if active_drag_input ~= inp then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseButton1 and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        if dragging then
            dragging = false
            active_drag_input = nil
            local clamped_pos = clamp_frame(E.main, true)
            tween(E.main, { Position = clamped_pos }, 0.2, Enum.EasingStyle.Quint)
            E.saved_pos = clamped_pos
            
            if State.preview_open and E.preview.Visible then
                tween(E.preview, { Position = get_preview_pos() }, 0.2, Enum.EasingStyle.Quint)
            end
            if State.client_preview_open and E.client_preview.Visible then
                tween(E.client_preview, { Position = get_client_preview_pos() }, 0.2, Enum.EasingStyle.Quint)
            end
            save_data()
        end
    end))
    
    local fab_dragging = false
    local fab_drag_start, fab_start_pos
    local fab_moved = false
    local fab_press_time = 0
    local active_fab_input = nil

    E.fab.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if fab_dragging then return end
            fab_dragging = true
            active_fab_input = inp
            fab_moved = false
            fab_press_time = tick()
            fab_drag_start = inp.Position
            fab_start_pos = E.fab.Position
            
            tween(E.fab, { Size = UDim2.new(0, E.fab_size - 6, 0, E.fab_size - 6) }, 0.08)
            tween(E.fab, { BackgroundColor3 = C.hover }, 0.08)
        end
    end)

    ScriptJanitor:Add(UserInputService.InputChanged:Connect(function(inp)
        if not fab_dragging or active_fab_input ~= inp then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseMovement and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        local delta = inp.Position - fab_drag_start
        if math.abs(delta.X) > 5 or math.abs(delta.Y) > 5 then
            fab_moved = true
            E.fab.Position = UDim2.new(0, fab_start_pos.X.Offset + delta.X, 0, fab_start_pos.Y.Offset + delta.Y)
            
            if E.fab.AbsoluteSize.X < E.fab_size then
                spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.1)
            end
        end
    end))

    ScriptJanitor:Add(UserInputService.InputEnded:Connect(function(inp)
        if active_fab_input ~= inp then
            return
        end
        if inp.UserInputType ~= Enum.UserInputType.MouseButton1 and inp.UserInputType ~= Enum.UserInputType.Touch then
            return
        end
        
        if fab_dragging then
            fab_dragging = false
            active_fab_input = nil
            
            spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.15)
            tween(E.fab, { BackgroundColor3 = C.elevated }, 0.15)
            
            local vp = workspace.CurrentCamera.ViewportSize
            local new_x = math.clamp(E.fab.Position.X.Offset, 10, vp.X - E.fab_size - 10)
            local new_y = math.clamp(E.fab.Position.Y.Offset, 10, vp.Y - E.fab_size - 10)
            
            spring(E.fab, { Position = UDim2.new(0, new_x, 0, new_y) }, 0.2)
            save_data()
            
            local hold_time = tick() - fab_press_time
            if not fab_moved and hold_time < 0.3 then
                if State.fab_toggle_cooldown then
                    return
                end
                State.fab_toggle_cooldown = true
                
                tween(E.fab, { Size = UDim2.new(0, E.fab_size + 8, 0, E.fab_size + 8) }, 0.08)
                task.delay(0.08, function()
                    spring(E.fab, { Size = UDim2.new(0, E.fab_size, 0, E.fab_size) }, 0.15)
                end)
                
                if State.visible then
                    hide_gui()
                else
                    show_gui()
                end
                
                task.delay(0.35, function() State.fab_toggle_cooldown = false end)
            end
        end
    end))
    
    E.prev_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.minimize_cooldown then
                return
            end
            
            play_sound(Sounds.button_click)
            State.preview_open = not State.preview_open
            update_preview_icon()
            
            if State.preview_open then
                local pos = get_preview_pos()
                local vp = workspace.CurrentCamera.ViewportSize
                
                E.preview.Position = UDim2.new(0, pos.X.Offset, 0, vp.Y + 50)
                E.preview.Visible = true
                
                spring(E.preview, { Position = pos }, 0.3)
                Prev.load(E.input.Text)
            else
                local vp = workspace.CurrentCamera.ViewportSize
                tween(E.preview, { Position = UDim2.new(0, E.preview.Position.X.Offset, 0, vp.Y + 50) }, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.In)
                
                task.delay(0.25, function()
                    if not State.preview_open then
                        E.preview.Visible = false
                        Prev.clear()
                    end
                end)
            end
        end
    end)
    
    E.client_prev_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            State.client_preview_open = not State.client_preview_open
            update_client_preview_icon()
            
            if State.client_preview_open then
                local pos = get_client_preview_pos()
                local vp = workspace.CurrentCamera.ViewportSize
                
                E.client_preview.Position = UDim2.new(0, pos.X.Offset, 0, vp.Y + 50)
                E.client_preview.Visible = true
                
                spring(E.client_preview, { Position = pos }, 0.3)
                ClientPrev.load(E.client_input.Text)
            else
                local vp = workspace.CurrentCamera.ViewportSize
                tween(E.client_preview, { Position = UDim2.new(0, E.client_preview.Position.X.Offset, 0, vp.Y + 50) }, 0.2, Enum.EasingStyle.Back, Enum.EasingDirection.In)
                
                task.delay(0.25, function()
                    if not State.client_preview_open then
                        E.client_preview.Visible = false
                        ClientPrev.clear()
                    end
                end)
            end
        end
    end)
    
    E.min_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.minimize_cooldown then
                return
            end
            
            State.minimize_cooldown = true
            play_sound(Sounds.button_click)
            State.minimized = not State.minimized
            
            local img = E.min_btn:FindFirstChildOfClass('ImageLabel')
            img.Image = State.minimized and Icons.plus or Icons.minus
            
            local ui_w = IS_MOBILE and 525 or 565
            local ui_h = IS_MOBILE and 425 or 440
            local minimized_w = IS_MOBILE and 340 or 360
            local target_size = State.minimized and UDim2.new(0, minimized_w, 0, 50) or UDim2.new(0, ui_w, 0, ui_h)
            local target_header_size = State.minimized and UDim2.new(1, 0, 1, 0) or UDim2.new(1, 0, 0, 52)
            
            E.content.Visible = not State.minimized
            if E.header_extension then
                E.header_extension.Visible = not State.minimized
            end
            
            
            tween(E.header, { Size = target_header_size }, 0.25, Enum.EasingStyle.Quint)
            
            local main_corner = E.main:FindFirstChildOfClass('UICorner')
            local header_corner = E.main:FindFirstChild('Frame') and E.main:FindFirstChild('Frame'):FindFirstChildOfClass('UICorner')
            
            if State.minimized then
                if main_corner then
                    tween(main_corner, { CornerRadius = UDim.new(0, 8) }, 0.25)
                end
                if header_corner then
                    tween(header_corner, { CornerRadius = UDim.new(0, 8) }, 0.25)
                end
            else
                if main_corner then
                    tween(main_corner, { CornerRadius = UDim.new(0, 14) }, 0.25)
                end
                if header_corner then
                    tween(header_corner, { CornerRadius = UDim.new(0, 14) }, 0.25)
                end
            end
            
            tween(E.main, { Size = target_size }, 0.25, Enum.EasingStyle.Quint)
            save_data()
            
            task.delay(0.45, function()
                State.minimize_cooldown = false
            end)
        end
    end)
    
    E.apply_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.applying then
                return
            end
            if E.input.Text == '' then
                Notify.show('Enter Username or ID', 'warning')
                return
            end
            play_sound(Sounds.button_click)
            Av.apply(E.input.Text, nil, false, true)
        end
    end)
    
    E.rand_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.applying or State.random_cooldown then
                return
            end
            State.random_cooldown = true
            play_sound(Sounds.dice)
            
            local available_presets = ContentLoader.get_presets()
            
            if #available_presets == 0 then
                Notify.show('Presets Still Loading...', 'warning', 2)
                State.random_cooldown = false
                return
            end
            
            local pool = {}
            for _, id in ipairs(available_presets) do
                if not table.find(State.randoms, id) then
                    table.insert(pool, id)
                end
            end
            
            if #pool == 0 then
                State.randoms = {}
                pool = available_presets
            end
            
            local pick = pool[math.random(#pool)]
            table.insert(State.randoms, pick)
            
            E.input.Text = tostring(pick)
            save_data()
            State.input_ready = true
            Notify.show('Random : ' .. pick, 'info', 2)
            
            task.delay(0.3, function() State.random_cooldown = false end)
        end
    end)
    
    E.reset_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            if State.auto then
                Notify.show('Disable Auto Apply First', 'warning')
                return
            end
            play_sound(Sounds.reset)
            Av.reset()
        end
    end)
    
    E.client_apply_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            if State.client_applying then
                return
            end
            
            local playerName = E.player_input.Text
            local avatarId = E.client_input.Text
            
            if playerName == '' then
                Notify.show('Enter Player Name', 'warning')
                return
            end
            
            if avatarId == '' then
                Notify.show('Enter Avatar ID', 'warning')
                return
            end
            
            Av.apply_to_player_by_name(playerName, avatarId)
        end
    end)
    
    E.client_reset_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            local playerName = E.player_input.Text
            
            if playerName == '' then
                Notify.show('Enter Player Name', 'warning')
                return
            end
            
            Av.reset_player_avatar(playerName)
        end
    end)
    
    E.client_apply_all_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            if State.client_applying then
                return
            end
            
            local avatarId = E.client_input.Text
            
            if avatarId == '' then
                Notify.show('Enter Avatar ID', 'warning')
                return
            end
            
            Av.apply_to_all_players(avatarId)
        end
    end)
    
    E.client_reset_all_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            play_sound(Sounds.button_click)
            if State.client_applying then
                return
            end
            Av.reset_all_players()
        end
    end)
    
    E.input.FocusLost:Connect(function(enterPressed)
        save_data()
        if E.input.Text ~= '' then
            State.input_ready = true
        end
        if State.preview_open then
            Prev.load(E.input.Text)
        end
    end)
    
    E.input:GetPropertyChangedSignal('Text'):Connect(function()
        State.input_ready = false
        if State.preview_open then
            Prev.load(E.input.Text)
        end
        Fav.update_star_icon()
    end)
    
    E.rot_l.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            Prev.rot = Prev.rot - 45
            Prev.update()
        end
    end)
    
    E.rot_r.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            Prev.rot = Prev.rot + 45
            Prev.update()
        end
    end)
    
    E.rot_reset.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            Prev.rot = 180
            State.zoom_level = 5.5
            Prev.update()
        end
    end)
    
    E.zoom_in_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.zoom_level = math.max(2, State.zoom_level - 0.5)
            Prev.update()
        end
    end)
    
    E.zoom_out_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.zoom_level = math.min(10, State.zoom_level + 0.5)
            Prev.update()
        end
    end)
    
    if E.fav_search_input then
        E.fav_search_input:GetPropertyChangedSignal('Text'):Connect(function()
            State.fav_search_text = E.fav_search_input.Text
            Fav.update_ui()
        end)
    end
    
    E.c_rot_l.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            ClientPrev.rot = ClientPrev.rot - 45
            ClientPrev.update()
        end
    end)
    
    E.c_rot_r.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            ClientPrev.rot = ClientPrev.rot + 45
            ClientPrev.update()
        end
    end)
    
    E.c_rot_reset.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            ClientPrev.rot = 180
            State.client_zoom_level = 5.5
            ClientPrev.update()
        end
    end)
    
    E.c_zoom_in_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.client_zoom_level = math.max(2, State.client_zoom_level - 0.5)
            ClientPrev.update()
        end
    end)
    
    E.c_zoom_out_btn.InputBegan:Connect(function(inp)
        if is_click_input(inp) then
            State.client_zoom_level = math.min(10, State.client_zoom_level + 0.5)
            ClientPrev.update()
        end
    end)
    
    ScriptJanitor:Add(workspace.CurrentCamera:GetPropertyChangedSignal('ViewportSize'):Connect(function()
        if E.main and E.main.Visible then
            E.main.Position = clamp_frame(E.main, State.preview_open)
            E.saved_pos = E.main.Position
            if State.preview_open and E.preview.Visible then
                E.preview.Position = get_preview_pos()
            end
            if State.client_preview_open and E.client_preview.Visible then
                E.client_preview.Position = get_client_preview_pos()
            end
        end
    end))
    
ScriptJanitor:Add(UserInputService.InputBegan:Connect(function(inp, gameProcessed)
    if gameProcessed then return end
    
    if inp.KeyCode == State.toggle_keybind then
        if E.main and E.main.Parent then
            if State.fab_toggle_cooldown then
                return
            end
            State.fab_toggle_cooldown = true
            
            if State.visible then
                hide_gui()
            else
                show_gui()
            end
            task.delay(0.35, function() 
                State.fab_toggle_cooldown = false 
            end)
        end
    end
end))
    
ScriptJanitor:Add(LocalPlayer.CharacterAdded:Connect(function(char)
    local saved_avatar = State.applied_id
    
    local humanoid = char:WaitForChild('Humanoid', 10)
    local rootPart = char:WaitForChild('HumanoidRootPart', 10)
    
    if not humanoid or not rootPart then 
        return 
    end
    
    if not humanoid:IsDescendantOf(workspace) then
        humanoid.AncestryChanged:Wait()
    end
    
    task.wait(0.65)
    State.applied_id = nil
    State.input_ready = true
    
    if saved_avatar then
        local current_time = tick()
        if (current_time - State.last_apply_time) >= State.apply_cooldown then
            Av.apply(saved_avatar, nil, true)
        else
            State.applied_id = saved_avatar
        end
    end
        
        Fav.update_star_icon()
    end))
    
ScriptJanitor:Add(Players.PlayerAdded:Connect(function(player)
    if player ~= LocalPlayer then
        local charAddedConn
        charAddedConn = player.CharacterAdded:Connect(function(char)
            local playerRef = player
            
            task.spawn(function()
                if not playerRef or not playerRef.Parent then 
                    return 
                end
                
                local rootPart = char:WaitForChild("HumanoidRootPart", 10)
                local humanoid = char:WaitForChild("Humanoid", 10)
                
                if not rootPart or not humanoid then return end
                if not playerRef or not playerRef.Parent then return end
                if State.esp_enabled and playerRef and playerRef.Parent then
                ESPSystem.CreateESPForPlayer(playerRef)
             end
            end)
        end)
        
        local removeConn
        removeConn = Players.PlayerRemoving:Connect(function(removedPlayer)
            if removedPlayer == player then
                if charAddedConn then
                    charAddedConn:Disconnect()
                    charAddedConn = nil
                end
                if removeConn then
                    removeConn:Disconnect()
                    removeConn = nil
                end
            end
        end)
        
        if State.esp_enabled and player.Character then
            task.spawn(function()
                local char = player.Character
                if not char then return end
                
                local rootPart = char:WaitForChild("HumanoidRootPart", 10)
                local humanoid = char:WaitForChild("Humanoid", 10)
                
                if not rootPart or not humanoid then return end
                if not player or not player.Parent then return end
                if State.esp_enabled and player and player.Parent then
                  ESPSystem.CreateESPForPlayer(player)
                end
            end)
        end
    end
end))
    
    ScriptJanitor:Add(Players.PlayerRemoving:Connect(function(player)
        ESPSystem.RemoveESP(player)
        if State.player_original_descs then
            State.player_original_descs[player.UserId] = nil
        end
    end))
    
E.rgb_elements = {
        {obj = E.main_stroke, prop = 'Color', delay = 0, is_stroke = true}
    }
    
    for i, letter in ipairs(E.title_letters) do
        table.insert(E.rgb_elements, {obj = letter, prop = 'TextColor3', delay = 0.05 * i, is_letter = true, letter_index = i})
    end
    
    table.insert(E.rgb_elements, {obj = E.progress_fill, prop = 'BackgroundColor3', delay = 0.2})
    
    if E.volume_slider_fill then
        table.insert(E.rgb_elements, {obj = E.volume_slider_fill, prop = 'BackgroundColor3', delay = 0.25})
    end
    
    for i, elem in ipairs(E.rgb_elements) do
        State.rgb_element_delays[i] = elem.delay or (i - 1) * 0.15
    end
    
    local function lerp_color(c1, c2, alpha)
        return Color3.new(
            c1.R + (c2.R - c1.R) * alpha,
            c1.G + (c2.G - c1.G) * alpha,
            c1.B + (c2.B - c1.B) * alpha
        )
    end
    
    local function ease_in_out_sine(t)
        return -(math.cos(math.pi * t) - 1) / 2
    end
    
    local function get_rgb_color(mode, time, base_hue, element_index, element_info)
        local hue = base_hue
        local saturation = State.rgb_saturation
        local brightness = State.rgb_brightness
        local element_delay = State.rgb_element_delays[element_index] or 0
        local is_stroke = element_info and element_info.is_stroke
        
        if mode == 'cycle' then
            local wave_offset = element_delay * 40
            hue = (base_hue + wave_offset) % 360
            
            local brightness_wave = math.sin(time * 1.5 * State.rgb_speed + element_index * 0.3)
            brightness = 0.7 + (brightness_wave * 0.3)
            saturation = 1
            
        elseif mode == 'pulse' then
            local pulse = (math.sin(time * 2 * State.rgb_speed) + 1) / 2
            pulse = ease_in_out_sine(pulse)
            
            brightness = 0.4 + (pulse * 0.6)
            saturation = 0.7 + (pulse * 0.3)
            
            hue = (base_hue + (pulse * 60)) % 360
            
        elseif mode == 'wave' then
            local ripple = math.sin(time * 2 * State.rgb_speed - (element_index * 0.6))
            
            hue = (base_hue + (ripple * 90) + (element_index * 20)) % 360
            
            brightness = 0.6 + (ripple * 0.4)
            saturation = 0.8 + (math.abs(ripple) * 0.2)
            
        elseif mode == 'breathing' then
            local breath = (math.sin(time * 0.8 * State.rgb_speed) + 1) / 2
            breath = ease_in_out_sine(breath)
            
            saturation = 0.4 + (breath * 0.6)
            brightness = 0.5 + (breath * 0.5)
            
            hue = (base_hue + (breath * 30)) % 360
            
        elseif mode == 'music_sync' then
            if State.music_sound and State.music_sound.Playing then
                local loudness = State.music_sound.PlaybackLoudness / 500
                loudness = math.clamp(loudness, 0, 1)
                
                brightness = 0.4 + (loudness * 0.6)
                saturation = 0.6 + (loudness * 0.4)
                
                local speed_multiplier = 1 + (loudness * 2)
                hue = (base_hue * speed_multiplier) % 360
            else
                local pulse = (math.sin(time * 2) + 1) / 2
                brightness = 0.3 + (pulse * 0.7)
            end
            
        elseif mode == 'rainbow_trail' then
            if is_stroke then
                hue = base_hue % 360
                saturation = 1
                brightness = 1
            else
                local trail_offset = element_delay * 180
                hue = (base_hue + trail_offset) % 360
                saturation = 1
                brightness = 1
            end
        end
        
        return Color3.fromHSV(hue / 360, saturation, brightness)
    end
    
    local RunService = service.RunService
    local rgb_connection = nil
    local last_frame_time = tick()
    
    local function start_rgb_loop()
        if rgb_connection then return end
        
        local last_color = {}
        local target_color = {}
        local transition_progress = {}
        
        for i = 1, #E.rgb_elements do
            last_color[i] = Color3.fromRGB(255, 255, 255)
            target_color[i] = Color3.fromRGB(255, 255, 255)
            transition_progress[i] = 1
        end
        
        rgb_connection = RunService.Heartbeat:Connect(function()
            if not State.visible or not State.rgb_mode or not E.main then
                return
            end
            
            if State.rgb_intro_playing then
                return
            end
            
            local current_time = tick()
            local dt = current_time - last_frame_time
            last_frame_time = current_time
            
            dt = math.min(dt, 0.1)
            
            State.rgb_time = State.rgb_time + dt
            
            if State.rgb_mode_type == 'cycle' or State.rgb_mode_type == 'rainbow_trail' then
                State.rgb_hue = (State.rgb_hue + (30 * dt * State.rgb_speed)) % 360
            else
                State.rgb_hue = (State.rgb_hue + (15 * dt * State.rgb_speed)) % 360
            end
            
    for i, elem in ipairs(E.rgb_elements) do
    if not elem.obj or not elem.obj.Parent then 
        continue 
    end
    
    pcall(function()
        local new_target = get_rgb_color(State.rgb_mode_type, State.rgb_time, State.rgb_hue, i, elem)
        
        local color_diff = math.abs(new_target.R - target_color[i].R) +
                          math.abs(new_target.G - target_color[i].G) +
                          math.abs(new_target.B - target_color[i].B)
        
        if color_diff > 0.01 then
            last_color[i] = elem.obj[elem.prop]
            target_color[i] = new_target
            transition_progress[i] = 0
        end
        
        if transition_progress[i] < 1 then
            transition_progress[i] = math.min(1, transition_progress[i] + (dt * 8))
            local alpha = ease_in_out_sine(transition_progress[i])
            elem.obj[elem.prop] = lerp_color(last_color[i], target_color[i], alpha)
        else
            elem.obj[elem.prop] = target_color[i]
        end
    end)
end
            
            local active_btn = nil
            if State.current_tab == 'main' then
                active_btn = E.main_tab_btn
            elseif State.current_tab == 'favorites' then
                active_btn = E.fav_tab_btn
            elseif State.current_tab == 'client' then
                active_btn = E.client_tab_btn
            elseif State.current_tab == 'customize' then
                active_btn = E.customize_tab_btn
            elseif State.current_tab == 'settings' then
                active_btn = E.settings_tab_btn
            end
            
            if active_btn and active_btn.Parent then
                local btn_color = get_rgb_color(State.rgb_mode_type, State.rgb_time, State.rgb_hue, 1, {})
                active_btn.BackgroundColor3 = btn_color
            end
        end)
        
        ScriptJanitor:Add(rgb_connection)
    end
    
    local function stop_rgb_loop()
        if rgb_connection then
            rgb_connection:Disconnect()
            rgb_connection = nil
        end
    end
    
    start_rgb_loop()
end

E.build()

task.spawn(function()
    if E.loading_label and E.loading_label.Parent then
        E.loading_label.Visible = true
        E.loading_label.Text = '•  Loading Music (0%)'
    end
    
    local music_done = false
    ContentLoader.load_music_progressive(
        function()
            music_done = true
        end,
        function(progress)
            if E.loading_label and E.loading_label.Parent and not State.music_loaded then
                E.loading_label.Text = '•  Loading Music (' .. progress .. '%)'
            end
        end
    )
    
    while not music_done do
        task.wait(0.1)
    end
    
    if E.loading_label and E.loading_label.Parent then
        E.loading_label.Text = '•  Loading Presets (0%)'
    end
    
    ContentLoader.load_presets_progressive(
        function()
            if E.loading_label and E.loading_label.Parent then
                E.loading_label.Visible = false
            end
        end,
        function(progress)
            if E.loading_label and E.loading_label.Parent and not State.presets_loaded then
                E.loading_label.Text = '•  Loading Presets (' .. progress .. '%)'
            end
        end
    )
end)

if E.update_undo_redo_ui then
    E.update_undo_redo_ui()
end

if State.applied_id then
    if E.input then
        E.input.Text = tostring(State.applied_id)
    end
end

if E.update_undo_redo_ui then
    E.update_undo_redo_ui()
end

if State.applied_id then
    if E.input then
        E.input.Text = tostring(State.applied_id)
    end
end

if State.auto == true and State.applied_id and LocalPlayer.Character then
    State.input_ready = true
    task.wait(0.65)
    Av.apply(State.applied_id, nil, true)
end

if State.esp_enabled then
    ESPSystem.Toggle(true)
end

if State.esp_teamcheck then
    ESPSystem.TeamCheck = true
end

local function handle_player(player)
    player.CharacterAdded:Connect(function(character)
        local humanoid = character:WaitForChild("Humanoid", 10)
        if not humanoid then return end
        local hrp = character:WaitForChild("HumanoidRootPart", 10)
        if not hrp then return end
        task.wait(0.25)
        if State.esp_enabled then
            ESPSystem.CreateESPForPlayer(player)
        end
    end)
    
    player.CharacterRemoving:Connect(function()
        ESPSystem.RemoveESP(player)
    end)
    
    if player.Character then
        local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
        local hrp = player.Character:FindFirstChild("HumanoidRootPart")
        if humanoid and hrp and State.esp_enabled then
            task.wait(0.25)
            ESPSystem.CreateESPForPlayer(player)
        end
    end
end

for _, player in ipairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        handle_player(player)
    end
end

 ScriptJanitor:Add(Players.PlayerAdded:Connect(function(player)
              handle_player(player)
          end))

ScriptJanitor:Add(Players.PlayerRemoving:Connect(function(player)
    ESPSystem.RemoveESP(player)
    
    if State.player_original_descs[player] then
        State.player_original_descs[player] = nil
    end
    
    if State.apply_counts[player] then
        State.apply_counts[player] = nil
    end
end))

ScriptJanitor:Add(LocalPlayer:GetPropertyChangedSignal("Team"):Connect(function()
    if State.esp_enabled then
        ESPSystem.RefreshAll()
    end
end))

env[SCRIPT_FLAG] = {
    cleanup = function()
        cleanup_all()
        ScriptJanitor:Cleanup()
        if E.screen then
            E.screen:Destroy()
        end
    end
}

warn('[LORD] Loaded Successfully!')